import{c as q,u as Q,a as Y,b as Z,r as d,s as p,j as e,B as f}from"./index-N2kES7nl.js";import{F as R,L as ee}from"./LanguageSwitcher-y5eKq3Xc.js";import{C as se,F as te,a as ae}from"./FaceVerification-C8sBaUoX.js";import{L as re,U as ie,m,A}from"./proxy-DHU0nURF.js";import{L as ne,G as ce,B as le,U as oe}from"./users-BwXCML1E.js";import{S as de,C as F,a as me}from"./shield-Cb7crUDj.js";/**
 * @license lucide-react v0.468.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const $=q("CircleAlert",[["circle",{cx:"12",cy:"12",r:"10",key:"1mglay"}],["line",{x1:"12",x2:"12",y1:"8",y2:"12",key:"1pkeuh"}],["line",{x1:"12",x2:"12.01",y1:"16",y2:"16",key:"4dfq90"}]]);/**
 * @license lucide-react v0.468.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const N=q("CirclePlay",[["circle",{cx:"12",cy:"12",r:"10",key:"1mglay"}],["polygon",{points:"10 8 16 12 10 16 10 8",key:"1cimsy"}]]);function ye(){var D;const{user:l,profile:i,profileLoading:y,logout:P}=Q(),{t:s}=Y(),w=Z(),[v,C]=d.useState([]),[k,I]=d.useState([]),[V,b]=d.useState(!0),[E,S]=d.useState(!1),[_,U]=d.useState(!0),[B,j]=d.useState(!1),[u,T]=d.useState(!1);d.useEffect(()=>{(i!=null&&i.face_embedding||i!=null&&i.face_enrolled_at)&&T(!0)},[i]),d.useEffect(()=>{if(!y){S(!1);return}const t=setTimeout(()=>{console.warn("Dashboard: Profile loading timeout reached, proceeding with user metadata"),S(!0)},2e3);return()=>clearTimeout(t)},[y]),d.useEffect(()=>{if(!l)return;const t=async()=>{try{let o=[];try{const{data:r,error:n}=await p.rpc("get_my_enrollments");if(!n&&(r!=null&&r.success))o=r.enrollments||[];else throw new Error((n==null?void 0:n.message)||(r==null?void 0:r.error)||"Failed to load enrollments via RPC function")}catch(r){console.warn("[Dashboard] RPC get_my_enrollments failed, trying direct query:",r.message);const{data:n,error:c}=await p.from("enrollments").select(`
              id,
              status,
              enrolled_at,
              class:classes(
                id,
                name,
                code,
                description,
                semester,
                academic_year,
                instructor:profiles!classes_instructor_id_fkey(full_name, email)
              )
            `).eq("student_id",l.id).order("enrolled_at",{ascending:!1});if(c)throw console.error("[Dashboard] Error loading enrollments:",c),c;o=n||[]}I(o)}catch(o){console.error("Load classes error:",o)}};t();const a=p.channel(`enrollments-${l.id}`).on("postgres_changes",{event:"*",schema:"public",table:"enrollments",filter:`student_id=eq.${l.id}`},o=>{console.log("Enrollment change:",o),t()}).subscribe();return()=>{a.unsubscribe()}},[l]),d.useEffect(()=>{(async()=>{var r,n;if(!l){b(!1);return}if(y&&!i&&!E)return;const a=(i==null?void 0:i.role)||((r=l==null?void 0:l.user_metadata)==null?void 0:r.role)||"student";if(a==="instructor"||a==="admin"){b(!1);return}try{const{data:c,error:x}=await p.from("enrollments").select("class_id").eq("student_id",l.id).eq("status","active");if(x)throw x;if(!c||c.length===0){C([]),b(!1);return}const O=c.map(h=>h.class_id),{data:K,error:L}=await p.from("exams").select(`
            *,
            class:classes(name, code)
          `).in("class_id",O).eq("status","published").order("start_time",{ascending:!0});if(L)throw L;const{data:W}=await p.from("exam_sessions").select("exam_id, status, percentage").eq("student_id",l.id),X=new Map((W||[]).map(h=>[h.exam_id,h])),J=(K||[]).map(h=>({...h,session:X.get(h.id)||null}));C(J)}catch(c){console.error("Load exams error:",c);const x=((n=c.message)==null?void 0:n.toLowerCase())||"";x.includes("network")||x.includes("fetch")?f.error(s("error.network")):x.includes("permission")||x.includes("unauthorized")?f.error(s("error.sessionExpired")):f.error(s("error.loadExams"))}finally{b(!1)}})()},[l,i,y,E,s]);const M=async()=>{await P(),w("/login")},z=t=>{var n,c;const a=new Date,o=new Date(t.start_time),r=new Date(t.end_time);return((n=t.session)==null?void 0:n.status)==="submitted"||((c=t.session)==null?void 0:c.status)==="auto_submitted"?{type:"completed",label:s("exam.status.completed"),color:"bg-success-100 text-success-700",icon:me,canTake:!1}:a<o?{type:"upcoming",label:s("exam.status.upcoming"),color:"bg-gray-100 text-gray-600",icon:F,canTake:!1}:a>r?{type:"ended",label:s("exam.status.ended"),color:"bg-gray-100 text-gray-500",icon:$,canTake:!1}:{type:"active",label:s("exam.status.active"),color:"bg-primary-100 text-primary-700",icon:N,canTake:!0}},G=t=>new Date(t).toLocaleString("vi-VN",{day:"2-digit",month:"2-digit",year:"numeric",hour:"2-digit",minute:"2-digit"}),H={hidden:{opacity:0},visible:{opacity:1,transition:{staggerChildren:.1}}},g={hidden:{y:20,opacity:0},visible:{y:0,opacity:1}};return V?e.jsx("div",{className:"min-h-screen bg-background flex items-center justify-center",children:e.jsx(re,{className:"w-8 h-8 animate-spin text-primary"})}):e.jsxs("div",{className:"min-h-screen bg-background font-sans text-text-main",children:[e.jsxs("nav",{className:"bg-paper shadow-sm border-b border-gray-200 px-8 py-4 flex justify-between items-center sticky top-0 z-10",children:[e.jsxs("div",{className:"flex items-center space-x-2",children:[e.jsx("div",{className:"bg-primary p-2 rounded-lg",children:e.jsx(R,{className:"text-white w-6 h-6"})}),e.jsxs("span",{className:"text-xl font-bold text-text-main tracking-tight",children:["SmartExam",e.jsx("span",{className:"text-primary",children:"Pro"})]})]}),e.jsxs("div",{className:"flex items-center space-x-6",children:[e.jsx(ee,{compact:!0}),e.jsxs("div",{className:"flex items-center space-x-2 text-sm font-medium text-gray-600 bg-gray-100 px-3 py-1.5 rounded-full",children:[e.jsx(ie,{className:"w-4 h-4"}),e.jsx("span",{children:(i==null?void 0:i.full_name)||(l==null?void 0:l.email)})]}),e.jsxs("button",{onClick:M,className:"flex items-center space-x-2 text-danger hover:bg-danger-50 px-4 py-2 rounded-lg transition-colors text-sm font-semibold",children:[e.jsx(ne,{className:"w-4 h-4"}),e.jsx("span",{children:s("auth.logout")})]})]})]}),e.jsxs(m.div,{variants:H,initial:"hidden",animate:"visible",className:"max-w-6xl mx-auto px-8 py-10",children:[e.jsxs("div",{className:"mb-8",children:[e.jsxs("h1",{className:"text-3xl font-bold text-text-main",children:[s("dashboard.hello"),", ",((D=i==null?void 0:i.full_name)==null?void 0:D.split(" ").pop())||s("auth.student"),"! ðŸ‘‹"]}),e.jsx("p",{className:"text-gray-500 mt-2",children:s("dashboard.selectExam")})]}),e.jsx(m.div,{variants:g,className:"mb-8",children:e.jsxs("div",{className:"bg-paper rounded-xl border border-gray-100 p-6 shadow-sm",children:[e.jsxs("div",{className:"flex items-center justify-between mb-4",children:[e.jsxs("div",{className:"flex items-center space-x-3",children:[e.jsx("div",{className:`p-3 rounded-full ${u?"bg-success-100":"bg-warning-100"}`,children:u?e.jsx(de,{className:"w-6 h-6 text-success-600"}):e.jsx(se,{className:"w-6 h-6 text-warning-600"})}),e.jsxs("div",{children:[e.jsx("h3",{className:"font-bold text-text-main",children:s("profile.faceVerification")||"XÃ¡c minh khuÃ´n máº·t"}),e.jsx("p",{className:"text-sm text-gray-500",children:u?s("profile.faceRegistered")||"KhuÃ´n máº·t Ä‘Ã£ Ä‘Æ°á»£c Ä‘Äƒng kÃ½":s("profile.faceNotRegistered")||"ChÆ°a Ä‘Äƒng kÃ½ khuÃ´n máº·t - cáº§n Ä‘Äƒng kÃ½ Ä‘á»ƒ lÃ m bÃ i thi"})]})]}),e.jsx("button",{onClick:()=>j(!0),className:`px-4 py-2 rounded-lg font-medium transition-colors ${u?"bg-gray-100 text-gray-700 hover:bg-gray-200":"bg-primary text-white hover:bg-primary-600"}`,children:u?s("profile.updateFace")||"Cáº­p nháº­t áº£nh":s("profile.registerFace")||"ÄÄƒng kÃ½ ngay"})]}),!u&&e.jsxs("div",{className:"bg-warning-50 rounded-lg p-3 text-sm text-warning-700 flex items-start space-x-2",children:[e.jsx($,{className:"w-5 h-5 flex-shrink-0 mt-0.5"}),e.jsx("p",{children:s("profile.faceRequiredWarning")||"Báº¡n cáº§n Ä‘Äƒng kÃ½ khuÃ´n máº·t trÆ°á»›c khi tham gia bÃ i thi Ä‘á»ƒ há»‡ thá»‘ng cÃ³ thá»ƒ xÃ¡c minh danh tÃ­nh."})]})]})}),e.jsx(A,{children:B&&e.jsx(m.div,{initial:{opacity:0},animate:{opacity:1},exit:{opacity:0},className:"fixed inset-0 bg-black/50 z-50 flex items-center justify-center p-4",onClick:()=>j(!1),children:e.jsxs(m.div,{initial:{scale:.95,opacity:0},animate:{scale:1,opacity:1},exit:{scale:.95,opacity:0},className:"bg-paper rounded-2xl shadow-xl max-w-2xl w-full max-h-[90vh] overflow-hidden",onClick:t=>t.stopPropagation(),children:[e.jsxs("div",{className:"p-6 border-b border-gray-200",children:[e.jsx("h2",{className:"text-xl font-bold text-text-main",children:s("profile.faceRegistrationTitle")||"ÄÄƒng kÃ½ khuÃ´n máº·t"}),e.jsx("p",{className:"text-sm text-gray-500 mt-1",children:s("profile.faceRegistrationDesc")||"Chá»¥p áº£nh khuÃ´n máº·t Ä‘á»ƒ sá»­ dá»¥ng cho xÃ¡c minh danh tÃ­nh khi thi"})]}),e.jsxs("div",{className:"p-6",children:[e.jsx(te,{mode:"enroll",onEnrollComplete:t=>{T(!0),j(!1),f.success(s("profile.faceRegisteredSuccess")||"ÄÄƒng kÃ½ khuÃ´n máº·t thÃ nh cÃ´ng!")},onFailure:()=>{f.error(s("face.failed")||"ÄÄƒng kÃ½ tháº¥t báº¡i. Vui lÃ²ng thá»­ láº¡i.")}}),e.jsx("button",{onClick:()=>j(!1),className:"mt-4 w-full py-2 text-gray-600 hover:text-gray-800 text-sm font-medium",children:s("common.cancel")||"Há»§y"})]})]})})}),k.length>0&&e.jsxs(m.div,{variants:g,className:"mb-10",children:[e.jsxs("div",{onClick:()=>U(!_),className:"flex items-center justify-between cursor-pointer mb-4 group",children:[e.jsxs("div",{className:"flex items-center space-x-2",children:[e.jsx(ce,{className:"w-6 h-6 text-primary"}),e.jsx("h2",{className:"text-xl font-bold text-text-main",children:s("dashboard.myClasses")||"Lá»›p há»c cá»§a tÃ´i"}),e.jsx("span",{className:"bg-primary-100 text-primary-700 text-xs font-bold px-2 py-0.5 rounded-full",children:k.length})]}),e.jsx(ae,{className:`w-5 h-5 text-gray-400 transition-transform ${_?"rotate-90":""}`})]}),e.jsx(A,{children:_&&e.jsx(m.div,{initial:{height:0,opacity:0},animate:{height:"auto",opacity:1},exit:{height:0,opacity:0},transition:{duration:.2},className:"overflow-hidden",children:e.jsx("div",{className:"grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4",children:k.map(t=>{var a,o,r,n;return e.jsxs(m.div,{variants:g,className:"bg-paper rounded-xl border border-gray-100 p-4 hover:shadow-soft transition-all",children:[e.jsx("div",{className:"flex items-start justify-between mb-2",children:e.jsxs("div",{className:"flex items-center space-x-2",children:[e.jsx(le,{className:"w-5 h-5 text-primary"}),e.jsx("span",{className:`text-xs font-bold px-2 py-0.5 rounded-full ${t.status==="active"?"bg-success-100 text-success-700":t.status==="completed"?"bg-primary-100 text-primary-700":"bg-gray-100 text-gray-600"}`,children:t.status==="active"?s("student.statusActive")||"Äang há»c":t.status==="completed"?s("class.status.completed")||"HoÃ n thÃ nh":s("class.status.dropped")||"ÄÃ£ rá»i"})]})}),e.jsx("h3",{className:"font-bold text-text-main mb-1 line-clamp-2",children:((a=t.class)==null?void 0:a.name)||"N/A"}),e.jsxs("div",{className:"text-xs text-gray-500 space-y-1",children:[e.jsxs("p",{className:"flex items-center space-x-1",children:[e.jsxs("span",{className:"font-medium",children:[s("class.code")||"MÃ£ lá»›p",":"]}),e.jsx("span",{children:((o=t.class)==null?void 0:o.code)||"N/A"})]}),((r=t.class)==null?void 0:r.instructor)&&e.jsxs("p",{className:"flex items-center space-x-1",children:[e.jsx(oe,{className:"w-3 h-3"}),e.jsx("span",{children:t.class.instructor.full_name||t.class.instructor.email})]}),((n=t.class)==null?void 0:n.semester)&&e.jsxs("p",{children:[t.class.semester," - ",t.class.academic_year||""]})]}),e.jsxs("div",{className:"mt-3 pt-3 border-t border-gray-100 text-xs text-gray-400",children:[s("student.enrolledAt")||"Tham gia",": ",new Date(t.enrolled_at).toLocaleDateString("vi-VN")]})]},t.id)})})})})]}),v.length>0?e.jsx("div",{className:"grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6",children:v.map(t=>{var r,n,c;const a=z(t),o=a.icon;return e.jsxs(m.div,{variants:g,className:`card hover:shadow-soft transition-all group ${a.canTake?"":"opacity-75"}`,children:[e.jsxs("div",{className:"flex justify-between items-start mb-4",children:[e.jsx("div",{className:`px-3 py-1 rounded-full text-xs font-bold uppercase tracking-wider ${a.color}`,children:a.label}),e.jsx(o,{className:`w-5 h-5 ${a.type==="active"?"text-primary":a.type==="completed"?"text-success":"text-gray-400"}`})]}),e.jsx("h3",{className:`text-xl font-bold mb-2 ${a.canTake?"text-text-main group-hover:text-primary":"text-gray-700"} transition-colors`,children:t.title}),e.jsxs("div",{className:"space-y-1 text-sm text-gray-500 mb-4",children:[e.jsxs("p",{children:[s("exam.course"),": ",((r=t.class)==null?void 0:r.name)||"N/A"]}),e.jsxs("p",{children:[s("exam.code"),": ",((n=t.class)==null?void 0:n.code)||"N/A"]}),e.jsxs("p",{className:"flex items-center space-x-1",children:[e.jsx(F,{className:"w-4 h-4"}),e.jsxs("span",{children:[s("exam.duration"),": ",t.duration_minutes," ",s("exam.minutes")]})]})]}),a.type==="completed"&&((c=t.session)==null?void 0:c.percentage)!==null&&e.jsx("div",{className:"mb-4 p-3 bg-success-50 rounded-lg",children:e.jsxs("p",{className:"text-sm text-gray-600",children:[s("exam.score"),": ",e.jsxs("span",{className:"font-bold text-success-700",children:[t.session.percentage.toFixed(1),"%"]})]})}),a.type==="upcoming"&&e.jsx("div",{className:"mb-4 p-3 bg-gray-50 rounded-lg text-xs text-gray-500",children:e.jsxs("p",{children:[s("exam.startTime"),": ",G(t.start_time)]})}),a.canTake?e.jsxs("button",{onClick:()=>w(`/exam/${t.id}`),className:"w-full flex items-center justify-center space-x-2 btn-primary py-3",children:[e.jsx(N,{className:"w-5 h-5"}),e.jsx("span",{children:s("dashboard.enterExam")})]}):a.type==="completed"&&t.allow_review?e.jsx("button",{className:"w-full btn-secondary py-3",children:s("dashboard.reviewExam")}):e.jsx("button",{disabled:!0,className:"w-full bg-gray-200 text-gray-500 py-3 rounded-xl font-semibold cursor-not-allowed",children:a.type==="upcoming"?s("dashboard.notStarted"):a.type==="ended"?s("dashboard.expired"):s("dashboard.notAvailable")})]},t.id)})}):e.jsxs("div",{className:"text-center py-16 bg-paper rounded-2xl border border-gray-100",children:[e.jsx(R,{className:"w-20 h-20 mx-auto mb-4 text-gray-300"}),e.jsx("h2",{className:"text-xl font-bold text-gray-700 mb-2",children:s("dashboard.noExams")}),e.jsx("p",{className:"text-gray-500",children:s("dashboard.noExamsDesc")})]}),v.length===0&&e.jsxs("div",{className:"mt-8",children:[e.jsx("p",{className:"text-sm text-gray-500 mb-4",children:s("dashboard.demoExam")}),e.jsxs(m.div,{variants:g,className:"card hover:shadow-soft transition-all group max-w-md",children:[e.jsxs("div",{className:"flex justify-between items-start mb-4",children:[e.jsx("div",{className:"bg-primary-100 text-primary-700 px-3 py-1 rounded-full text-xs font-bold uppercase tracking-wider",children:"Demo"}),e.jsx(N,{className:"w-5 h-5 text-primary"})]}),e.jsx("h3",{className:"text-xl font-bold text-text-main mb-2 group-hover:text-primary transition-colors",children:"TrÃ­ tuá»‡ nhÃ¢n táº¡o (AI)"}),e.jsxs("p",{className:"text-gray-500 text-sm mb-6",children:[s("exam.code"),": INT3401 â€¢ ",s("exam.duration"),": 45 ",s("exam.minutes")]}),e.jsxs("button",{onClick:()=>w("/exam/demo"),className:"w-full flex items-center justify-center space-x-2 btn-primary py-3",children:[e.jsx(N,{className:"w-5 h-5"}),e.jsx("span",{children:s("dashboard.enterExam")})]})]})]})]})]})}export{ye as default};
