import{c as $,u as G,a as U,b as me,r as g,j as e,T as xe,s as L,B as u,A as ue}from"./index-DefdedXM.js";import{F as he,L as pe}from"./LanguageSwitcher-AejctPwx.js";import{L as D,U as ge,m as ee}from"./proxy-E7lXHHtP.js";import{L as ye}from"./log-out-Bi3GUnA_.js";import{C as te,a as fe}from"./clock-DlWmLaQH.js";import{A as je}from"./index-BwVWJdyy.js";import{S as be}from"./shield-nGhibzAk.js";/**
 * @license lucide-react v0.468.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const Ne=$("Activity",[["path",{d:"M22 12h-2.48a2 2 0 0 0-1.93 1.46l-2.35 8.36a.25.25 0 0 1-.48 0L9.24 2.18a.25.25 0 0 0-.48 0l-2.35 8.36A2 2 0 0 1 4.49 12H2",key:"169zse"}]]);/**
 * @license lucide-react v0.468.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const B=$("BookOpen",[["path",{d:"M12 7v14",key:"1akyts"}],["path",{d:"M3 18a1 1 0 0 1-1-1V4a1 1 0 0 1 1-1h5a4 4 0 0 1 4 4 4 4 0 0 1 4-4h5a1 1 0 0 1 1 1v13a1 1 0 0 1-1 1h-6a3 3 0 0 0-3 3 3 3 0 0 0-3-3z",key:"ruj8y"}]]);/**
 * @license lucide-react v0.468.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const ve=$("Calendar",[["path",{d:"M8 2v4",key:"1cmpym"}],["path",{d:"M16 2v4",key:"4m81vk"}],["rect",{width:"18",height:"18",x:"3",y:"4",rx:"2",key:"1hopcy"}],["path",{d:"M3 10h18",key:"8toen8"}]]);/**
 * @license lucide-react v0.468.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const H=$("ChartColumn",[["path",{d:"M3 3v16a2 2 0 0 0 2 2h16",key:"c24i48"}],["path",{d:"M18 17V9",key:"2bz60n"}],["path",{d:"M13 17V5",key:"1frdt8"}],["path",{d:"M8 17v-3",key:"17ska0"}]]);/**
 * @license lucide-react v0.468.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const V=$("ClipboardList",[["rect",{width:"8",height:"4",x:"8",y:"2",rx:"1",ry:"1",key:"tgr4d6"}],["path",{d:"M16 4h2a2 2 0 0 1 2 2v14a2 2 0 0 1-2 2H6a2 2 0 0 1-2-2V6a2 2 0 0 1 2-2h2",key:"116196"}],["path",{d:"M12 11h4",key:"1jrz19"}],["path",{d:"M12 16h4",key:"n85exb"}],["path",{d:"M8 11h.01",key:"1dfujw"}],["path",{d:"M8 16h.01",key:"18s6g9"}]]);/**
 * @license lucide-react v0.468.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const _e=$("GraduationCap",[["path",{d:"M21.42 10.922a1 1 0 0 0-.019-1.838L12.83 5.18a2 2 0 0 0-1.66 0L2.6 9.08a1 1 0 0 0 0 1.832l8.57 3.908a2 2 0 0 0 1.66 0z",key:"j76jl0"}],["path",{d:"M22 10v6",key:"1lu8f3"}],["path",{d:"M6 12.5V16a6 3 0 0 0 12 0v-3.5",key:"1r8lef"}]]);/**
 * @license lucide-react v0.468.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const we=$("Pen",[["path",{d:"M21.174 6.812a1 1 0 0 0-3.986-3.987L3.842 16.174a2 2 0 0 0-.5.83l-1.321 4.352a.5.5 0 0 0 .623.622l4.353-1.32a2 2 0 0 0 .83-.497z",key:"1a8usu"}]]);/**
 * @license lucide-react v0.468.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const R=$("Plus",[["path",{d:"M5 12h14",key:"1ays0h"}],["path",{d:"M12 5v14",key:"s699le"}]]);/**
 * @license lucide-react v0.468.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const ae=$("Save",[["path",{d:"M15.2 3a2 2 0 0 1 1.4.6l3.8 3.8a2 2 0 0 1 .6 1.4V19a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2z",key:"1c8476"}],["path",{d:"M17 21v-7a1 1 0 0 0-1-1H8a1 1 0 0 0-1 1v7",key:"1ydtos"}],["path",{d:"M7 3v4a1 1 0 0 0 1 1h7",key:"t51u73"}]]);/**
 * @license lucide-react v0.468.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const Ce=$("Search",[["circle",{cx:"11",cy:"11",r:"8",key:"4ej97u"}],["path",{d:"m21 21-4.3-4.3",key:"1qie3q"}]]);/**
 * @license lucide-react v0.468.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const re=$("Trash2",[["path",{d:"M3 6h18",key:"d0wm0j"}],["path",{d:"M19 6v14c0 1-1 2-2 2H7c-1 0-2-1-2-2V6",key:"4alrt4"}],["path",{d:"M8 6V4c0-1 1-2 2-2h4c1 0 2 1 2 2v2",key:"v07s0e"}],["line",{x1:"10",x2:"10",y1:"11",y2:"17",key:"1uufr5"}],["line",{x1:"14",x2:"14",y1:"11",y2:"17",key:"xtxkd"}]]);/**
 * @license lucide-react v0.468.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const X=$("Users",[["path",{d:"M16 21v-2a4 4 0 0 0-4-4H6a4 4 0 0 0-4 4v2",key:"1yyitq"}],["circle",{cx:"9",cy:"7",r:"4",key:"nufk8"}],["path",{d:"M22 21v-2a4 4 0 0 0-3-3.87",key:"kshegd"}],["path",{d:"M16 3.13a4 4 0 0 1 0 7.75",key:"1da9ce"}]]);/**
 * @license lucide-react v0.468.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const ne=$("X",[["path",{d:"M18 6 6 18",key:"1bl5f8"}],["path",{d:"m6 6 12 12",key:"d8bk6v"}]]),Se=/^[^\s@]+@[^\s@]+\.[^\s@]+$/;function ke(c){return Se.test(c)}function Ee(c){return/^[A-Za-z0-9-_]+$/.test(c)}function Y({isOpen:c,onClose:_,title:o,children:s}){return c?e.jsx(je,{children:e.jsx(ee.div,{initial:{opacity:0},animate:{opacity:1},exit:{opacity:0},className:"fixed inset-0 bg-black/50 z-50 flex items-center justify-center p-4",onClick:_,children:e.jsxs(ee.div,{initial:{scale:.95,opacity:0},animate:{scale:1,opacity:1},exit:{scale:.95,opacity:0},className:"bg-paper rounded-2xl shadow-soft max-w-2xl w-full max-h-[90vh] overflow-hidden",onClick:a=>a.stopPropagation(),children:[e.jsxs("div",{className:"flex items-center justify-between p-6 border-b border-gray-200",children:[e.jsx("h2",{className:"text-xl font-bold text-text-main",children:o}),e.jsx("button",{onClick:_,className:"p-2 hover:bg-gray-100 rounded-lg transition-colors",children:e.jsx(ne,{className:"w-5 h-5 text-gray-500"})})]}),e.jsx("div",{className:"p-6 overflow-y-auto max-h-[calc(90vh-150px)]",children:s})]})})}):null}function Te({classId:c,onClose:_,onSuccess:o}){const{user:s}=G(),{t:a}=U(),[m,w]=g.useState(!1),[r,E]=g.useState({title:"",description:"",duration_minutes:60,start_time:"",end_time:"",is_shuffled:!0,show_result_immediately:!1,allow_review:!1,passing_score:50,max_attempts:1,require_camera:!0,require_fullscreen:!0,max_tab_violations:3,max_fullscreen_violations:3}),h=d=>{const{name:p,value:n,type:N,checked:f}=d.target;E(t=>({...t,[p]:N==="checkbox"?f:n}))},b=async d=>{if(d.preventDefault(),m)return;const p=r.title.trim();if(!p){u.error(a("validation.enterExamTitle"));return}if(p.length>200){u.error(a("validation.examTitleTooLong"));return}if(!r.start_time||!r.end_time){u.error(a("validation.selectTime"));return}const n=new Date(r.start_time);if(new Date(r.end_time)<=n){u.error(a("validation.endAfterStart"));return}const f=parseInt(r.duration_minutes);if(isNaN(f)||f<5||f>480){u.error(a("validation.durationRange"));return}w(!0);const t=async(l=0)=>{var M,j,A,C,S,F;try{const k=new Promise((z,J)=>setTimeout(()=>J(new Error("REQUEST_TIMEOUT")),3e4)),T=L.from("exams").insert({title:p,description:((M=r.description)==null?void 0:M.trim())||null,duration_minutes:f,start_time:r.start_time,end_time:r.end_time,is_shuffled:r.is_shuffled,show_result_immediately:r.show_result_immediately,allow_review:r.allow_review,passing_score:parseFloat(r.passing_score)||50,max_attempts:parseInt(r.max_attempts)||1,require_camera:r.require_camera,require_fullscreen:r.require_fullscreen,max_tab_violations:parseInt(r.max_tab_violations)||3,max_fullscreen_violations:parseInt(r.max_fullscreen_violations)||3,class_id:c,created_by:s.id,status:"draft"}).select().single(),{data:I,error:Q}=await Promise.race([T,k]);if(Q)throw Q;u.success(a("exam.createSuccess")),o==null||o(I),_()}catch(k){if(console.error("Create exam error:",k),console.error("Error details:",{code:k.code,message:k.message,details:k.details,hint:k.hint}),k.message==="REQUEST_TIMEOUT"){if(l<3)return u.info(a("error.retrying",{attempt:l+1,max:3})),await new Promise(T=>setTimeout(T,1e3)),t(l+1);u.error(a("error.timeout"))}else k.code==="42501"||(j=k.message)!=null&&j.includes("permission")||(A=k.message)!=null&&A.includes("denied")?u.error(a("error.permission")):(C=k.message)!=null&&C.includes("network")||(S=k.message)!=null&&S.includes("fetch")||(F=k.message)!=null&&F.includes("Failed to fetch")?u.error(a("error.network")):k.code==="23503"?u.error(a("exam.createError")):u.error(a("exam.createError"))}finally{w(!1)}};await t(0)};return e.jsxs("form",{onSubmit:b,className:"space-y-6",children:[e.jsxs("div",{className:"space-y-4",children:[e.jsxs("h3",{className:"font-semibold text-gray-900 flex items-center space-x-2",children:[e.jsx(B,{className:"w-5 h-5 text-primary"}),e.jsx("span",{children:a("exam.basicInfo")})]}),e.jsxs("div",{children:[e.jsxs("label",{className:"block text-sm font-medium text-gray-700 mb-1",children:[a("exam.title")," ",e.jsx("span",{className:"text-danger",children:"*"})]}),e.jsx("input",{type:"text",name:"title",value:r.title,onChange:h,placeholder:a("exam.titlePlaceholder"),className:"input"})]}),e.jsxs("div",{children:[e.jsx("label",{className:"block text-sm font-medium text-gray-700 mb-1",children:a("exam.description")}),e.jsx("textarea",{name:"description",value:r.description,onChange:h,placeholder:a("exam.descriptionPlaceholder"),rows:3,className:"input resize-none"})]}),e.jsxs("div",{className:"grid grid-cols-2 gap-4",children:[e.jsxs("div",{children:[e.jsx("label",{className:"block text-sm font-medium text-gray-700 mb-1",children:a("exam.durationMinutes")}),e.jsx("input",{type:"number",name:"duration_minutes",value:r.duration_minutes,onChange:h,min:5,max:300,className:"input"})]}),e.jsxs("div",{children:[e.jsx("label",{className:"block text-sm font-medium text-gray-700 mb-1",children:a("exam.passingScore")}),e.jsx("input",{type:"number",name:"passing_score",value:r.passing_score,onChange:h,min:0,max:100,className:"input"})]})]})]}),e.jsxs("div",{className:"space-y-4",children:[e.jsxs("h3",{className:"font-semibold text-gray-900 flex items-center space-x-2",children:[e.jsx(te,{className:"w-5 h-5 text-primary"}),e.jsx("span",{children:a("exam.timeSettings")})]}),e.jsxs("div",{className:"grid grid-cols-2 gap-4",children:[e.jsxs("div",{children:[e.jsxs("label",{className:"block text-sm font-medium text-gray-700 mb-1",children:[a("exam.startTime")," ",e.jsx("span",{className:"text-danger",children:"*"})]}),e.jsx("input",{type:"datetime-local",name:"start_time",value:r.start_time,onChange:h,className:"input"})]}),e.jsxs("div",{children:[e.jsxs("label",{className:"block text-sm font-medium text-gray-700 mb-1",children:[a("exam.endTime")," ",e.jsx("span",{className:"text-danger",children:"*"})]}),e.jsx("input",{type:"datetime-local",name:"end_time",value:r.end_time,onChange:h,className:"input"})]})]})]}),e.jsxs("div",{className:"space-y-4",children:[e.jsxs("h3",{className:"font-semibold text-gray-900 flex items-center space-x-2",children:[e.jsx(be,{className:"w-5 h-5 text-primary"}),e.jsx("span",{children:a("exam.antiCheatSettings")})]}),e.jsxs("div",{className:"grid grid-cols-2 gap-4",children:[e.jsxs("label",{className:"flex items-center space-x-3 p-3 bg-gray-50 rounded-lg cursor-pointer hover:bg-gray-100 transition-colors",children:[e.jsx("input",{type:"checkbox",name:"require_camera",checked:r.require_camera,onChange:h,className:"w-5 h-5 text-primary rounded"}),e.jsx("span",{className:"text-sm text-gray-700",children:a("exam.requireCamera")})]}),e.jsxs("label",{className:"flex items-center space-x-3 p-3 bg-gray-50 rounded-lg cursor-pointer hover:bg-gray-100 transition-colors",children:[e.jsx("input",{type:"checkbox",name:"require_fullscreen",checked:r.require_fullscreen,onChange:h,className:"w-5 h-5 text-primary rounded"}),e.jsx("span",{className:"text-sm text-gray-700",children:a("exam.requireFullscreen")})]}),e.jsxs("label",{className:"flex items-center space-x-3 p-3 bg-gray-50 rounded-lg cursor-pointer hover:bg-gray-100 transition-colors",children:[e.jsx("input",{type:"checkbox",name:"is_shuffled",checked:r.is_shuffled,onChange:h,className:"w-5 h-5 text-primary rounded"}),e.jsx("span",{className:"text-sm text-gray-700",children:a("exam.shuffleQuestions")})]}),e.jsxs("label",{className:"flex items-center space-x-3 p-3 bg-gray-50 rounded-lg cursor-pointer hover:bg-gray-100 transition-colors",children:[e.jsx("input",{type:"checkbox",name:"show_result_immediately",checked:r.show_result_immediately,onChange:h,className:"w-5 h-5 text-primary rounded"}),e.jsx("span",{className:"text-sm text-gray-700",children:a("exam.showResultImmediately")})]})]}),e.jsxs("div",{className:"grid grid-cols-2 gap-4",children:[e.jsxs("div",{children:[e.jsx("label",{className:"block text-sm font-medium text-gray-700 mb-1",children:a("exam.maxTabViolations")}),e.jsx("input",{type:"number",name:"max_tab_violations",value:r.max_tab_violations,onChange:h,min:0,max:10,className:"input"})]}),e.jsxs("div",{children:[e.jsx("label",{className:"block text-sm font-medium text-gray-700 mb-1",children:a("exam.maxFullscreenViolations")}),e.jsx("input",{type:"number",name:"max_fullscreen_violations",value:r.max_fullscreen_violations,onChange:h,min:0,max:10,className:"input"})]})]})]}),e.jsxs("div",{className:"flex items-center justify-end space-x-3 pt-4 border-t border-gray-200",children:[e.jsx("button",{type:"button",onClick:_,className:"btn-secondary",children:a("common.cancel")}),e.jsxs("button",{type:"submit",disabled:m,className:"btn-primary",children:[m?e.jsx(D,{className:"w-5 h-5 mr-2 animate-spin"}):e.jsx(ae,{className:"w-5 h-5 mr-2"}),a("exam.create")]})]})]})}function Me({classId:c,onClose:_,onSuccess:o}){const{t:s}=U(),[a,m]=g.useState(!1),[w,r]=g.useState(""),[E,h]=g.useState(""),[b,d]=g.useState("single"),p=async t=>{try{const{data:l,error:x}=await L.rpc("add_student_to_class",{p_class_id:c,p_student_email:t.toLowerCase().trim()});return x?(console.error("RPC add_student_to_class error:",x),{success:!1,error:"rpc_failed"}):l&&l.success?{success:!0,student_id:l.student_id}:{success:!1,error:(l==null?void 0:l.error)||"unknown_error"}}catch(l){return console.error("RPC call exception:",l),{success:!1,error:"rpc_exception"}}},n=async t=>{const{data:l,error:x}=await L.from("profiles").select("id, role").eq("email",t.toLowerCase().trim()).single();if(x)return x.code==="PGRST116"?{success:!1,error:"student_not_found"}:(console.error("Profile lookup error:",x),{success:!1,error:"lookup_failed"});if(!l)return{success:!1,error:"student_not_found"};const{error:v}=await L.from("enrollments").insert({class_id:c,student_id:l.id,status:"active"});return v?v.code==="23505"?{success:!1,error:"already_enrolled"}:(console.error("Enroll error:",v),{success:!1,error:"enroll_failed"}):{success:!0}},N=async t=>{const l=await p(t);return l.success?l:l.error==="rpc_failed"||l.error==="rpc_exception"?(console.log("RPC not available, falling back to direct method"),n(t)):l},f=async t=>{if(t.preventDefault(),a)return;const l=b==="single"?[w.trim()]:E.split(`
`).map(C=>C.trim()).filter(C=>C);if(l.length===0){u.error(s("validation.enterStudentEmail"));return}if(l.length>100){u.error(s("validation.maxEmails"));return}const x=l.filter(C=>!ke(C));if(x.length>0){u.error(s("validation.invalidEmails",{emails:x.slice(0,3).join(", ")+(x.length>3?"...":"")}));return}m(!0);let v=0,M=0;const j=[],A=15e3;for(const C of l)try{const S=new Promise((T,I)=>setTimeout(()=>I(new Error("REQUEST_TIMEOUT")),A)),F=N(C),k=await Promise.race([F,S]);if(k.success)v++;else{const T=k.error;T==="student_not_found"?j.push(`${C}: ${s("student.notRegistered")}`):T==="already_enrolled"?j.push(`${C}: ${s("student.alreadyInClass")}`):T==="class_not_found"?j.push(`${C}: ${s("error.classNotFound")}`):T==="not_authorized"?j.push(`${C}: ${s("error.permission")}`):j.push(`${C}: ${s("student.addError")}`),M++}}catch(S){console.error("Add student error:",S),S.message==="REQUEST_TIMEOUT"?j.push(`${C}: ${s("error.timeout")}`):j.push(`${C}: ${s("error.network")}`),M++}if(m(!1),v>0&&(u.success(s("student.addSuccess",{count:v})),o==null||o()),M>0){const C=j.slice(0,3).join(`
`),S=j.length>3?`
... ${j.length-3} ${s("common.more")}`:"";u.warning(`${C}${S}`,{autoClose:8e3})}v>0&&M===0&&_()};return e.jsxs("form",{onSubmit:f,className:"space-y-6",children:[e.jsxs("div",{className:"flex space-x-2 p-1 bg-gray-100 rounded-lg",children:[e.jsx("button",{type:"button",onClick:()=>d("single"),className:`flex-1 py-2 px-4 rounded-md text-sm font-medium transition-colors ${b==="single"?"bg-white shadow text-primary":"text-gray-600 hover:text-gray-900"}`,children:s("student.addSingle")}),e.jsx("button",{type:"button",onClick:()=>d("bulk"),className:`flex-1 py-2 px-4 rounded-md text-sm font-medium transition-colors ${b==="bulk"?"bg-white shadow text-primary":"text-gray-600 hover:text-gray-900"}`,children:s("student.addBulk")})]}),b==="single"?e.jsxs("div",{children:[e.jsx("label",{className:"block text-sm font-medium text-gray-700 mb-1",children:s("student.email")}),e.jsx("input",{type:"email",value:w,onChange:t=>r(t.target.value),placeholder:"student@example.com",className:"input"}),e.jsx("p",{className:"text-xs text-gray-500 mt-1",children:s("student.emailNote")})]}):e.jsxs("div",{children:[e.jsx("label",{className:"block text-sm font-medium text-gray-700 mb-1",children:s("student.emailList")}),e.jsx("textarea",{value:E,onChange:t=>h(t.target.value),placeholder:`student1@example.com
student2@example.com
student3@example.com`,rows:8,className:"input resize-none font-mono text-sm"})]}),e.jsxs("div",{className:"flex items-center justify-end space-x-3 pt-4 border-t border-gray-200",children:[e.jsx("button",{type:"button",onClick:_,className:"btn-secondary",children:s("common.cancel")}),e.jsxs("button",{type:"submit",disabled:a,className:"btn-primary",children:[a?e.jsx(D,{className:"w-5 h-5 mr-2 animate-spin"}):e.jsx(R,{className:"w-5 h-5 mr-2"}),s("student.add")]})]})]})}function Ae({examId:c,examTitle:_,onClose:o}){const{t:s}=U(),[a,m]=g.useState(!0),[w,r]=g.useState(!1),[E,h]=g.useState([]),[b,d]=g.useState(null),[p,n]=g.useState(!1);g.useEffect(()=>{(async()=>{try{const{data:l,error:x}=await L.from("questions").select("*").eq("exam_id",c).order("order_index");if(x)throw x;h(l||[])}catch(l){console.error("Load questions error:",l),u.error(s("error.general"))}finally{m(!1)}})()},[c,s]);const N=async t=>{if(window.confirm(s("question.deleteConfirm")))try{const{error:l}=await L.from("questions").delete().eq("id",t);if(l)throw l;h(x=>x.filter(v=>v.id!==t)),u.success(s("common.success"))}catch{u.error(s("error.general"))}},f=async t=>{r(!0);try{if(b){const{error:l}=await L.from("questions").update({question_text:t.question_text,question_type:t.question_type,options:t.options,correct_answer:t.correct_answer,points:t.points,difficulty:t.difficulty,explanation:t.explanation}).eq("id",b.id);if(l)throw l;h(x=>x.map(v=>v.id===b.id?{...v,...t}:v))}else{const{data:l,error:x}=await L.from("questions").insert({exam_id:c,question_text:t.question_text,question_type:t.question_type,options:t.options,correct_answer:t.correct_answer,points:t.points,difficulty:t.difficulty,explanation:t.explanation,order_index:E.length}).select().single();if(x)throw x;h(v=>[...v,l])}u.success(s("question.saveSuccess")),d(null),n(!1)}catch(l){console.error("Save question error:",l),u.error(s("question.saveError"))}finally{r(!1)}};return a?e.jsx("div",{className:"flex items-center justify-center p-12",children:e.jsx(D,{className:"w-8 h-8 animate-spin text-primary"})}):e.jsxs("div",{className:"space-y-6",children:[e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsxs("div",{children:[e.jsx("h3",{className:"font-semibold text-gray-900",children:_}),e.jsx("p",{className:"text-sm text-gray-500",children:s("exam.questionsCount",{count:E.length})})]}),e.jsxs("button",{onClick:()=>{d(null),n(!0)},className:"btn-primary",children:[e.jsx(R,{className:"w-5 h-5 mr-2"}),s("question.add")]})]}),(p||b)&&e.jsx(Le,{question:b,onSave:f,onCancel:()=>{d(null),n(!1)},saving:w}),E.length>0?e.jsx("div",{className:"space-y-3",children:E.map((t,l)=>e.jsx("div",{className:"p-4 border border-gray-200 rounded-lg hover:border-primary-300 transition-colors",children:e.jsxs("div",{className:"flex items-start justify-between",children:[e.jsxs("div",{className:"flex-1",children:[e.jsxs("div",{className:"flex items-center space-x-2 mb-2",children:[e.jsx("span",{className:"w-6 h-6 bg-primary-100 text-primary text-sm font-bold rounded-full flex items-center justify-center",children:l+1}),e.jsx("span",{className:"text-xs px-2 py-0.5 bg-gray-100 text-gray-600 rounded",children:t.question_type==="multiple_choice"?s("question.multipleChoice"):t.question_type==="true_false"?s("question.trueFalse"):t.question_type==="short_answer"?s("question.shortAnswer"):s("question.essay")}),e.jsxs("span",{className:"text-xs text-gray-500",children:[t.points," ",s("exam.points")]})]}),e.jsx("p",{className:"text-gray-800",children:t.question_text}),t.options&&t.options.length>0&&e.jsx("div",{className:"mt-2 space-y-1",children:t.options.map((x,v)=>e.jsxs("div",{className:`text-sm px-2 py-1 rounded ${JSON.stringify(t.correct_answer)===JSON.stringify(x.id)?"bg-success-50 text-success-700":"text-gray-600"}`,children:[x.id,". ",x.text,JSON.stringify(t.correct_answer)===JSON.stringify(x.id)&&" âœ“"]},x.id||v))})]}),e.jsxs("div",{className:"flex items-center space-x-1 ml-4",children:[e.jsx("button",{onClick:()=>{d(t),n(!1)},className:"p-2 hover:bg-gray-100 rounded-lg transition-colors",title:s("question.edit"),children:e.jsx(we,{className:"w-4 h-4 text-gray-500"})}),e.jsx("button",{onClick:()=>N(t.id),className:"p-2 hover:bg-danger-50 rounded-lg transition-colors",title:s("question.delete"),children:e.jsx(re,{className:"w-4 h-4 text-danger"})})]})]})},t.id))}):!p&&e.jsxs("div",{className:"text-center py-12 bg-gray-50 rounded-xl",children:[e.jsx(V,{className:"w-16 h-16 mx-auto mb-4 text-gray-300"}),e.jsx("p",{className:"text-gray-500 mb-2",children:s("question.noQuestions")}),e.jsx("p",{className:"text-sm text-gray-400 mb-4",children:s("question.noQuestionsDesc")}),e.jsxs("button",{onClick:()=>{d(null),n(!0)},className:"btn-primary",children:[e.jsx(R,{className:"w-5 h-5 mr-2"}),s("question.add")]})]}),e.jsx("div",{className:"flex justify-end pt-4 border-t border-gray-200",children:e.jsx("button",{onClick:o,className:"btn-secondary",children:s("common.close")})})]})}const se=2,Pe=6;function Le({question:c,onSave:_,onCancel:o,saving:s}){const{t:a}=U(),[m,w]=g.useState({question_text:(c==null?void 0:c.question_text)||"",question_type:(c==null?void 0:c.question_type)||"multiple_choice",options:(c==null?void 0:c.options)||[{id:"A",text:""},{id:"B",text:""},{id:"C",text:""},{id:"D",text:""}],correct_answer:(c==null?void 0:c.correct_answer)||"A",points:(c==null?void 0:c.points)||1,difficulty:(c==null?void 0:c.difficulty)||"medium",explanation:(c==null?void 0:c.explanation)||""}),r=d=>{if(d.preventDefault(),!m.question_text.trim()){u.error(a("validation.required"));return}_(m)},E=(d,p)=>{const n=[...m.options];n[d]={...n[d],text:p},w(N=>({...N,options:n}))},h=()=>{const d=String.fromCharCode(65+m.options.length);w(p=>({...p,options:[...p.options,{id:d,text:""}]}))},b=d=>{if(m.options.length<=se)return;const n=m.options.filter((N,f)=>f!==d).map((N,f)=>({...N,id:String.fromCharCode(65+f)}));w(N=>{var f;return{...N,options:n,correct_answer:((f=n[0])==null?void 0:f.id)||"A"}})};return e.jsxs("form",{onSubmit:r,className:"p-4 bg-gray-50 rounded-xl space-y-4",children:[e.jsxs("div",{children:[e.jsxs("label",{className:"block text-sm font-medium text-gray-700 mb-1",children:[a("question.text")," ",e.jsx("span",{className:"text-danger",children:"*"})]}),e.jsx("textarea",{value:m.question_text,onChange:d=>w(p=>({...p,question_text:d.target.value})),placeholder:a("question.textPlaceholder"),rows:3,className:"input resize-none"})]}),e.jsxs("div",{className:"grid grid-cols-3 gap-4",children:[e.jsxs("div",{children:[e.jsx("label",{className:"block text-sm font-medium text-gray-700 mb-1",children:a("question.type")}),e.jsxs("select",{value:m.question_type,onChange:d=>w(p=>({...p,question_type:d.target.value})),className:"input",children:[e.jsx("option",{value:"multiple_choice",children:a("question.multipleChoice")}),e.jsx("option",{value:"true_false",children:a("question.trueFalse")})]})]}),e.jsxs("div",{children:[e.jsx("label",{className:"block text-sm font-medium text-gray-700 mb-1",children:a("question.points")}),e.jsx("input",{type:"number",value:m.points,onChange:d=>w(p=>({...p,points:parseFloat(d.target.value)||1})),min:.5,step:.5,className:"input"})]}),e.jsxs("div",{children:[e.jsx("label",{className:"block text-sm font-medium text-gray-700 mb-1",children:a("question.difficulty")}),e.jsxs("select",{value:m.difficulty,onChange:d=>w(p=>({...p,difficulty:d.target.value})),className:"input",children:[e.jsx("option",{value:"easy",children:a("question.difficultyEasy")}),e.jsx("option",{value:"medium",children:a("question.difficultyMedium")}),e.jsx("option",{value:"hard",children:a("question.difficultyHard")})]})]})]}),m.question_type==="multiple_choice"&&e.jsxs("div",{children:[e.jsx("label",{className:"block text-sm font-medium text-gray-700 mb-2",children:a("question.options")}),e.jsx("div",{className:"space-y-2",children:m.options.map((d,p)=>e.jsxs("div",{className:"flex items-center space-x-2",children:[e.jsx("input",{type:"radio",name:"correct_answer",checked:m.correct_answer===d.id,onChange:()=>w(n=>({...n,correct_answer:d.id})),className:"w-4 h-4 text-primary"}),e.jsx("span",{className:"w-6 h-6 bg-gray-200 rounded-full flex items-center justify-center text-sm font-medium",children:d.id}),e.jsx("input",{type:"text",value:d.text,onChange:n=>E(p,n.target.value),placeholder:a("question.optionPlaceholder"),className:"input flex-1"}),m.options.length>se&&e.jsx("button",{type:"button",onClick:()=>b(p),className:"p-2 hover:bg-danger-50 rounded-lg transition-colors text-danger",children:e.jsx(ne,{className:"w-4 h-4"})})]},p))}),m.options.length<Pe&&e.jsxs("button",{type:"button",onClick:h,className:"mt-2 text-sm text-primary hover:text-primary-700 flex items-center",children:[e.jsx(R,{className:"w-4 h-4 mr-1"}),a("question.addOption")]})]}),m.question_type==="true_false"&&e.jsxs("div",{children:[e.jsx("label",{className:"block text-sm font-medium text-gray-700 mb-2",children:a("question.correctAnswer")}),e.jsxs("div",{className:"flex space-x-4",children:[e.jsxs("label",{className:"flex items-center space-x-2",children:[e.jsx("input",{type:"radio",name:"tf_answer",checked:m.correct_answer===!0||m.correct_answer==="true",onChange:()=>w(d=>({...d,correct_answer:!0})),className:"w-4 h-4 text-primary"}),e.jsx("span",{children:a("common.yes")})]}),e.jsxs("label",{className:"flex items-center space-x-2",children:[e.jsx("input",{type:"radio",name:"tf_answer",checked:m.correct_answer===!1||m.correct_answer==="false",onChange:()=>w(d=>({...d,correct_answer:!1})),className:"w-4 h-4 text-primary"}),e.jsx("span",{children:a("common.no")})]})]})]}),e.jsxs("div",{children:[e.jsx("label",{className:"block text-sm font-medium text-gray-700 mb-1",children:a("question.explanation")}),e.jsx("textarea",{value:m.explanation,onChange:d=>w(p=>({...p,explanation:d.target.value})),placeholder:a("question.explanationPlaceholder"),rows:2,className:"input resize-none"})]}),e.jsxs("div",{className:"flex items-center justify-end space-x-3",children:[e.jsx("button",{type:"button",onClick:o,className:"btn-secondary",children:a("common.cancel")}),e.jsxs("button",{type:"submit",disabled:s,className:"btn-primary",children:[s&&e.jsx(D,{className:"w-4 h-4 mr-2 animate-spin"}),a("common.save")]})]})]})}function Oe({classId:c,exams:_}){const{t:o}=U(),[s,a]=g.useState(!0),[m,w]=g.useState(""),[r,E]=g.useState([]),[h,b]=g.useState(null);g.useEffect(()=>{(async()=>{if(!m){E([]),b(null);return}a(!0);try{const{data:N,error:f}=await L.from("exam_sessions").select(`
            *,
            student:profiles(id, full_name, email, student_id)
          `).eq("exam_id",m).order("submitted_at",{ascending:!1});if(f)throw f;if(E(N||[]),N&&N.length>0){const t=N.filter(j=>j.status==="submitted"||j.status==="auto_submitted"),l=t.length>0?t.reduce((j,A)=>j+(A.percentage||0),0)/t.length:0,x=t.filter(j=>j.passed).length,v=t.length>0?t.reduce((j,A)=>j+(A.cheat_count||0)+(A.tab_violations||0),0)/t.length:0,M=t.filter(j=>j.is_flagged||(j.cheat_count||0)>2).length;b({totalStudents:N.length,submittedCount:t.length,avgScore:l.toFixed(1),passRate:t.length>0?(x/t.length*100).toFixed(1):0,avgViolations:v.toFixed(1),flaggedCount:M,highestScore:t.length>0?Math.max(...t.map(j=>j.percentage||0)).toFixed(1):0,lowestScore:t.length>0?Math.min(...t.map(j=>j.percentage||0)).toFixed(1):0})}else b(null)}catch(N){console.error("Load sessions error:",N),u.error(o("error.general"))}finally{a(!1)}})()},[m,o]);const d=n=>n?new Date(n).toLocaleString("vi-VN",{day:"2-digit",month:"2-digit",year:"numeric",hour:"2-digit",minute:"2-digit"}):"-",p=n=>{const N=(n.cheat_count||0)+(n.tab_violations||0)+(n.fullscreen_violations||0);return N===0?{label:o("analytics.integrity.good"),color:"bg-success-100 text-success-700"}:N<=3?{label:o("analytics.integrity.warning"),color:"bg-warning-100 text-warning-700"}:{label:o("analytics.integrity.suspicious"),color:"bg-danger-100 text-danger-700"}};return e.jsxs("div",{className:"space-y-6",children:[e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsx("h2",{className:"text-lg font-bold text-text-main",children:o("tabs.analytics")}),e.jsx("div",{className:"w-64",children:e.jsxs("select",{value:m,onChange:n=>w(n.target.value),className:"input",children:[e.jsx("option",{value:"",children:o("analytics.selectExam")}),_.map(n=>e.jsx("option",{value:n.id,children:n.title},n.id))]})})]}),m?s?e.jsx("div",{className:"flex items-center justify-center py-12",children:e.jsx(D,{className:"w-8 h-8 animate-spin text-primary"})}):h?e.jsxs(e.Fragment,{children:[e.jsxs("div",{className:"grid grid-cols-4 gap-4",children:[e.jsxs("div",{className:"card",children:[e.jsx("p",{className:"text-sm text-gray-500 mb-1",children:o("analytics.totalStudents")}),e.jsxs("p",{className:"text-2xl font-bold text-text-main",children:[h.submittedCount,"/",h.totalStudents]})]}),e.jsxs("div",{className:"card",children:[e.jsx("p",{className:"text-sm text-gray-500 mb-1",children:o("analytics.avgScore")}),e.jsxs("p",{className:"text-2xl font-bold text-primary",children:[h.avgScore,"%"]})]}),e.jsxs("div",{className:"card",children:[e.jsx("p",{className:"text-sm text-gray-500 mb-1",children:o("analytics.passRate")}),e.jsxs("p",{className:"text-2xl font-bold text-success",children:[h.passRate,"%"]})]}),e.jsxs("div",{className:"card",children:[e.jsx("p",{className:"text-sm text-gray-500 mb-1",children:o("analytics.flagged")}),e.jsx("p",{className:"text-2xl font-bold text-danger",children:h.flaggedCount})]})]}),e.jsxs("div",{className:"card",children:[e.jsx("h3",{className:"font-semibold text-gray-900 mb-4",children:o("analytics.scoreDistribution")}),e.jsx("div",{className:"space-y-3 mb-6",children:(()=>{const n=[{label:"90-100%",min:90,max:100,color:"bg-success-600"},{label:"80-89%",min:80,max:89,color:"bg-success-500"},{label:"70-79%",min:70,max:79,color:"bg-primary"},{label:"60-69%",min:60,max:69,color:"bg-warning-500"},{label:"50-59%",min:50,max:59,color:"bg-warning-600"},{label:"0-49%",min:0,max:49,color:"bg-danger"}],N=r.filter(t=>t.status==="submitted"||t.status==="auto_submitted"),f=N.length||1;return n.map(t=>{const l=N.filter(v=>(v.percentage||0)>=t.min&&(v.percentage||0)<=t.max).length,x=l/f*100;return e.jsxs("div",{className:"flex items-center space-x-3",children:[e.jsx("span",{className:"text-sm text-gray-600 w-20",children:t.label}),e.jsx("div",{className:"flex-1 h-6 bg-gray-100 rounded-full overflow-hidden",children:e.jsx("div",{className:`h-full ${t.color} transition-all duration-500`,style:{width:`${x}%`}})}),e.jsxs("span",{className:"text-sm font-medium text-gray-700 w-16 text-right",children:[l," (",x.toFixed(0),"%)"]})]},t.label)})})()}),e.jsxs("div",{className:"flex items-center space-x-4 text-sm pt-4 border-t border-gray-100",children:[e.jsxs("div",{className:"flex items-center space-x-2",children:[e.jsx("div",{className:"w-3 h-3 bg-success rounded-full"}),e.jsxs("span",{children:[o("analytics.highestScore"),": ",h.highestScore,"%"]})]}),e.jsxs("div",{className:"flex items-center space-x-2",children:[e.jsx("div",{className:"w-3 h-3 bg-danger rounded-full"}),e.jsxs("span",{children:[o("analytics.lowestScore"),": ",h.lowestScore,"%"]})]}),e.jsxs("div",{className:"flex items-center space-x-2",children:[e.jsx("div",{className:"w-3 h-3 bg-primary rounded-full"}),e.jsxs("span",{children:[o("analytics.avgScore"),": ",h.avgScore,"%"]})]})]})]}),e.jsx("div",{className:"card overflow-hidden p-0",children:e.jsxs("table",{className:"w-full",children:[e.jsx("thead",{className:"bg-gray-50 border-b border-gray-200",children:e.jsxs("tr",{children:[e.jsx("th",{className:"text-left px-4 py-3 text-sm font-semibold text-gray-700",children:o("table.number")}),e.jsx("th",{className:"text-left px-4 py-3 text-sm font-semibold text-gray-700",children:o("table.name")}),e.jsx("th",{className:"text-left px-4 py-3 text-sm font-semibold text-gray-700",children:o("analytics.score")}),e.jsx("th",{className:"text-left px-4 py-3 text-sm font-semibold text-gray-700",children:o("analytics.submittedAt")}),e.jsx("th",{className:"text-left px-4 py-3 text-sm font-semibold text-gray-700",children:o("analytics.violations")}),e.jsx("th",{className:"text-left px-4 py-3 text-sm font-semibold text-gray-700",children:o("analytics.integrity")}),e.jsx("th",{className:"text-left px-4 py-3 text-sm font-semibold text-gray-700",children:o("table.status")})]})}),e.jsx("tbody",{className:"divide-y divide-gray-100",children:r.map((n,N)=>{var t,l,x;const f=p(n);return e.jsxs("tr",{className:"hover:bg-gray-50",children:[e.jsx("td",{className:"px-4 py-3 text-sm text-gray-500",children:N+1}),e.jsx("td",{className:"px-4 py-3",children:e.jsxs("div",{children:[e.jsx("p",{className:"font-medium text-text-main",children:((t=n.student)==null?void 0:t.full_name)||"N/A"}),e.jsx("p",{className:"text-xs text-gray-500",children:(l=n.student)==null?void 0:l.email})]})}),e.jsxs("td",{className:"px-4 py-3",children:[e.jsxs("span",{className:`font-bold ${n.passed?"text-success":"text-danger"}`,children:[((x=n.percentage)==null?void 0:x.toFixed(1))||0,"%"]}),e.jsxs("span",{className:"text-xs text-gray-500 ml-1",children:["(",n.total_score,"/",n.max_score,")"]})]}),e.jsx("td",{className:"px-4 py-3 text-sm text-gray-600",children:d(n.submitted_at)}),e.jsx("td",{className:"px-4 py-3",children:e.jsxs("div",{className:"flex items-center space-x-2 text-xs",children:[e.jsxs("span",{className:"px-2 py-0.5 bg-warning-50 text-warning-700 rounded",children:["AI: ",n.cheat_count||0]}),e.jsxs("span",{className:"px-2 py-0.5 bg-gray-100 text-gray-600 rounded",children:["Tab: ",n.tab_violations||0]})]})}),e.jsx("td",{className:"px-4 py-3",children:e.jsx("span",{className:`px-2 py-1 rounded-full text-xs font-medium ${f.color}`,children:f.label})}),e.jsx("td",{className:"px-4 py-3",children:e.jsx("span",{className:`badge ${n.status==="submitted"?"badge-success":n.status==="auto_submitted"?"bg-warning-100 text-warning-700":n.status==="in_progress"?"bg-primary-100 text-primary-700":"bg-gray-100 text-gray-600"}`,children:n.status==="submitted"?o("analytics.status.submitted"):n.status==="auto_submitted"?o("analytics.status.autoSubmitted"):n.status==="in_progress"?o("analytics.status.inProgress"):n.status})})]},n.id)})})]})})]}):e.jsxs("div",{className:"text-center py-12 bg-gray-50 rounded-xl",children:[e.jsx(H,{className:"w-16 h-16 mx-auto mb-4 text-gray-300"}),e.jsx("p",{className:"text-gray-500",children:o("analytics.noData")})]}):e.jsxs("div",{className:"text-center py-12 bg-gray-50 rounded-xl",children:[e.jsx(H,{className:"w-16 h-16 mx-auto mb-4 text-gray-300"}),e.jsx("p",{className:"text-gray-500",children:o("analytics.selectExamPrompt")})]})]})}function $e(){const c=new Date().getFullYear(),_=[];for(let o=-5;o<=ue;o++){const s=c+o;_.push(`${s}-${s+1}`)}return _}function Fe({onClose:c,onSuccess:_}){const{user:o}=G(),{t:s}=U(),[a,m]=g.useState(!1),[w,r]=g.useState(0),E=3,h=new Date().getFullYear(),[b,d]=g.useState({name:"",code:"",description:"",semester:"",academic_year:`${h}-${h+1}`}),p=$e(),n=f=>{const{name:t,value:l}=f.target;d(x=>({...x,[t]:l}))},N=async f=>{if(f.preventDefault(),a)return;const t=b.name.trim(),l=b.code.trim();if(!t||!l){u.error(s("validation.enterNameAndCode"));return}if(!Ee(l)){u.error(s("validation.invalidClassCode"));return}if(t.length>100){u.error(s("validation.classNameTooLong"));return}m(!0);const x=async(v=0)=>{var M,j,A,C;try{const F=new Promise((Q,z)=>setTimeout(()=>z(new Error("REQUEST_TIMEOUT")),15e3)),k=L.rpc("create_class",{p_name:t,p_code:l,p_description:((M=b.description)==null?void 0:M.trim())||null,p_semester:b.semester||null,p_academic_year:b.academic_year||null}),{data:T,error:I}=await Promise.race([k,F]);if(I)throw I;if(T&&!T.success){T.error==="duplicate_code"?u.error(s("class.duplicateCode")):T.error==="not_authorized"?u.error(s("class.noPermission")):T.error==="profile_not_found"?u.error(s("error.sessionExpired")):u.error(s("class.createError"));return}u.success(s("class.createSuccess")),_==null||_(T),c()}catch(S){if(console.error("Create class error:",S),S.message==="REQUEST_TIMEOUT"){if(v<E)return r(v+1),u.info(s("error.retrying",{attempt:v+1,max:E})),await new Promise(F=>setTimeout(F,1e3)),x(v+1);u.error(s("error.timeout"))}else S.code==="23505"?u.error(s("class.duplicateCode")):S.code==="42501"||(j=S.message)!=null&&j.includes("permission")?u.error(s("class.noPermission")):(A=S.message)!=null&&A.includes("network")||(C=S.message)!=null&&C.includes("fetch")?u.error(s("error.network")):u.error(s("class.createError"));r(0)}finally{m(!1)}};await x(0)};return e.jsxs("form",{onSubmit:N,className:"space-y-4",children:[e.jsxs("div",{children:[e.jsxs("label",{className:"block text-sm font-medium text-gray-700 mb-1",children:[s("class.name")," ",e.jsx("span",{className:"text-danger",children:"*"})]}),e.jsx("input",{type:"text",name:"name",value:b.name,onChange:n,placeholder:s("class.namePlaceholder"),className:"input"})]}),e.jsxs("div",{children:[e.jsxs("label",{className:"block text-sm font-medium text-gray-700 mb-1",children:[s("class.code")," ",e.jsx("span",{className:"text-danger",children:"*"})]}),e.jsx("input",{type:"text",name:"code",value:b.code,onChange:n,placeholder:s("class.codePlaceholder"),className:"input"})]}),e.jsxs("div",{children:[e.jsx("label",{className:"block text-sm font-medium text-gray-700 mb-1",children:s("class.description")}),e.jsx("textarea",{name:"description",value:b.description,onChange:n,placeholder:s("class.descriptionPlaceholder"),rows:2,className:"input resize-none"})]}),e.jsxs("div",{className:"grid grid-cols-2 gap-4",children:[e.jsxs("div",{children:[e.jsx("label",{className:"block text-sm font-medium text-gray-700 mb-1",children:s("class.semester")}),e.jsxs("select",{name:"semester",value:b.semester,onChange:n,className:"input",children:[e.jsx("option",{value:"",children:s("class.semesterSelect")}),e.jsx("option",{value:"1",children:s("class.semester1")}),e.jsx("option",{value:"2",children:s("class.semester2")}),e.jsx("option",{value:"3",children:s("class.semesterSummer")})]})]}),e.jsxs("div",{children:[e.jsx("label",{className:"block text-sm font-medium text-gray-700 mb-1",children:s("class.year")}),e.jsx("select",{name:"academic_year",value:b.academic_year,onChange:n,className:"input",children:p.map(f=>e.jsx("option",{value:f,children:f},f))})]})]}),e.jsxs("div",{className:"flex items-center justify-end space-x-3 pt-4 border-t border-gray-200",children:[e.jsx("button",{type:"button",onClick:c,className:"btn-secondary",children:s("common.cancel")}),e.jsxs("button",{type:"submit",disabled:a,className:"btn-primary",children:[a?e.jsx(D,{className:"w-5 h-5 mr-2 animate-spin"}):e.jsx(ae,{className:"w-5 h-5 mr-2"}),s("instructor.createClass")]})]})]})}function Be(){const{user:c,profile:_,logout:o}=G(),{t:s}=U(),a=me(),[m,w]=g.useState([]),[r,E]=g.useState(null),[h,b]=g.useState([]),[d,p]=g.useState([]),[n,N]=g.useState({totalStudents:0,totalExams:0,activeExams:0,flaggedSessions:0}),[f,t]=g.useState(!0),[l,x]=g.useState("exams"),[v,M]=g.useState(!1),[j,A]=g.useState(!1),[C,S]=g.useState(!1),[F,k]=g.useState(!1),[T,I]=g.useState(null),[Q,z]=g.useState(""),[J,Ie]=g.useState([]),[Re,Qe]=g.useState(null);g.useEffect(()=>{(async()=>{if(c)try{const{data:y,error:P}=await L.from("classes").select("*").eq("instructor_id",c.id).order("created_at",{ascending:!1});if(P)throw P;w(y||[]),y&&y.length>0&&!r&&E(y[0])}catch(y){console.error("Load classes error:",y)}finally{t(!1)}})()},[c]),g.useEffect(()=>{if(!r)return;(async()=>{try{const{data:y}=await L.from("exams").select("*").eq("class_id",r.id).order("created_at",{ascending:!1});b(y||[]);const{data:P}=await L.from("enrollments").select(`
            *,
            student:profiles(*)
          `).eq("class_id",r.id);p(P||[]);const O=(y||[]).filter(q=>q.status==="published").length;N({totalStudents:(P||[]).length,totalExams:(y||[]).length,activeExams:O,flaggedSessions:0})}catch(y){console.error("Load class data error:",y)}})()},[r]);const le=async()=>{await o(),a("/login")},ie=async i=>{try{const{error:y}=await L.from("exams").update({status:"published"}).eq("id",i);if(y)throw y;b(P=>P.map(O=>O.id===i?{...O,status:"published"}:O)),u.success(s("exam.published"))}catch{u.error(s("error.general"))}},ce=async i=>{if(window.confirm(s("student.removeConfirm")))try{const{error:y}=await L.from("enrollments").delete().eq("id",i);if(y)throw y;p(P=>P.filter(O=>O.id!==i)),u.success(s("student.removeSuccess"))}catch{u.error(s("error.general"))}},oe=i=>new Date(i).toLocaleDateString("vi-VN",{day:"2-digit",month:"2-digit",year:"numeric",hour:"2-digit",minute:"2-digit"}),de=i=>{const y=new Date,P=new Date(i.start_time),O=new Date(i.end_time);return i.status==="draft"?{label:s("exam.status.draft"),color:"bg-gray-100 text-gray-700"}:y<P?{label:s("exam.status.upcoming"),color:"bg-primary-100 text-primary-700"}:y>O?{label:s("exam.status.ended"),color:"bg-gray-100 text-gray-600"}:{label:s("exam.status.active"),color:"bg-success-100 text-success-700"}};return f?e.jsx("div",{className:"min-h-screen bg-background flex items-center justify-center",children:e.jsx(D,{className:"w-8 h-8 animate-spin text-primary"})}):e.jsxs("div",{className:"min-h-screen bg-background",children:[e.jsxs("nav",{className:"bg-paper shadow-sm border-b border-gray-200 px-6 py-4 flex justify-between items-center sticky top-0 z-10",children:[e.jsxs("div",{className:"flex items-center space-x-3",children:[e.jsx("div",{className:"bg-primary p-2 rounded-lg",children:e.jsx(he,{className:"text-white w-6 h-6"})}),e.jsxs("div",{children:[e.jsxs("span",{className:"text-xl font-bold text-text-main tracking-tight",children:["SmartExam",e.jsx("span",{className:"text-primary",children:"Pro"})]}),e.jsx("span",{className:"text-xs text-gray-500 ml-2",children:s("instructor.title")})]})]}),e.jsxs("div",{className:"flex items-center space-x-4",children:[e.jsx(pe,{compact:!0}),e.jsxs("div",{className:"flex items-center space-x-2 text-sm font-medium text-gray-600 bg-gray-100 px-3 py-1.5 rounded-full",children:[e.jsx(_e,{className:"w-4 h-4"}),e.jsx("span",{children:(_==null?void 0:_.full_name)||(c==null?void 0:c.email)})]}),e.jsxs("button",{onClick:le,className:"flex items-center space-x-2 text-danger hover:bg-danger-50 px-4 py-2 rounded-lg transition-colors text-sm font-semibold",children:[e.jsx(ye,{className:"w-4 h-4"}),e.jsx("span",{children:s("auth.logout")})]})]})]}),e.jsxs("div",{className:"flex",children:[e.jsxs("aside",{className:"w-64 bg-paper border-r border-gray-200 min-h-[calc(100vh-65px)] p-4",children:[e.jsxs("div",{className:"flex items-center justify-between mb-4",children:[e.jsx("h2",{className:"font-bold text-gray-700",children:s("instructor.classes")}),e.jsx("button",{onClick:()=>S(!0),className:"p-1.5 hover:bg-primary-50 rounded-lg transition-colors",title:s("instructor.createClass"),children:e.jsx(R,{className:"w-5 h-5 text-primary"})})]}),e.jsxs("div",{className:"space-y-2",children:[m.map(i=>e.jsxs("button",{onClick:()=>E(i),className:`w-full text-left p-3 rounded-xl transition-all ${(r==null?void 0:r.id)===i.id?"bg-primary-50 border-2 border-primary":"bg-gray-50 hover:bg-gray-100 border-2 border-transparent"}`,children:[e.jsx("p",{className:`font-semibold text-sm ${(r==null?void 0:r.id)===i.id?"text-primary":"text-gray-800"}`,children:i.name}),e.jsx("p",{className:"text-xs text-gray-500 mt-0.5",children:i.code})]},i.id)),m.length===0&&e.jsxs("div",{className:"text-center py-8 text-gray-500",children:[e.jsx(B,{className:"w-12 h-12 mx-auto mb-2 opacity-50"}),e.jsx("p",{className:"text-sm",children:s("instructor.noClasses")}),e.jsx("button",{onClick:()=>S(!0),className:"text-primary text-sm mt-2 hover:underline",children:s("instructor.createFirstClass")})]})]})]}),e.jsx("main",{className:"flex-1 p-6",children:r?e.jsxs(e.Fragment,{children:[e.jsxs("div",{className:"mb-6",children:[e.jsx("h1",{className:"text-2xl font-bold text-text-main",children:r.name}),e.jsxs("p",{className:"text-gray-500",children:[s("instructor.classCode"),": ",r.code]})]}),e.jsxs("div",{className:"grid grid-cols-4 gap-4 mb-6",children:[e.jsxs("div",{className:"card flex items-center space-x-4",children:[e.jsx("div",{className:"p-3 bg-primary-100 rounded-xl",children:e.jsx(X,{className:"w-6 h-6 text-primary"})}),e.jsxs("div",{children:[e.jsx("p",{className:"text-2xl font-bold text-text-main",children:n.totalStudents}),e.jsx("p",{className:"text-sm text-gray-500",children:s("stats.students")})]})]}),e.jsxs("div",{className:"card flex items-center space-x-4",children:[e.jsx("div",{className:"p-3 bg-success-100 rounded-xl",children:e.jsx(V,{className:"w-6 h-6 text-success"})}),e.jsxs("div",{children:[e.jsx("p",{className:"text-2xl font-bold text-text-main",children:n.totalExams}),e.jsx("p",{className:"text-sm text-gray-500",children:s("stats.exams")})]})]}),e.jsxs("div",{className:"card flex items-center space-x-4",children:[e.jsx("div",{className:"p-3 bg-warning-100 rounded-xl",children:e.jsx(Ne,{className:"w-6 h-6 text-warning"})}),e.jsxs("div",{children:[e.jsx("p",{className:"text-2xl font-bold text-text-main",children:n.activeExams}),e.jsx("p",{className:"text-sm text-gray-500",children:s("stats.active")})]})]}),e.jsxs("div",{className:"card flex items-center space-x-4",children:[e.jsx("div",{className:"p-3 bg-danger-100 rounded-xl",children:e.jsx(xe,{className:"w-6 h-6 text-danger"})}),e.jsxs("div",{children:[e.jsx("p",{className:"text-2xl font-bold text-text-main",children:n.flaggedSessions}),e.jsx("p",{className:"text-sm text-gray-500",children:s("stats.suspicious")})]})]})]}),e.jsx("div",{className:"flex space-x-1 p-1 bg-gray-100 rounded-xl mb-6 w-fit",children:[{id:"exams",label:s("tabs.exams"),icon:V},{id:"students",label:s("tabs.students"),icon:X},{id:"analytics",label:s("tabs.analytics"),icon:H}].map(i=>e.jsxs("button",{onClick:()=>x(i.id),className:`flex items-center space-x-2 px-4 py-2 rounded-lg text-sm font-medium transition-colors ${l===i.id?"bg-white shadow text-primary":"text-gray-600 hover:text-gray-900"}`,children:[e.jsx(i.icon,{className:"w-4 h-4"}),e.jsx("span",{children:i.label})]},i.id))}),l==="exams"&&e.jsxs("div",{children:[e.jsxs("div",{className:"flex items-center justify-between mb-4",children:[e.jsx("h2",{className:"text-lg font-bold text-text-main",children:s("tabs.exams")}),e.jsxs("button",{onClick:()=>M(!0),className:"btn-primary",children:[e.jsx(R,{className:"w-5 h-5 mr-2"}),s("exam.create")]})]}),h.length>0?e.jsx("div",{className:"space-y-3",children:h.map(i=>{const y=de(i);return e.jsx("div",{className:"card hover:shadow-soft transition-shadow",children:e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsxs("div",{className:"flex-1",children:[e.jsxs("div",{className:"flex items-center space-x-3",children:[e.jsx("h3",{className:"font-semibold text-text-main",children:i.title}),e.jsx("span",{className:`px-2 py-0.5 rounded-full text-xs font-medium ${y.color}`,children:y.label})]}),e.jsxs("div",{className:"flex items-center space-x-4 mt-2 text-sm text-gray-500",children:[e.jsxs("span",{className:"flex items-center space-x-1",children:[e.jsx(te,{className:"w-4 h-4"}),e.jsxs("span",{children:[i.duration_minutes," ",s("exam.minutes")]})]}),e.jsxs("span",{className:"flex items-center space-x-1",children:[e.jsx(ve,{className:"w-4 h-4"}),e.jsx("span",{children:oe(i.start_time)})]})]})]}),e.jsxs("div",{className:"flex items-center space-x-2",children:[i.status==="draft"&&e.jsxs("button",{onClick:()=>ie(i.id),className:"btn-success text-sm",children:[e.jsx(fe,{className:"w-4 h-4 mr-1"}),s("exam.publish")]}),e.jsxs("button",{onClick:()=>{I(i),k(!0)},className:"btn-secondary text-sm",title:s("exam.manageQuestions"),children:[e.jsx(V,{className:"w-4 h-4 mr-1"}),s("exam.manageQuestions")]})]})]})},i.id)})}):e.jsxs("div",{className:"text-center py-12 bg-gray-50 rounded-xl",children:[e.jsx(V,{className:"w-16 h-16 mx-auto mb-4 text-gray-300"}),e.jsx("p",{className:"text-gray-500 mb-4",children:s("exam.noExams")}),e.jsxs("button",{onClick:()=>M(!0),className:"btn-primary",children:[e.jsx(R,{className:"w-5 h-5 mr-2"}),s("exam.createFirst")]})]})]}),l==="students"&&e.jsxs("div",{children:[e.jsxs("div",{className:"flex items-center justify-between mb-4",children:[e.jsx("h2",{className:"text-lg font-bold text-text-main",children:s("tabs.students")}),e.jsxs("button",{onClick:()=>A(!0),className:"btn-primary",children:[e.jsx(R,{className:"w-5 h-5 mr-2"}),s("student.add")]})]}),e.jsxs("div",{className:"relative mb-4",children:[e.jsx(Ce,{className:"absolute left-3 top-1/2 -translate-y-1/2 w-5 h-5 text-gray-400"}),e.jsx("input",{type:"text",placeholder:s("student.searchPlaceholder"),value:Q,onChange:i=>z(i.target.value),className:"input pl-10"})]}),d.length>0?e.jsx("div",{className:"card overflow-hidden p-0",children:e.jsxs("table",{className:"w-full",children:[e.jsx("thead",{className:"bg-gray-50 border-b border-gray-200",children:e.jsxs("tr",{children:[e.jsx("th",{className:"text-left px-4 py-3 text-sm font-semibold text-gray-700",children:s("table.number")}),e.jsx("th",{className:"text-left px-4 py-3 text-sm font-semibold text-gray-700",children:s("table.name")}),e.jsx("th",{className:"text-left px-4 py-3 text-sm font-semibold text-gray-700",children:s("table.email")}),e.jsx("th",{className:"text-left px-4 py-3 text-sm font-semibold text-gray-700",children:s("table.studentId")}),e.jsx("th",{className:"text-left px-4 py-3 text-sm font-semibold text-gray-700",children:s("table.status")}),e.jsx("th",{className:"text-right px-4 py-3 text-sm font-semibold text-gray-700",children:s("table.actions")})]})}),e.jsx("tbody",{className:"divide-y divide-gray-100",children:d.filter(i=>{var P,O,q,K,Z,W;if(!Q)return!0;const y=Q.toLowerCase();return((O=(P=i.student)==null?void 0:P.full_name)==null?void 0:O.toLowerCase().includes(y))||((K=(q=i.student)==null?void 0:q.email)==null?void 0:K.toLowerCase().includes(y))||((W=(Z=i.student)==null?void 0:Z.student_id)==null?void 0:W.toLowerCase().includes(y))}).map((i,y)=>{var P,O,q;return e.jsxs("tr",{className:"hover:bg-gray-50",children:[e.jsx("td",{className:"px-4 py-3 text-sm text-gray-500",children:y+1}),e.jsx("td",{className:"px-4 py-3",children:e.jsxs("div",{className:"flex items-center space-x-3",children:[e.jsx("div",{className:"w-8 h-8 bg-primary-100 rounded-full flex items-center justify-center",children:e.jsx(ge,{className:"w-4 h-4 text-primary"})}),e.jsx("span",{className:"font-medium text-text-main",children:((P=i.student)==null?void 0:P.full_name)||"N/A"})]})}),e.jsx("td",{className:"px-4 py-3 text-sm text-gray-600",children:(O=i.student)==null?void 0:O.email}),e.jsx("td",{className:"px-4 py-3 text-sm text-gray-600",children:((q=i.student)==null?void 0:q.student_id)||"-"}),e.jsx("td",{className:"px-4 py-3",children:e.jsx("span",{className:`badge ${i.status==="active"?"badge-success":"bg-gray-100 text-gray-600"}`,children:i.status==="active"?s("student.statusActive"):i.status})}),e.jsx("td",{className:"px-4 py-3 text-right",children:e.jsx("button",{onClick:()=>ce(i.id),className:"p-2 hover:bg-danger-50 rounded-lg transition-colors text-danger",title:s("student.remove"),children:e.jsx(re,{className:"w-4 h-4"})})})]},i.id)})})]})}):e.jsxs("div",{className:"text-center py-12 bg-gray-50 rounded-xl",children:[e.jsx(X,{className:"w-16 h-16 mx-auto mb-4 text-gray-300"}),e.jsx("p",{className:"text-gray-500 mb-4",children:s("student.noStudents")}),e.jsxs("button",{onClick:()=>A(!0),className:"btn-primary",children:[e.jsx(R,{className:"w-5 h-5 mr-2"}),s("student.add")]})]})]}),l==="analytics"&&e.jsx(Oe,{classId:r==null?void 0:r.id,exams:h})]}):e.jsx("div",{className:"flex items-center justify-center h-[60vh]",children:e.jsxs("div",{className:"text-center",children:[e.jsx(B,{className:"w-20 h-20 mx-auto mb-4 text-gray-300"}),e.jsx("h2",{className:"text-xl font-bold text-gray-700 mb-2",children:s("instructor.welcome")}),e.jsx("p",{className:"text-gray-500 mb-6",children:s("instructor.welcomeDesc")}),e.jsxs("button",{onClick:()=>S(!0),className:"btn-primary",children:[e.jsx(R,{className:"w-5 h-5 mr-2"}),s("instructor.createClass")]})]})})})]}),e.jsx(Y,{isOpen:C,onClose:()=>S(!1),title:s("instructor.createClassTitle"),children:e.jsx(Fe,{onClose:()=>S(!1),onSuccess:i=>{w(y=>[i,...y]),E(i)}})}),e.jsx(Y,{isOpen:v,onClose:()=>M(!1),title:s("instructor.createExamTitle"),children:e.jsx(Te,{classId:r==null?void 0:r.id,onClose:()=>M(!1),onSuccess:i=>{b(y=>[i,...y])}})}),e.jsx(Y,{isOpen:j,onClose:()=>A(!1),title:s("instructor.addStudentTitle"),children:e.jsx(Me,{classId:r==null?void 0:r.id,onClose:()=>A(!1),onSuccess:()=>{r&&L.from("enrollments").select("*, student:profiles(*)").eq("class_id",r.id).then(({data:i})=>p(i||[]))}})}),e.jsx(Y,{isOpen:F,onClose:()=>{k(!1),I(null)},title:s("exam.manageQuestions"),children:T&&e.jsx(Ae,{examId:T.id,examTitle:T.title,onClose:()=>{k(!1),I(null)}})})]})}export{Be as default};
