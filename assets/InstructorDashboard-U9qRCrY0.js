import{c as Y,r as h,j as e,R as ke,T as xe,s as $,u as ne,a as X,b as Ee,B as p,d as Te,A as Pe}from"./index-AjfD_Fg1.js";import{F as Me,L as Ie}from"./LanguageSwitcher-BUqr0F9D.js";import{G as Ae,S as $e,L as De,P as Re,B as Z,U as se,a as ie}from"./ProfileSettings-DzzostsR.js";import{m as H,L as B,U as Le,A as ue}from"./proxy-CLSCGRex.js";import{c as te,b as he,a as le,S as ce,X as pe}from"./FaceVerification-njUiATNO.js";import{B as ae}from"./bot-BIqZE-GS.js";/**
 * @license lucide-react v0.468.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const qe=Y("Activity",[["path",{d:"M22 12h-2.48a2 2 0 0 0-1.93 1.46l-2.35 8.36a.25.25 0 0 1-.48 0L9.24 2.18a.25.25 0 0 0-.48 0l-2.35 8.36A2 2 0 0 1 4.49 12H2",key:"169zse"}]]);/**
 * @license lucide-react v0.468.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const Fe=Y("Calendar",[["path",{d:"M8 2v4",key:"1cmpym"}],["path",{d:"M16 2v4",key:"4m81vk"}],["rect",{width:"18",height:"18",x:"3",y:"4",rx:"2",key:"1hopcy"}],["path",{d:"M3 10h18",key:"8toen8"}]]);/**
 * @license lucide-react v0.468.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const re=Y("ChartColumn",[["path",{d:"M3 3v16a2 2 0 0 0 2 2h16",key:"c24i48"}],["path",{d:"M18 17V9",key:"2bz60n"}],["path",{d:"M13 17V5",key:"1frdt8"}],["path",{d:"M8 17v-3",key:"17ska0"}]]);/**
 * @license lucide-react v0.468.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const W=Y("ClipboardList",[["rect",{width:"8",height:"4",x:"8",y:"2",rx:"1",ry:"1",key:"tgr4d6"}],["path",{d:"M16 4h2a2 2 0 0 1 2 2v14a2 2 0 0 1-2 2H6a2 2 0 0 1-2-2V6a2 2 0 0 1 2-2h2",key:"116196"}],["path",{d:"M12 11h4",key:"1jrz19"}],["path",{d:"M12 16h4",key:"n85exb"}],["path",{d:"M8 11h.01",key:"1dfujw"}],["path",{d:"M8 16h.01",key:"18s6g9"}]]);/**
 * @license lucide-react v0.468.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const ge=Y("Pen",[["path",{d:"M21.174 6.812a1 1 0 0 0-3.986-3.987L3.842 16.174a2 2 0 0 0-.5.83l-1.321 4.352a.5.5 0 0 0 .623.622l4.353-1.32a2 2 0 0 0 .83-.497z",key:"1a8usu"}]]);/**
 * @license lucide-react v0.468.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const Q=Y("Plus",[["path",{d:"M5 12h14",key:"1ays0h"}],["path",{d:"M12 5v14",key:"s699le"}]]);/**
 * @license lucide-react v0.468.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const Oe=Y("Search",[["circle",{cx:"11",cy:"11",r:"8",key:"4ej97u"}],["path",{d:"m21 21-4.3-4.3",key:"1qie3q"}]]);/**
 * @license lucide-react v0.468.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const ye=Y("Trash2",[["path",{d:"M3 6h18",key:"d0wm0j"}],["path",{d:"M19 6v14c0 1-1 2-2 2H7c-1 0-2-1-2-2V6",key:"4alrt4"}],["path",{d:"M8 6V4c0-1 1-2 2-2h4c1 0 2 1 2 2v2",key:"v07s0e"}],["line",{x1:"10",x2:"10",y1:"11",y2:"17",key:"1uufr5"}],["line",{x1:"14",x2:"14",y1:"11",y2:"17",key:"xtxkd"}]]),Ue="https://aiforlife-cq8x.onrender.com";function Qe({sessionId:t,onClose:N}){const[r,s]=h.useState(null),[n,u]=h.useState(!0),[d,a]=h.useState(null),C=async()=>{if(!t){a("No session ID provided"),u(!1);return}u(!0),a(null);try{const{data:{session:m}}=await $.auth.getSession(),E=m==null?void 0:m.access_token;if(!E){a("Authentication required"),u(!1);return}const _=new AbortController,l=setTimeout(()=>_.abort(),3e4);try{const i=await fetch(`${Ue}/api/ai/integrity-report/${t}`,{headers:{Authorization:`Bearer ${E}`},signal:_.signal});if(clearTimeout(l),!i.ok){let A=(await i.json().catch(()=>({}))).error||"Không thể tải báo cáo";throw i.status===404?A="Không tìm thấy phiên thi":i.status===403?A="Bạn không có quyền xem báo cáo này":i.status>=500&&(A="Lỗi máy chủ, vui lòng thử lại sau"),new Error(A)}const v=await i.json();if(v.success&&v.report)s(v.report);else throw new Error("Invalid report data")}catch(i){throw clearTimeout(l),i.name==="AbortError"?new Error("Kết nối tới máy chủ quá lâu. Máy chủ có thể đang khởi động, vui lòng thử lại sau 30 giây."):i.message.includes("Failed to fetch")||i.message.includes("Network")?new Error("Không thể kết nối đến máy chủ. Vui lòng kiểm tra kết nối mạng và thử lại."):i}}catch(m){console.error("[IntegrityReport] Error:",m),a(m.message||"Failed to load integrity report")}finally{u(!1)}};h.useEffect(()=>{C()},[t]);const b=m=>{switch(m){case"low":return{bg:"bg-success-50",border:"border-success-200",text:"text-success",label:"Thấp"};case"medium":return{bg:"bg-warning-50",border:"border-warning-200",text:"text-warning-600",label:"Trung bình"};case"high":return{bg:"bg-orange-50",border:"border-orange-200",text:"text-orange-600",label:"Cao"};case"critical":return{bg:"bg-danger-50",border:"border-danger-200",text:"text-danger",label:"Rất cao"};default:return{bg:"bg-gray-50",border:"border-gray-200",text:"text-gray-600",label:"Chưa xác định"}}},y=m=>m>=90?"text-success":m>=70?"text-warning-600":m>=50?"text-orange-600":"text-danger",x={gaze_away:"Nhìn ra ngoài",tab_switch:"Đổi tab",phone_detected:"Điện thoại",multi_person:"Nhiều người",fullscreen_exit:"Thoát fullscreen",face_not_detected:"Không thấy mặt",material_detected:"Tài liệu",headphones_detected:"Tai nghe",copy_paste_attempt:"Copy/Paste",right_click:"Click phải",keyboard_shortcut:"Phím tắt",ai_alert:"Cảnh báo AI"};if(n)return e.jsx(H.div,{initial:{opacity:0},animate:{opacity:1},className:"bg-paper rounded-xl p-6 shadow-lg max-w-lg w-full",children:e.jsxs("div",{className:"flex items-center justify-center py-8",children:[e.jsx(B,{className:"w-8 h-8 text-primary animate-spin mr-3"}),e.jsx("span",{className:"text-gray-600",children:"Đang phân tích báo cáo..."})]})});if(d)return e.jsx(H.div,{initial:{opacity:0},animate:{opacity:1},className:"bg-paper rounded-xl p-6 shadow-lg max-w-lg w-full",children:e.jsxs("div",{className:"text-center py-8",children:[e.jsx(te,{className:"w-12 h-12 text-danger mx-auto mb-3"}),e.jsx("p",{className:"text-danger font-medium mb-4",children:d}),e.jsxs("div",{className:"flex justify-center space-x-3",children:[e.jsxs("button",{onClick:C,className:"btn-secondary px-4 py-2 flex items-center",children:[e.jsx(ke,{className:"w-4 h-4 mr-2"}),"Thử lại"]}),N&&e.jsx("button",{onClick:N,className:"btn-secondary px-4 py-2",children:"Đóng"})]})]})});if(!r)return null;const g=b(r.riskLevel);return e.jsxs(H.div,{initial:{opacity:0,scale:.95},animate:{opacity:1,scale:1},className:"bg-paper rounded-xl shadow-lg max-w-lg w-full overflow-hidden",children:[e.jsx("div",{className:"bg-primary p-4",children:e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsxs("div",{className:"flex items-center space-x-3",children:[e.jsx("div",{className:"bg-white/20 p-2 rounded-full",children:e.jsx(ae,{className:"w-6 h-6 text-white"})}),e.jsxs("div",{children:[e.jsx("h3",{className:"font-bold text-white",children:"Báo Cáo Độ Tin Cậy AI"}),e.jsx("p",{className:"text-white/80 text-sm",children:"Phân tích bởi AI Proctor"})]})]}),N&&e.jsx("button",{onClick:N,className:"text-white/80 hover:text-white p-1",children:e.jsx(te,{className:"w-5 h-5"})})]})}),e.jsxs("div",{className:"p-6",children:[e.jsxs("div",{className:"flex items-center justify-center space-x-8 mb-6",children:[e.jsxs("div",{className:"relative",children:[e.jsxs("svg",{className:"w-32 h-32",children:[e.jsx("circle",{cx:"64",cy:"64",r:"56",fill:"none",stroke:"#e5e7eb",strokeWidth:"8"}),e.jsx("circle",{cx:"64",cy:"64",r:"56",fill:"none",stroke:r.score>=70?"#22c55e":r.score>=50?"#f59e0b":"#ef4444",strokeWidth:"8",strokeLinecap:"round",strokeDasharray:`${r.score/100*352} 352`,transform:"rotate(-90 64 64)"})]}),e.jsxs("div",{className:"absolute inset-0 flex flex-col items-center justify-center",children:[e.jsx("span",{className:`text-3xl font-bold ${y(r.score)}`,children:r.score}),e.jsx("span",{className:"text-xs text-gray-500",children:"/100"})]})]}),e.jsxs("div",{className:"text-center",children:[e.jsx("p",{className:"text-sm text-gray-500 mb-2",children:"Mức độ rủi ro"}),e.jsx("span",{className:`inline-block px-4 py-2 rounded-full font-bold ${g.bg} ${g.border} border ${g.text}`,children:g.label})]})]}),e.jsx("div",{className:"bg-primary-50 rounded-lg p-4 mb-6",children:e.jsxs("div",{className:"flex items-start space-x-3",children:[e.jsx(ae,{className:"w-5 h-5 text-primary mt-0.5 flex-shrink-0"}),e.jsxs("div",{children:[e.jsx("p",{className:"font-medium text-primary-800 mb-1",children:"Nhận xét AI"}),e.jsx("p",{className:"text-sm text-primary-700",children:r.explanation})]})]})}),r.eventSummary&&Object.keys(r.eventSummary).length>0&&e.jsxs("div",{children:[e.jsxs("h4",{className:"font-medium text-gray-900 mb-3 flex items-center",children:[e.jsx(xe,{className:"w-4 h-4 mr-2 text-warning"}),"Tổng hợp vi phạm (",r.totalEvents," sự kiện)"]}),e.jsx("div",{className:"grid grid-cols-2 gap-2",children:Object.entries(r.eventSummary).map(([m,E])=>e.jsxs("div",{className:"flex items-center justify-between bg-gray-50 rounded-lg px-3 py-2",children:[e.jsx("span",{className:"text-sm text-gray-700",children:x[m]||m}),e.jsx("span",{className:"font-bold text-gray-900",children:E})]},m))}),r.criticalEvents>0&&e.jsxs("p",{className:"text-xs text-danger mt-2 flex items-center",children:[e.jsx(te,{className:"w-3 h-3 mr-1"}),r.criticalEvents," sự kiện nghiêm trọng"]})]}),(!r.eventSummary||Object.keys(r.eventSummary).length===0)&&e.jsxs("div",{className:"text-center py-4",children:[e.jsx(he,{className:"w-12 h-12 text-success mx-auto mb-2"}),e.jsx("p",{className:"text-success font-medium",children:"Không có vi phạm được ghi nhận"})]})]})]})}const ze=/^[^\s@]+@[^\s@]+\.[^\s@]+$/;function Ve(t){return ze.test(t)}function Be(t){return/^[A-Za-z0-9-_]+$/.test(t)}function ee(t){return t?new Date(t).toISOString():null}function de(t){if(!t)return"";const N=new Date(t),r=N.getFullYear(),s=String(N.getMonth()+1).padStart(2,"0"),n=String(N.getDate()).padStart(2,"0"),u=String(N.getHours()).padStart(2,"0"),d=String(N.getMinutes()).padStart(2,"0");return`${r}-${s}-${n}T${u}:${d}`}function G({isOpen:t,onClose:N,title:r,children:s}){return t?e.jsx(ue,{children:e.jsx(H.div,{initial:{opacity:0},animate:{opacity:1},exit:{opacity:0},className:"fixed inset-0 bg-black/50 z-50 flex items-center justify-center p-4",onClick:N,children:e.jsxs(H.div,{initial:{scale:.95,opacity:0},animate:{scale:1,opacity:1},exit:{scale:.95,opacity:0},className:"bg-paper rounded-2xl shadow-soft max-w-2xl w-full max-h-[90vh] overflow-hidden",onClick:n=>n.stopPropagation(),children:[e.jsxs("div",{className:"flex items-center justify-between p-6 border-b border-gray-200",children:[e.jsx("h2",{className:"text-xl font-bold text-text-main",children:r}),e.jsx("button",{onClick:N,className:"p-2 hover:bg-gray-100 rounded-lg transition-colors",children:e.jsx(pe,{className:"w-5 h-5 text-gray-500"})})]}),e.jsx("div",{className:"p-6 overflow-y-auto max-h-[calc(90vh-150px)]",children:s})]})})}):null}function Ye({classId:t,onClose:N,onSuccess:r}){const{user:s}=ne(),{t:n}=X(),[u,d]=h.useState(!1),[a,C]=h.useState({title:"",description:"",duration_minutes:60,start_time:"",end_time:"",is_shuffled:!0,show_result_immediately:!1,allow_review:!1,passing_score:50,max_attempts:1,require_camera:!0,require_fullscreen:!0,max_tab_violations:3,max_fullscreen_violations:3}),b=x=>{const{name:g,value:m,type:E,checked:_}=x.target;C(l=>({...l,[g]:E==="checkbox"?_:m}))},y=async x=>{if(x.preventDefault(),u)return;const g=a.title.trim();if(!g){p.error(n("validation.enterExamTitle"));return}if(g.length>200){p.error(n("validation.examTitleTooLong"));return}if(!a.start_time||!a.end_time){p.error(n("validation.selectTime"));return}const m=new Date(a.start_time);if(new Date(a.end_time)<=m){p.error(n("validation.endAfterStart"));return}const _=parseInt(a.duration_minutes);if(isNaN(_)||_<5||_>480){p.error(n("validation.durationRange"));return}d(!0);const l=async(i=0)=>{var A,D,o,f,M,w;try{const j=new Promise((S,q)=>setTimeout(()=>q(new Error("REQUEST_TIMEOUT")),3e4)),I=$.from("exams").insert({title:g,description:((A=a.description)==null?void 0:A.trim())||null,duration_minutes:_,start_time:ee(a.start_time),end_time:ee(a.end_time),is_shuffled:a.is_shuffled,show_result_immediately:a.show_result_immediately,allow_review:a.allow_review,passing_score:parseFloat(a.passing_score)||50,max_attempts:parseInt(a.max_attempts)||1,require_camera:a.require_camera,require_fullscreen:a.require_fullscreen,max_tab_violations:parseInt(a.max_tab_violations)||3,max_fullscreen_violations:parseInt(a.max_fullscreen_violations)||3,class_id:t,created_by:s.id,status:"draft"}).select().single(),{data:L,error:R}=await Promise.race([I,j]);if(R)throw R;p.success(n("exam.createSuccess")),r==null||r(L),N()}catch(j){if(console.error("Create exam error:",j),console.error("Error details:",{code:j.code,message:j.message,details:j.details,hint:j.hint}),j.message==="REQUEST_TIMEOUT"){if(i<3)return p.info(n("error.retrying",{attempt:i+1,max:3})),await new Promise(I=>setTimeout(I,1e3)),l(i+1);p.error(n("error.timeout"))}else j.code==="42501"||(D=j.message)!=null&&D.includes("permission")||(o=j.message)!=null&&o.includes("denied")?p.error(n("error.permission")):(f=j.message)!=null&&f.includes("network")||(M=j.message)!=null&&M.includes("fetch")||(w=j.message)!=null&&w.includes("Failed to fetch")?p.error(n("error.network")):j.code==="23503"?p.error(n("exam.createError")):p.error(n("exam.createError"))}finally{d(!1)}};await l(0)};return e.jsxs("form",{onSubmit:y,className:"space-y-6",children:[e.jsxs("div",{className:"space-y-4",children:[e.jsxs("h3",{className:"font-semibold text-gray-900 flex items-center space-x-2",children:[e.jsx(Z,{className:"w-5 h-5 text-primary"}),e.jsx("span",{children:n("exam.basicInfo")})]}),e.jsxs("div",{children:[e.jsxs("label",{className:"block text-sm font-medium text-gray-700 mb-1",children:[n("exam.title")," ",e.jsx("span",{className:"text-danger",children:"*"})]}),e.jsx("input",{type:"text",name:"title",value:a.title,onChange:b,placeholder:n("exam.titlePlaceholder"),className:"input"})]}),e.jsxs("div",{children:[e.jsx("label",{className:"block text-sm font-medium text-gray-700 mb-1",children:n("exam.description")}),e.jsx("textarea",{name:"description",value:a.description,onChange:b,placeholder:n("exam.descriptionPlaceholder"),rows:3,className:"input resize-none"})]}),e.jsxs("div",{className:"grid grid-cols-2 gap-4",children:[e.jsxs("div",{children:[e.jsx("label",{className:"block text-sm font-medium text-gray-700 mb-1",children:n("exam.durationMinutes")}),e.jsx("input",{type:"number",name:"duration_minutes",value:a.duration_minutes,onChange:b,min:5,max:300,className:"input"})]}),e.jsxs("div",{children:[e.jsx("label",{className:"block text-sm font-medium text-gray-700 mb-1",children:n("exam.passingScore")}),e.jsx("input",{type:"number",name:"passing_score",value:a.passing_score,onChange:b,min:0,max:100,className:"input"})]})]})]}),e.jsxs("div",{className:"space-y-4",children:[e.jsxs("h3",{className:"font-semibold text-gray-900 flex items-center space-x-2",children:[e.jsx(le,{className:"w-5 h-5 text-primary"}),e.jsx("span",{children:n("exam.timeSettings")})]}),e.jsxs("div",{className:"grid grid-cols-2 gap-4",children:[e.jsxs("div",{children:[e.jsxs("label",{className:"block text-sm font-medium text-gray-700 mb-1",children:[n("exam.startTime")," ",e.jsx("span",{className:"text-danger",children:"*"})]}),e.jsx("input",{type:"datetime-local",name:"start_time",value:a.start_time,onChange:b,className:"input"})]}),e.jsxs("div",{children:[e.jsxs("label",{className:"block text-sm font-medium text-gray-700 mb-1",children:[n("exam.endTime")," ",e.jsx("span",{className:"text-danger",children:"*"})]}),e.jsx("input",{type:"datetime-local",name:"end_time",value:a.end_time,onChange:b,className:"input"})]})]})]}),e.jsxs("div",{className:"space-y-4",children:[e.jsxs("h3",{className:"font-semibold text-gray-900 flex items-center space-x-2",children:[e.jsx(ce,{className:"w-5 h-5 text-primary"}),e.jsx("span",{children:n("exam.antiCheatSettings")})]}),e.jsxs("div",{className:"grid grid-cols-2 gap-4",children:[e.jsxs("label",{className:"flex items-center space-x-3 p-3 bg-gray-50 rounded-lg cursor-pointer hover:bg-gray-100 transition-colors",children:[e.jsx("input",{type:"checkbox",name:"require_camera",checked:a.require_camera,onChange:b,className:"w-5 h-5 text-primary rounded"}),e.jsx("span",{className:"text-sm text-gray-700",children:n("exam.requireCamera")})]}),e.jsxs("label",{className:"flex items-center space-x-3 p-3 bg-gray-50 rounded-lg cursor-pointer hover:bg-gray-100 transition-colors",children:[e.jsx("input",{type:"checkbox",name:"require_fullscreen",checked:a.require_fullscreen,onChange:b,className:"w-5 h-5 text-primary rounded"}),e.jsx("span",{className:"text-sm text-gray-700",children:n("exam.requireFullscreen")})]}),e.jsxs("label",{className:"flex items-center space-x-3 p-3 bg-gray-50 rounded-lg cursor-pointer hover:bg-gray-100 transition-colors",children:[e.jsx("input",{type:"checkbox",name:"is_shuffled",checked:a.is_shuffled,onChange:b,className:"w-5 h-5 text-primary rounded"}),e.jsx("span",{className:"text-sm text-gray-700",children:n("exam.shuffleQuestions")})]}),e.jsxs("label",{className:"flex items-center space-x-3 p-3 bg-gray-50 rounded-lg cursor-pointer hover:bg-gray-100 transition-colors",children:[e.jsx("input",{type:"checkbox",name:"show_result_immediately",checked:a.show_result_immediately,onChange:b,className:"w-5 h-5 text-primary rounded"}),e.jsx("span",{className:"text-sm text-gray-700",children:n("exam.showResultImmediately")})]})]}),e.jsxs("div",{className:"grid grid-cols-2 gap-4",children:[e.jsxs("div",{children:[e.jsx("label",{className:"block text-sm font-medium text-gray-700 mb-1",children:n("exam.maxTabViolations")}),e.jsx("input",{type:"number",name:"max_tab_violations",value:a.max_tab_violations,onChange:b,min:0,max:10,className:"input"})]}),e.jsxs("div",{children:[e.jsx("label",{className:"block text-sm font-medium text-gray-700 mb-1",children:n("exam.maxFullscreenViolations")}),e.jsx("input",{type:"number",name:"max_fullscreen_violations",value:a.max_fullscreen_violations,onChange:b,min:0,max:10,className:"input"})]})]})]}),e.jsxs("div",{className:"flex items-center justify-end space-x-3 pt-4 border-t border-gray-200",children:[e.jsx("button",{type:"button",onClick:N,className:"btn-secondary",children:n("common.cancel")}),e.jsxs("button",{type:"submit",disabled:u,className:"btn-primary",children:[u?e.jsx(B,{className:"w-5 h-5 mr-2 animate-spin"}):e.jsx(ie,{className:"w-5 h-5 mr-2"}),n("exam.create")]})]})]})}function Xe({exam:t,onClose:N,onSuccess:r}){const{t:s}=X(),[n,u]=h.useState(!1),[d,a]=h.useState({title:(t==null?void 0:t.title)||"",description:(t==null?void 0:t.description)||"",duration_minutes:(t==null?void 0:t.duration_minutes)||60,start_time:de(t==null?void 0:t.start_time)||"",end_time:de(t==null?void 0:t.end_time)||"",is_shuffled:(t==null?void 0:t.is_shuffled)??!0,show_result_immediately:(t==null?void 0:t.show_result_immediately)??!1,allow_review:(t==null?void 0:t.allow_review)??!1,passing_score:(t==null?void 0:t.passing_score)||50,max_attempts:(t==null?void 0:t.max_attempts)||1,require_camera:(t==null?void 0:t.require_camera)??!0,require_fullscreen:(t==null?void 0:t.require_fullscreen)??!0,max_tab_violations:(t==null?void 0:t.max_tab_violations)||3,max_fullscreen_violations:(t==null?void 0:t.max_fullscreen_violations)||3}),C=y=>{const{name:x,value:g,type:m,checked:E}=y.target;a(_=>({..._,[x]:m==="checkbox"?E:g}))},b=async y=>{var E,_;y.preventDefault();const x=(E=d.title)==null?void 0:E.trim();if(!x){p.error(s("validation.examTitleRequired"));return}if(!d.start_time||!d.end_time){p.error(s("validation.selectTime"));return}const g=new Date(d.start_time);if(new Date(d.end_time)<=g){p.error(s("validation.endAfterStart"));return}u(!0);try{const{data:l,error:i}=await $.from("exams").update({title:x,description:((_=d.description)==null?void 0:_.trim())||null,duration_minutes:parseInt(d.duration_minutes)||60,start_time:ee(d.start_time),end_time:ee(d.end_time),is_shuffled:d.is_shuffled,show_result_immediately:d.show_result_immediately,allow_review:d.allow_review,passing_score:parseFloat(d.passing_score)||50,max_attempts:parseInt(d.max_attempts)||1,require_camera:d.require_camera,require_fullscreen:d.require_fullscreen,max_tab_violations:parseInt(d.max_tab_violations)||3,max_fullscreen_violations:parseInt(d.max_fullscreen_violations)||3}).eq("id",t.id).select().single();if(i)throw i;p.success(s("exam.updateSuccess")),r==null||r(l),N()}catch(l){console.error("Update exam error:",l),p.error(s("exam.updateError"))}finally{u(!1)}};return e.jsxs("form",{onSubmit:b,className:"space-y-6",children:[e.jsxs("div",{className:"space-y-4",children:[e.jsxs("h3",{className:"font-semibold text-gray-900 flex items-center space-x-2",children:[e.jsx(Z,{className:"w-5 h-5 text-primary"}),e.jsx("span",{children:s("exam.basicInfo")})]}),e.jsxs("div",{children:[e.jsxs("label",{className:"block text-sm font-medium text-gray-700 mb-1",children:[s("exam.title")," ",e.jsx("span",{className:"text-danger",children:"*"})]}),e.jsx("input",{type:"text",name:"title",value:d.title,onChange:C,placeholder:s("exam.titlePlaceholder"),className:"input"})]}),e.jsxs("div",{children:[e.jsx("label",{className:"block text-sm font-medium text-gray-700 mb-1",children:s("exam.description")}),e.jsx("textarea",{name:"description",value:d.description,onChange:C,placeholder:s("exam.descriptionPlaceholder"),rows:3,className:"input resize-none"})]}),e.jsxs("div",{className:"grid grid-cols-2 gap-4",children:[e.jsxs("div",{children:[e.jsx("label",{className:"block text-sm font-medium text-gray-700 mb-1",children:s("exam.durationMinutes")}),e.jsx("input",{type:"number",name:"duration_minutes",value:d.duration_minutes,onChange:C,min:5,max:300,className:"input"})]}),e.jsxs("div",{children:[e.jsx("label",{className:"block text-sm font-medium text-gray-700 mb-1",children:s("exam.passingScore")}),e.jsx("input",{type:"number",name:"passing_score",value:d.passing_score,onChange:C,min:0,max:100,className:"input"})]})]})]}),e.jsxs("div",{className:"space-y-4",children:[e.jsxs("h3",{className:"font-semibold text-gray-900 flex items-center space-x-2",children:[e.jsx(le,{className:"w-5 h-5 text-primary"}),e.jsx("span",{children:s("exam.timeSettings")})]}),e.jsxs("div",{className:"grid grid-cols-2 gap-4",children:[e.jsxs("div",{children:[e.jsxs("label",{className:"block text-sm font-medium text-gray-700 mb-1",children:[s("exam.startTime")," ",e.jsx("span",{className:"text-danger",children:"*"})]}),e.jsx("input",{type:"datetime-local",name:"start_time",value:d.start_time,onChange:C,className:"input"})]}),e.jsxs("div",{children:[e.jsxs("label",{className:"block text-sm font-medium text-gray-700 mb-1",children:[s("exam.endTime")," ",e.jsx("span",{className:"text-danger",children:"*"})]}),e.jsx("input",{type:"datetime-local",name:"end_time",value:d.end_time,onChange:C,className:"input"})]})]})]}),e.jsxs("div",{className:"space-y-4",children:[e.jsxs("h3",{className:"font-semibold text-gray-900 flex items-center space-x-2",children:[e.jsx(ce,{className:"w-5 h-5 text-primary"}),e.jsx("span",{children:s("exam.antiCheatSettings")})]}),e.jsxs("div",{className:"grid grid-cols-2 gap-4",children:[e.jsxs("label",{className:"flex items-center space-x-3 p-3 bg-gray-50 rounded-lg cursor-pointer hover:bg-gray-100 transition-colors",children:[e.jsx("input",{type:"checkbox",name:"require_camera",checked:d.require_camera,onChange:C,className:"w-5 h-5 text-primary rounded"}),e.jsx("span",{className:"text-sm text-gray-700",children:s("exam.requireCamera")})]}),e.jsxs("label",{className:"flex items-center space-x-3 p-3 bg-gray-50 rounded-lg cursor-pointer hover:bg-gray-100 transition-colors",children:[e.jsx("input",{type:"checkbox",name:"require_fullscreen",checked:d.require_fullscreen,onChange:C,className:"w-5 h-5 text-primary rounded"}),e.jsx("span",{className:"text-sm text-gray-700",children:s("exam.requireFullscreen")})]}),e.jsxs("label",{className:"flex items-center space-x-3 p-3 bg-gray-50 rounded-lg cursor-pointer hover:bg-gray-100 transition-colors",children:[e.jsx("input",{type:"checkbox",name:"is_shuffled",checked:d.is_shuffled,onChange:C,className:"w-5 h-5 text-primary rounded"}),e.jsx("span",{className:"text-sm text-gray-700",children:s("exam.shuffleQuestions")})]}),e.jsxs("label",{className:"flex items-center space-x-3 p-3 bg-gray-50 rounded-lg cursor-pointer hover:bg-gray-100 transition-colors",children:[e.jsx("input",{type:"checkbox",name:"show_result_immediately",checked:d.show_result_immediately,onChange:C,className:"w-5 h-5 text-primary rounded"}),e.jsx("span",{className:"text-sm text-gray-700",children:s("exam.showResultImmediately")})]})]})]}),e.jsxs("div",{className:"flex items-center justify-end space-x-3 pt-4 border-t border-gray-200",children:[e.jsx("button",{type:"button",onClick:N,className:"btn-secondary",children:s("common.cancel")}),e.jsxs("button",{type:"submit",disabled:n,className:"btn-primary",children:[n?e.jsx(B,{className:"w-5 h-5 mr-2 animate-spin"}):e.jsx(ie,{className:"w-5 h-5 mr-2"}),s("exam.update")]})]})]})}function Ke({classId:t,onClose:N,onSuccess:r}){const{t:s}=X(),[n,u]=h.useState(!1),[d,a]=h.useState(""),[C,b]=h.useState(""),[y,x]=h.useState("single"),g=async l=>{try{const{data:i,error:v}=await $.rpc("add_student_to_class",{p_class_id:t,p_student_email:l.toLowerCase().trim()});return v?(console.error("RPC add_student_to_class error:",v),{success:!1,error:"rpc_failed"}):i&&i.success?{success:!0,student_id:i.student_id}:{success:!1,error:(i==null?void 0:i.error)||"unknown_error"}}catch(i){return console.error("RPC call exception:",i),{success:!1,error:"rpc_exception"}}},m=async l=>{const{data:i,error:v}=await $.from("profiles").select("id, role").eq("email",l.toLowerCase().trim()).single();if(v)return v.code==="PGRST116"?{success:!1,error:"student_not_found"}:(console.error("Profile lookup error:",v),{success:!1,error:"lookup_failed"});if(!i)return{success:!1,error:"student_not_found"};const{error:T}=await $.from("enrollments").insert({class_id:t,student_id:i.id,status:"active"});return T?T.code==="23505"?{success:!1,error:"already_enrolled"}:(console.error("Enroll error:",T),{success:!1,error:"enroll_failed"}):{success:!0}},E=async l=>{const i=await g(l);return i.success?i:i.error==="rpc_failed"||i.error==="rpc_exception"?(console.log("RPC not available, falling back to direct method"),m(l)):i},_=async l=>{if(l.preventDefault(),n)return;const i=y==="single"?[d.trim()]:C.split(`
`).map(f=>f.trim()).filter(f=>f);if(i.length===0){p.error(s("validation.enterStudentEmail"));return}if(i.length>100){p.error(s("validation.maxEmails"));return}const v=i.filter(f=>!Ve(f));if(v.length>0){p.error(s("validation.invalidEmails",{emails:v.slice(0,3).join(", ")+(v.length>3?"...":"")}));return}u(!0);let T=0,A=0;const D=[],o=15e3;for(const f of i)try{const M=new Promise((I,L)=>setTimeout(()=>L(new Error("REQUEST_TIMEOUT")),o)),w=E(f),j=await Promise.race([w,M]);if(j.success)T++;else{const I=j.error;I==="student_not_found"?D.push(`${f}: ${s("student.notRegistered")}`):I==="already_enrolled"?D.push(`${f}: ${s("student.alreadyInClass")}`):I==="class_not_found"?D.push(`${f}: ${s("error.classNotFound")}`):I==="not_authorized"?D.push(`${f}: ${s("error.permission")}`):D.push(`${f}: ${s("student.addError")}`),A++}}catch(M){console.error("Add student error:",M),M.message==="REQUEST_TIMEOUT"?D.push(`${f}: ${s("error.timeout")}`):D.push(`${f}: ${s("error.network")}`),A++}if(u(!1),T>0&&(p.success(s("student.addSuccess",{count:T})),r==null||r()),A>0){const f=D.slice(0,3).join(`
`),M=D.length>3?`
... ${D.length-3} ${s("common.more")}`:"";p.warning(`${f}${M}`,{autoClose:8e3})}T>0&&A===0&&N()};return e.jsxs("form",{onSubmit:_,className:"space-y-6",children:[e.jsxs("div",{className:"flex space-x-2 p-1 bg-gray-100 rounded-lg",children:[e.jsx("button",{type:"button",onClick:()=>x("single"),className:`flex-1 py-2 px-4 rounded-md text-sm font-medium transition-colors ${y==="single"?"bg-white shadow text-primary":"text-gray-600 hover:text-gray-900"}`,children:s("student.addSingle")}),e.jsx("button",{type:"button",onClick:()=>x("bulk"),className:`flex-1 py-2 px-4 rounded-md text-sm font-medium transition-colors ${y==="bulk"?"bg-white shadow text-primary":"text-gray-600 hover:text-gray-900"}`,children:s("student.addBulk")})]}),y==="single"?e.jsxs("div",{children:[e.jsx("label",{className:"block text-sm font-medium text-gray-700 mb-1",children:s("student.email")}),e.jsx("input",{type:"email",value:d,onChange:l=>a(l.target.value),placeholder:"student@example.com",className:"input"}),e.jsx("p",{className:"text-xs text-gray-500 mt-1",children:s("student.emailNote")})]}):e.jsxs("div",{children:[e.jsx("label",{className:"block text-sm font-medium text-gray-700 mb-1",children:s("student.emailList")}),e.jsx("textarea",{value:C,onChange:l=>b(l.target.value),placeholder:`student1@example.com
student2@example.com
student3@example.com`,rows:8,className:"input resize-none font-mono text-sm"})]}),e.jsxs("div",{className:"flex items-center justify-end space-x-3 pt-4 border-t border-gray-200",children:[e.jsx("button",{type:"button",onClick:N,className:"btn-secondary",children:s("common.cancel")}),e.jsxs("button",{type:"submit",disabled:n,className:"btn-primary",children:[n?e.jsx(B,{className:"w-5 h-5 mr-2 animate-spin"}):e.jsx(Q,{className:"w-5 h-5 mr-2"}),s("student.add")]})]})]})}function Je({examId:t,examTitle:N,onClose:r}){const{t:s}=X(),[n,u]=h.useState(!0),[d,a]=h.useState(!1),[C,b]=h.useState([]),[y,x]=h.useState(null),[g,m]=h.useState(!1);h.useEffect(()=>{(async()=>{try{const{data:i,error:v}=await $.from("questions").select("*").eq("exam_id",t).order("order_index");if(v)throw v;b(i||[])}catch(i){console.error("Load questions error:",i),p.error(s("error.general"))}finally{u(!1)}})()},[t,s]);const E=async l=>{if(window.confirm(s("question.deleteConfirm")))try{const{error:i}=await $.from("questions").delete().eq("id",l);if(i)throw i;b(v=>v.filter(T=>T.id!==l)),p.success(s("common.success"))}catch{p.error(s("error.general"))}},_=async l=>{a(!0);try{if(y){const{error:i}=await $.from("questions").update({question_text:l.question_text,question_type:l.question_type,options:l.options,correct_answer:l.correct_answer,points:l.points,difficulty:l.difficulty,explanation:l.explanation}).eq("id",y.id);if(i)throw i;b(v=>v.map(T=>T.id===y.id?{...T,...l}:T))}else{const{data:i,error:v}=await $.from("questions").insert({exam_id:t,question_text:l.question_text,question_type:l.question_type,options:l.options,correct_answer:l.correct_answer,points:l.points,difficulty:l.difficulty,explanation:l.explanation,order_index:C.length}).select().single();if(v)throw v;b(T=>[...T,i])}p.success(s("question.saveSuccess")),x(null),m(!1)}catch(i){console.error("Save question error:",i),p.error(s("question.saveError"))}finally{a(!1)}};return n?e.jsx("div",{className:"flex items-center justify-center p-12",children:e.jsx(B,{className:"w-8 h-8 animate-spin text-primary"})}):e.jsxs("div",{className:"space-y-6",children:[e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsxs("div",{children:[e.jsx("h3",{className:"font-semibold text-gray-900",children:N}),e.jsx("p",{className:"text-sm text-gray-500",children:s("exam.questionsCount",{count:C.length})})]}),e.jsxs("button",{onClick:()=>{x(null),m(!0)},className:"btn-primary",children:[e.jsx(Q,{className:"w-5 h-5 mr-2"}),s("question.add")]})]}),(g||y)&&e.jsx(Ge,{question:y,onSave:_,onCancel:()=>{x(null),m(!1)},saving:d}),C.length>0?e.jsx("div",{className:"space-y-3",children:C.map((l,i)=>e.jsx("div",{className:"p-4 border border-gray-200 rounded-lg hover:border-primary-300 transition-colors",children:e.jsxs("div",{className:"flex items-start justify-between",children:[e.jsxs("div",{className:"flex-1",children:[e.jsxs("div",{className:"flex items-center space-x-2 mb-2",children:[e.jsx("span",{className:"w-6 h-6 bg-primary-100 text-primary text-sm font-bold rounded-full flex items-center justify-center",children:i+1}),e.jsx("span",{className:"text-xs px-2 py-0.5 bg-gray-100 text-gray-600 rounded",children:l.question_type==="multiple_choice"?s("question.multipleChoice"):l.question_type==="true_false"?s("question.trueFalse"):l.question_type==="short_answer"?s("question.shortAnswer"):s("question.essay")}),e.jsxs("span",{className:"text-xs text-gray-500",children:[l.points," ",s("exam.points")]})]}),e.jsx("p",{className:"text-gray-800",children:l.question_text}),l.options&&l.options.length>0&&e.jsx("div",{className:"mt-2 space-y-1",children:l.options.map((v,T)=>e.jsxs("div",{className:`text-sm px-2 py-1 rounded ${JSON.stringify(l.correct_answer)===JSON.stringify(v.id)?"bg-success-50 text-success-700":"text-gray-600"}`,children:[v.id,". ",v.text,JSON.stringify(l.correct_answer)===JSON.stringify(v.id)&&" ✓"]},v.id||T))})]}),e.jsxs("div",{className:"flex items-center space-x-1 ml-4",children:[e.jsx("button",{onClick:()=>{x(l),m(!1)},className:"p-2 hover:bg-gray-100 rounded-lg transition-colors",title:s("question.edit"),children:e.jsx(ge,{className:"w-4 h-4 text-gray-500"})}),e.jsx("button",{onClick:()=>E(l.id),className:"p-2 hover:bg-danger-50 rounded-lg transition-colors",title:s("question.delete"),children:e.jsx(ye,{className:"w-4 h-4 text-danger"})})]})]})},l.id))}):!g&&e.jsxs("div",{className:"text-center py-12 bg-gray-50 rounded-xl",children:[e.jsx(W,{className:"w-16 h-16 mx-auto mb-4 text-gray-300"}),e.jsx("p",{className:"text-gray-500 mb-2",children:s("question.noQuestions")}),e.jsx("p",{className:"text-sm text-gray-400 mb-4",children:s("question.noQuestionsDesc")}),e.jsxs("button",{onClick:()=>{x(null),m(!0)},className:"btn-primary",children:[e.jsx(Q,{className:"w-5 h-5 mr-2"}),s("question.add")]})]}),e.jsx("div",{className:"flex justify-end pt-4 border-t border-gray-200",children:e.jsx("button",{onClick:r,className:"btn-secondary",children:s("common.close")})})]})}const me=2,He=6;function Ge({question:t,onSave:N,onCancel:r,saving:s}){const{t:n}=X(),[u,d]=h.useState({question_text:(t==null?void 0:t.question_text)||"",question_type:(t==null?void 0:t.question_type)||"multiple_choice",options:(t==null?void 0:t.options)||[{id:"A",text:""},{id:"B",text:""},{id:"C",text:""},{id:"D",text:""}],correct_answer:(t==null?void 0:t.correct_answer)||"A",points:(t==null?void 0:t.points)||1,difficulty:(t==null?void 0:t.difficulty)||"medium",explanation:(t==null?void 0:t.explanation)||""}),a=x=>{if(x.preventDefault(),!u.question_text.trim()){p.error(n("validation.required"));return}N(u)},C=(x,g)=>{const m=[...u.options];m[x]={...m[x],text:g},d(E=>({...E,options:m}))},b=()=>{const x=String.fromCharCode(65+u.options.length);d(g=>({...g,options:[...g.options,{id:x,text:""}]}))},y=x=>{if(u.options.length<=me)return;const m=u.options.filter((E,_)=>_!==x).map((E,_)=>({...E,id:String.fromCharCode(65+_)}));d(E=>{var _;return{...E,options:m,correct_answer:((_=m[0])==null?void 0:_.id)||"A"}})};return e.jsxs("form",{onSubmit:a,className:"p-4 bg-gray-50 rounded-xl space-y-4",children:[e.jsxs("div",{children:[e.jsxs("label",{className:"block text-sm font-medium text-gray-700 mb-1",children:[n("question.text")," ",e.jsx("span",{className:"text-danger",children:"*"})]}),e.jsx("textarea",{value:u.question_text,onChange:x=>d(g=>({...g,question_text:x.target.value})),placeholder:n("question.textPlaceholder"),rows:3,className:"input resize-none"})]}),e.jsxs("div",{className:"grid grid-cols-3 gap-4",children:[e.jsxs("div",{children:[e.jsx("label",{className:"block text-sm font-medium text-gray-700 mb-1",children:n("question.type")}),e.jsxs("select",{value:u.question_type,onChange:x=>d(g=>({...g,question_type:x.target.value})),className:"input",children:[e.jsx("option",{value:"multiple_choice",children:n("question.multipleChoice")}),e.jsx("option",{value:"true_false",children:n("question.trueFalse")})]})]}),e.jsxs("div",{children:[e.jsx("label",{className:"block text-sm font-medium text-gray-700 mb-1",children:n("question.points")}),e.jsx("input",{type:"number",value:u.points,onChange:x=>d(g=>({...g,points:parseFloat(x.target.value)||1})),min:.5,step:.5,className:"input"})]}),e.jsxs("div",{children:[e.jsx("label",{className:"block text-sm font-medium text-gray-700 mb-1",children:n("question.difficulty")}),e.jsxs("select",{value:u.difficulty,onChange:x=>d(g=>({...g,difficulty:x.target.value})),className:"input",children:[e.jsx("option",{value:"easy",children:n("question.difficultyEasy")}),e.jsx("option",{value:"medium",children:n("question.difficultyMedium")}),e.jsx("option",{value:"hard",children:n("question.difficultyHard")})]})]})]}),u.question_type==="multiple_choice"&&e.jsxs("div",{children:[e.jsx("label",{className:"block text-sm font-medium text-gray-700 mb-2",children:n("question.options")}),e.jsx("div",{className:"space-y-2",children:u.options.map((x,g)=>e.jsxs("div",{className:"flex items-center space-x-2",children:[e.jsx("input",{type:"radio",name:"correct_answer",checked:u.correct_answer===x.id,onChange:()=>d(m=>({...m,correct_answer:x.id})),className:"w-4 h-4 text-primary"}),e.jsx("span",{className:"w-6 h-6 bg-gray-200 rounded-full flex items-center justify-center text-sm font-medium",children:x.id}),e.jsx("input",{type:"text",value:x.text,onChange:m=>C(g,m.target.value),placeholder:n("question.optionPlaceholder"),className:"input flex-1"}),u.options.length>me&&e.jsx("button",{type:"button",onClick:()=>y(g),className:"p-2 hover:bg-danger-50 rounded-lg transition-colors text-danger",children:e.jsx(pe,{className:"w-4 h-4"})})]},g))}),u.options.length<He&&e.jsxs("button",{type:"button",onClick:b,className:"mt-2 text-sm text-primary hover:text-primary-700 flex items-center",children:[e.jsx(Q,{className:"w-4 h-4 mr-1"}),n("question.addOption")]})]}),u.question_type==="true_false"&&e.jsxs("div",{children:[e.jsx("label",{className:"block text-sm font-medium text-gray-700 mb-2",children:n("question.correctAnswer")}),e.jsxs("div",{className:"flex space-x-4",children:[e.jsxs("label",{className:"flex items-center space-x-2",children:[e.jsx("input",{type:"radio",name:"tf_answer",checked:u.correct_answer===!0||u.correct_answer==="true",onChange:()=>d(x=>({...x,correct_answer:!0})),className:"w-4 h-4 text-primary"}),e.jsx("span",{children:n("common.yes")})]}),e.jsxs("label",{className:"flex items-center space-x-2",children:[e.jsx("input",{type:"radio",name:"tf_answer",checked:u.correct_answer===!1||u.correct_answer==="false",onChange:()=>d(x=>({...x,correct_answer:!1})),className:"w-4 h-4 text-primary"}),e.jsx("span",{children:n("common.no")})]})]})]}),e.jsxs("div",{children:[e.jsx("label",{className:"block text-sm font-medium text-gray-700 mb-1",children:n("question.explanation")}),e.jsx("textarea",{value:u.explanation,onChange:x=>d(g=>({...g,explanation:x.target.value})),placeholder:n("question.explanationPlaceholder"),rows:2,className:"input resize-none"})]}),e.jsxs("div",{className:"flex items-center justify-end space-x-3",children:[e.jsx("button",{type:"button",onClick:r,className:"btn-secondary",children:n("common.cancel")}),e.jsxs("button",{type:"submit",disabled:s,className:"btn-primary",children:[s&&e.jsx(B,{className:"w-4 h-4 mr-2 animate-spin"}),n("common.save")]})]})]})}function We({classId:t,exams:N}){const{t:r}=X(),[s,n]=h.useState(!1),[u,d]=h.useState(""),[a,C]=h.useState([]),[b,y]=h.useState(null),[x,g]=h.useState(null),[m,E]=h.useState({}),[_,l]=h.useState(null);h.useEffect(()=>{(async()=>{if(!u){C([]),y(null);return}n(!0);try{const{data:f,error:M}=await $.from("exam_sessions").select(`
            *,
            student:profiles!exam_sessions_student_id_fkey(id, full_name, email, student_id)
          `).eq("exam_id",u).order("submitted_at",{ascending:!1});if(M)throw M;if(C(f||[]),f&&f.length>0){const w=f.filter(S=>S.status==="submitted"||S.status==="auto_submitted"),j=w.length>0?w.reduce((S,q)=>S+(q.percentage||0),0)/w.length:0,I=w.filter(S=>S.passed).length,L=w.length>0?w.reduce((S,q)=>S+(q.cheat_count||0)+(q.tab_violations||0),0)/w.length:0,R=w.filter(S=>S.is_flagged||(S.cheat_count||0)>2).length;y({totalStudents:f.length,submittedCount:w.length,avgScore:j.toFixed(1),passRate:w.length>0?(I/w.length*100).toFixed(1):0,avgViolations:L.toFixed(1),flaggedCount:R,highestScore:w.length>0?Math.max(...w.map(S=>S.percentage||0)).toFixed(1):0,lowestScore:w.length>0?Math.min(...w.map(S=>S.percentage||0)).toFixed(1):0})}else y(null)}catch(f){console.error("Load sessions error:",f),p.error(r("error.general"))}finally{n(!1)}})()},[u,r]);const i=o=>o?new Date(o).toLocaleString("vi-VN",{day:"2-digit",month:"2-digit",year:"numeric",hour:"2-digit",minute:"2-digit"}):"-",v=o=>{const f=(o.cheat_count||0)+(o.tab_violations||0)+(o.fullscreen_violations||0);return f===0?{label:r("analytics.integrity.good"),color:"bg-success-100 text-success-700"}:f<=3?{label:r("analytics.integrity.warning"),color:"bg-warning-100 text-warning-700"}:{label:r("analytics.integrity.suspicious"),color:"bg-danger-100 text-danger-700"}},T=async o=>{if(m[o]){g(x===o?null:o);return}try{const{data:f,error:M}=await $.from("proctoring_logs").select("*").eq("session_id",o).order("timestamp",{ascending:!0});if(M)throw M;E(w=>({...w,[o]:f||[]})),g(o)}catch(f){console.error("Failed to load proctoring logs:",f),p.error("Failed to load evidence")}},A=o=>({tab_switch:"Tab Switch",fullscreen_exit:"Fullscreen Exit",multi_screen:"Multiple Screens",object_detected:"Object Detected",face_not_detected:"Face Not Detected",gaze_away:"Looking Away",copy_paste_attempt:"Copy/Paste",right_click:"Right Click",keyboard_shortcut:"Keyboard Shortcut",remote_desktop_detected:"Remote Desktop",screen_share_detected:"Screen Sharing",ai_alert:"AI Detection",manual_flag:"Manual Flag"})[o]||o,D=o=>{switch(o){case"critical":return"bg-danger-100 text-danger-700";case"warning":return"bg-warning-100 text-warning-700";case"info":return"bg-gray-100 text-gray-700";default:return"bg-gray-100 text-gray-600"}};return e.jsxs("div",{className:"space-y-6",children:[e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsx("h2",{className:"text-lg font-bold text-text-main",children:r("tabs.analytics")}),e.jsx("div",{className:"w-64",children:e.jsxs("select",{value:u,onChange:o=>d(o.target.value),className:"input",children:[e.jsx("option",{value:"",children:r("analytics.selectExam")}),N.map(o=>e.jsx("option",{value:o.id,children:o.title},o.id))]})})]}),u?s?e.jsx("div",{className:"flex items-center justify-center py-12",children:e.jsx(B,{className:"w-8 h-8 animate-spin text-primary"})}):b?e.jsxs(e.Fragment,{children:[e.jsxs("div",{className:"grid grid-cols-4 gap-4",children:[e.jsxs("div",{className:"card",children:[e.jsx("p",{className:"text-sm text-gray-500 mb-1",children:r("analytics.totalStudents")}),e.jsxs("p",{className:"text-2xl font-bold text-text-main",children:[b.submittedCount,"/",b.totalStudents]})]}),e.jsxs("div",{className:"card",children:[e.jsx("p",{className:"text-sm text-gray-500 mb-1",children:r("analytics.avgScore")}),e.jsxs("p",{className:"text-2xl font-bold text-primary",children:[b.avgScore,"%"]})]}),e.jsxs("div",{className:"card",children:[e.jsx("p",{className:"text-sm text-gray-500 mb-1",children:r("analytics.passRate")}),e.jsxs("p",{className:"text-2xl font-bold text-success",children:[b.passRate,"%"]})]}),e.jsxs("div",{className:"card",children:[e.jsx("p",{className:"text-sm text-gray-500 mb-1",children:r("analytics.flagged")}),e.jsx("p",{className:"text-2xl font-bold text-danger",children:b.flaggedCount})]})]}),e.jsxs("div",{className:"card",children:[e.jsx("h3",{className:"font-semibold text-gray-900 mb-4",children:r("analytics.scoreDistribution")}),e.jsx("div",{className:"space-y-3 mb-6",children:(()=>{const o=[{label:"90-100%",min:90,max:100,color:"bg-success-600"},{label:"80-89%",min:80,max:89,color:"bg-success-500"},{label:"70-79%",min:70,max:79,color:"bg-primary"},{label:"60-69%",min:60,max:69,color:"bg-warning-500"},{label:"50-59%",min:50,max:59,color:"bg-warning-600"},{label:"0-49%",min:0,max:49,color:"bg-danger"}],f=a.filter(w=>w.status==="submitted"||w.status==="auto_submitted"),M=f.length||1;return o.map(w=>{const j=f.filter(L=>(L.percentage||0)>=w.min&&(L.percentage||0)<=w.max).length,I=j/M*100;return e.jsxs("div",{className:"flex items-center space-x-3",children:[e.jsx("span",{className:"text-sm text-gray-600 w-20",children:w.label}),e.jsx("div",{className:"flex-1 h-6 bg-gray-100 rounded-full overflow-hidden",children:e.jsx("div",{className:`h-full ${w.color} transition-all duration-500`,style:{width:`${I}%`}})}),e.jsxs("span",{className:"text-sm font-medium text-gray-700 w-16 text-right",children:[j," (",I.toFixed(0),"%)"]})]},w.label)})})()}),e.jsxs("div",{className:"flex items-center space-x-4 text-sm pt-4 border-t border-gray-100",children:[e.jsxs("div",{className:"flex items-center space-x-2",children:[e.jsx("div",{className:"w-3 h-3 bg-success rounded-full"}),e.jsxs("span",{children:[r("analytics.highestScore"),": ",b.highestScore,"%"]})]}),e.jsxs("div",{className:"flex items-center space-x-2",children:[e.jsx("div",{className:"w-3 h-3 bg-danger rounded-full"}),e.jsxs("span",{children:[r("analytics.lowestScore"),": ",b.lowestScore,"%"]})]}),e.jsxs("div",{className:"flex items-center space-x-2",children:[e.jsx("div",{className:"w-3 h-3 bg-primary rounded-full"}),e.jsxs("span",{children:[r("analytics.avgScore"),": ",b.avgScore,"%"]})]})]})]}),e.jsx("div",{className:"card overflow-hidden p-0",children:e.jsxs("table",{className:"w-full",children:[e.jsx("thead",{className:"bg-gray-50 border-b border-gray-200",children:e.jsxs("tr",{children:[e.jsx("th",{className:"text-left px-4 py-3 text-sm font-semibold text-gray-700",children:r("table.number")}),e.jsx("th",{className:"text-left px-4 py-3 text-sm font-semibold text-gray-700",children:r("table.name")}),e.jsx("th",{className:"text-left px-4 py-3 text-sm font-semibold text-gray-700",children:r("analytics.score")}),e.jsx("th",{className:"text-left px-4 py-3 text-sm font-semibold text-gray-700",children:r("analytics.submittedAt")}),e.jsx("th",{className:"text-left px-4 py-3 text-sm font-semibold text-gray-700",children:r("analytics.violations")}),e.jsx("th",{className:"text-left px-4 py-3 text-sm font-semibold text-gray-700",children:r("analytics.integrity")}),e.jsx("th",{className:"text-left px-4 py-3 text-sm font-semibold text-gray-700",children:r("table.status")})]})}),e.jsx("tbody",{className:"divide-y divide-gray-100",children:a.map((o,f)=>{var I,L,R;const M=v(o),w=x===o.id,j=m[o.id]||[];return e.jsxs(Te.Fragment,{children:[e.jsxs("tr",{className:"hover:bg-gray-50 cursor-pointer",onClick:()=>T(o.id),children:[e.jsx("td",{className:"px-4 py-3 text-sm text-gray-500",children:f+1}),e.jsx("td",{className:"px-4 py-3",children:e.jsxs("div",{children:[e.jsx("p",{className:"font-medium text-text-main",children:((I=o.student)==null?void 0:I.full_name)||"N/A"}),e.jsx("p",{className:"text-xs text-gray-500",children:(L=o.student)==null?void 0:L.email})]})}),e.jsxs("td",{className:"px-4 py-3",children:[e.jsxs("span",{className:`font-bold ${o.passed?"text-success":"text-danger"}`,children:[((R=o.percentage)==null?void 0:R.toFixed(1))||0,"%"]}),e.jsxs("span",{className:"text-xs text-gray-500 ml-1",children:["(",o.total_score,"/",o.max_score,")"]})]}),e.jsx("td",{className:"px-4 py-3 text-sm text-gray-600",children:i(o.submitted_at)}),e.jsx("td",{className:"px-4 py-3",children:e.jsxs("div",{className:"flex items-center space-x-2 text-xs",children:[e.jsxs("span",{className:"px-2 py-0.5 bg-warning-50 text-warning-700 rounded",children:["AI: ",o.cheat_count||0]}),e.jsxs("span",{className:"px-2 py-0.5 bg-gray-100 text-gray-600 rounded",children:["Tab: ",o.tab_violations||0]})]})}),e.jsx("td",{className:"px-4 py-3",children:e.jsxs("div",{className:"flex items-center space-x-2",children:[e.jsx("span",{className:`px-2 py-1 rounded-full text-xs font-medium ${M.color}`,children:M.label}),(o.status==="submitted"||o.status==="auto_submitted")&&e.jsx("button",{onClick:S=>{S.stopPropagation(),l(o.id)},className:"p-1 text-primary hover:bg-primary-50 rounded transition-colors",title:"Xem báo cáo AI",children:e.jsx(ae,{className:"w-4 h-4"})})]})}),e.jsx("td",{className:"px-4 py-3",children:e.jsx("span",{className:`badge ${o.status==="submitted"?"badge-success":o.status==="auto_submitted"?"bg-warning-100 text-warning-700":o.status==="in_progress"?"bg-primary-100 text-primary-700":"bg-gray-100 text-gray-600"}`,children:o.status==="submitted"?r("analytics.status.submitted"):o.status==="auto_submitted"?r("analytics.status.autoSubmitted"):o.status==="in_progress"?r("analytics.status.inProgress"):o.status})})]}),w&&e.jsx("tr",{children:e.jsx("td",{colSpan:"7",className:"px-4 py-4 bg-gray-50",children:e.jsxs("div",{className:"space-y-4",children:[e.jsxs("h4",{className:"font-semibold text-gray-900 flex items-center space-x-2",children:[e.jsx(ce,{className:"w-4 h-4 text-primary"}),e.jsx("span",{children:"Proctoring Evidence Timeline"}),e.jsxs("span",{className:"text-xs font-normal text-gray-500",children:["(",j.length," events)"]})]}),j.length===0?e.jsx("p",{className:"text-sm text-gray-500 text-center py-4",children:"No violations recorded"}):e.jsx("div",{className:"space-y-3 max-h-96 overflow-y-auto",children:j.map(S=>e.jsxs("div",{className:"bg-white rounded-lg p-3 shadow-sm border border-gray-200",children:[e.jsxs("div",{className:"flex items-start justify-between mb-2",children:[e.jsxs("div",{className:"flex items-center space-x-2",children:[e.jsx("span",{className:`px-2 py-0.5 rounded text-xs font-medium ${D(S.severity)}`,children:S.severity}),e.jsx("span",{className:"text-sm font-medium text-gray-900",children:A(S.event_type)})]}),e.jsx("span",{className:"text-xs text-gray-500",children:i(S.timestamp)})]}),S.details&&Object.keys(S.details).length>0&&e.jsxs("div",{className:"mb-2 p-2 bg-gray-50 rounded",children:[e.jsx("div",{className:"text-xs font-medium text-gray-700 mb-1",children:"Details:"}),e.jsx("div",{className:"text-xs text-gray-600 space-y-0.5",children:Object.entries(S.details).map(([q,z])=>e.jsxs("div",{children:[e.jsxs("span",{className:"font-medium",children:[q,":"]})," ",String(z)]},q))})]}),S.screenshot_url&&e.jsxs("div",{className:"mt-2",children:[e.jsx("img",{src:S.screenshot_url,alt:"Evidence",className:"rounded border border-gray-300 max-w-md cursor-pointer hover:opacity-90 transition-opacity",onClick:()=>window.open(S.screenshot_url,"_blank")}),e.jsx("p",{className:"text-xs text-gray-500 mt-1",children:"Click to view full size"})]})]},S.id))})]})})})]},o.id)})})]})})]}):e.jsxs("div",{className:"text-center py-12 bg-gray-50 rounded-xl",children:[e.jsx(re,{className:"w-16 h-16 mx-auto mb-4 text-gray-300"}),e.jsx("p",{className:"text-gray-500",children:r("analytics.noData")})]}):e.jsxs("div",{className:"text-center py-12 bg-gray-50 rounded-xl",children:[e.jsx(re,{className:"w-16 h-16 mx-auto mb-4 text-gray-300"}),e.jsx("p",{className:"text-gray-500",children:r("analytics.selectExamPrompt")})]}),e.jsx(ue,{children:_&&e.jsx(H.div,{initial:{opacity:0},animate:{opacity:1},exit:{opacity:0},className:"fixed inset-0 bg-black/70 z-50 flex items-center justify-center p-4",onClick:()=>l(null),children:e.jsx("div",{onClick:o=>o.stopPropagation(),children:e.jsx(Qe,{sessionId:_,onClose:()=>l(null)})})})})]})}function Ze(){const t=new Date().getFullYear(),N=[];for(let r=-5;r<=Pe;r++){const s=t+r;N.push(`${s}-${s+1}`)}return N}function es({onClose:t,onSuccess:N}){const{user:r}=ne(),{t:s}=X(),[n,u]=h.useState(!1),[d,a]=h.useState(0),C=3,b=new Date().getFullYear(),[y,x]=h.useState({name:"",code:"",description:"",semester:"",academic_year:`${b}-${b+1}`}),g=Ze(),m=_=>{const{name:l,value:i}=_.target;x(v=>({...v,[l]:i}))},E=async _=>{if(_.preventDefault(),n)return;const l=y.name.trim(),i=y.code.trim();if(!l||!i){p.error(s("validation.enterNameAndCode"));return}if(!Be(i)){p.error(s("validation.invalidClassCode"));return}if(l.length>100){p.error(s("validation.classNameTooLong"));return}u(!0);const v=async(T=0)=>{var A,D,o,f,M,w;try{const I=new Promise((z,K)=>setTimeout(()=>K(new Error("REQUEST_TIMEOUT")),15e3)),L=$.rpc("create_class",{p_name:l,p_code:i,p_description:((A=y.description)==null?void 0:A.trim())||null,p_semester:y.semester||null,p_academic_year:y.academic_year||null}),{data:R,error:S}=await Promise.race([L,I]);if(S)throw S;if(R&&!R.success){R.error==="duplicate_code"?p.error(s("class.duplicateCode")):R.error==="not_authorized"?p.error(s("class.noPermission")):R.error==="profile_not_found"?p.error(s("error.sessionExpired")):p.error(s("class.createError"));return}let q=null;if(R!=null&&R.class_id){const{data:z,error:K}=await $.from("classes").select("*").eq("id",R.class_id).single();!K&&z?q=z:q={id:R.class_id,name:l,code:i,description:((D=y.description)==null?void 0:D.trim())||null,semester:y.semester||null,academic_year:y.academic_year||null,instructor_id:r==null?void 0:r.id,is_active:!0,created_at:new Date().toISOString()}}else console.warn("RPC create_class succeeded but no class_id returned"),q={id:crypto.randomUUID?crypto.randomUUID():Date.now().toString(),name:l,code:i,description:((o=y.description)==null?void 0:o.trim())||null,semester:y.semester||null,academic_year:y.academic_year||null,instructor_id:r==null?void 0:r.id,is_active:!0,created_at:new Date().toISOString()};p.success(s("class.createSuccess")),N==null||N(q),t()}catch(j){if(console.error("Create class error:",j),j.message==="REQUEST_TIMEOUT"){if(T<C)return a(T+1),p.info(s("error.retrying",{attempt:T+1,max:C})),await new Promise(I=>setTimeout(I,1e3)),v(T+1);p.error(s("error.timeout"))}else j.code==="23505"?p.error(s("class.duplicateCode")):j.code==="42501"||(f=j.message)!=null&&f.includes("permission")?p.error(s("class.noPermission")):(M=j.message)!=null&&M.includes("network")||(w=j.message)!=null&&w.includes("fetch")?p.error(s("error.network")):p.error(s("class.createError"));a(0)}finally{u(!1)}};await v(0)};return e.jsxs("form",{onSubmit:E,className:"space-y-4",children:[e.jsxs("div",{children:[e.jsxs("label",{className:"block text-sm font-medium text-gray-700 mb-1",children:[s("class.name")," ",e.jsx("span",{className:"text-danger",children:"*"})]}),e.jsx("input",{type:"text",name:"name",value:y.name,onChange:m,placeholder:s("class.namePlaceholder"),className:"input"})]}),e.jsxs("div",{children:[e.jsxs("label",{className:"block text-sm font-medium text-gray-700 mb-1",children:[s("class.code")," ",e.jsx("span",{className:"text-danger",children:"*"})]}),e.jsx("input",{type:"text",name:"code",value:y.code,onChange:m,placeholder:s("class.codePlaceholder"),className:"input"})]}),e.jsxs("div",{children:[e.jsx("label",{className:"block text-sm font-medium text-gray-700 mb-1",children:s("class.description")}),e.jsx("textarea",{name:"description",value:y.description,onChange:m,placeholder:s("class.descriptionPlaceholder"),rows:2,className:"input resize-none"})]}),e.jsxs("div",{className:"grid grid-cols-2 gap-4",children:[e.jsxs("div",{children:[e.jsx("label",{className:"block text-sm font-medium text-gray-700 mb-1",children:s("class.semester")}),e.jsxs("select",{name:"semester",value:y.semester,onChange:m,className:"input",children:[e.jsx("option",{value:"",children:s("class.semesterSelect")}),e.jsx("option",{value:"1",children:s("class.semester1")}),e.jsx("option",{value:"2",children:s("class.semester2")}),e.jsx("option",{value:"3",children:s("class.semesterSummer")})]})]}),e.jsxs("div",{children:[e.jsx("label",{className:"block text-sm font-medium text-gray-700 mb-1",children:s("class.year")}),e.jsx("select",{name:"academic_year",value:y.academic_year,onChange:m,className:"input",children:g.map(_=>e.jsx("option",{value:_,children:_},_))})]})]}),e.jsxs("div",{className:"flex items-center justify-end space-x-3 pt-4 border-t border-gray-200",children:[e.jsx("button",{type:"button",onClick:t,className:"btn-secondary",children:s("common.cancel")}),e.jsxs("button",{type:"submit",disabled:n,className:"btn-primary",children:[n?e.jsx(B,{className:"w-5 h-5 mr-2 animate-spin"}):e.jsx(ie,{className:"w-5 h-5 mr-2"}),s("instructor.createClass")]})]})]})}function ms(){const{user:t,profile:N,logout:r}=ne(),{t:s}=X(),n=Ee(),[u,d]=h.useState([]),[a,C]=h.useState(null),[b,y]=h.useState([]),[x,g]=h.useState([]),[m,E]=h.useState({totalStudents:0,totalExams:0,activeExams:0,flaggedSessions:0}),[_,l]=h.useState(!0),[i,v]=h.useState("exams"),[T,A]=h.useState(!1),[D,o]=h.useState(!1),[f,M]=h.useState(null),[w,j]=h.useState(!1),[I,L]=h.useState(!1),[R,S]=h.useState(!1),[q,z]=h.useState(null),[K,fe]=h.useState(""),[ss,ts]=h.useState([]),[as,rs]=h.useState(null),[be,oe]=h.useState(!1),je=c=>{M(c),o(!0)};h.useEffect(()=>{(async()=>{if(t)try{const{data:k,error:P}=await $.from("classes").select("*").eq("instructor_id",t.id).order("created_at",{ascending:!1});if(P)throw P;d(k||[]),k&&k.length>0&&!a&&C(k[0])}catch(k){console.error("Load classes error:",k)}finally{l(!1)}})()},[t]),h.useEffect(()=>{if(!a)return;const c=async()=>{try{const{data:P}=await $.from("exams").select("*").eq("class_id",a.id).order("created_at",{ascending:!1});y(P||[]);let F=[],V=null;try{const{data:O,error:U}=await $.rpc("get_class_enrollments",{p_class_id:a.id});if(!U&&(O!=null&&O.success))F=O.enrollments||[];else{const Ce=(U==null?void 0:U.message)||(O==null?void 0:O.error)||"Unknown RPC error";throw new Error(`get_class_enrollments RPC failed: ${Ce}. This may occur if the RPC function is not deployed in Supabase.`)}}catch(O){console.warn("[InstructorDashboard] RPC get_class_enrollments failed, trying direct query:",O.message||O);const U=await $.from("enrollments").select(`
              *,
              student:profiles(*)
            `).eq("class_id",a.id);F=U.data||[],V=U.error,V&&console.error("[InstructorDashboard] Error loading enrollments:",V)}g(F);const J=(P||[]).filter(O=>O.status==="published").length;E({totalStudents:(F||[]).length,totalExams:(P||[]).length,activeExams:J,flaggedSessions:0})}catch(P){console.error("Load class data error:",P)}};c();const k=$.channel(`enrollments-class-${a.id}`).on("postgres_changes",{event:"*",schema:"public",table:"enrollments",filter:`class_id=eq.${a.id}`},P=>{console.log("Enrollment change detected:",P),c(),P.eventType==="INSERT"&&p.success(s("student.studentJoined"))}).subscribe();return()=>{k.unsubscribe()}},[a,s]);const Ne=async()=>{await r(),n("/login")},ve=async c=>{try{const{error:k}=await $.from("exams").update({status:"published"}).eq("id",c);if(k)throw k;y(P=>P.map(F=>F.id===c?{...F,status:"published"}:F)),p.success(s("exam.published"))}catch{p.error(s("error.general"))}},_e=async c=>{if(window.confirm(s("student.removeConfirm")))try{const{error:k}=await $.from("enrollments").delete().eq("id",c);if(k)throw k;g(P=>P.filter(F=>F.id!==c)),p.success(s("student.removeSuccess"))}catch{p.error(s("error.general"))}},we=c=>new Date(c).toLocaleDateString("vi-VN",{day:"2-digit",month:"2-digit",year:"numeric",hour:"2-digit",minute:"2-digit"}),Se=c=>{const k=new Date,P=new Date(c.start_time),F=new Date(c.end_time);return c.status==="draft"?{label:s("exam.status.draft"),color:"bg-gray-100 text-gray-700"}:k<P?{label:s("exam.status.upcoming"),color:"bg-primary-100 text-primary-700"}:k>F?{label:s("exam.status.ended"),color:"bg-gray-100 text-gray-600"}:{label:s("exam.status.active"),color:"bg-success-100 text-success-700"}};return _?e.jsx("div",{className:"min-h-screen bg-background flex items-center justify-center",children:e.jsx(B,{className:"w-8 h-8 animate-spin text-primary"})}):e.jsxs("div",{className:"min-h-screen bg-background",children:[e.jsxs("nav",{className:"bg-paper shadow-sm border-b border-gray-200 px-6 py-4 flex justify-between items-center sticky top-0 z-10",children:[e.jsxs("div",{className:"flex items-center space-x-3",children:[e.jsx("div",{className:"bg-primary p-2 rounded-lg",children:e.jsx(Me,{className:"text-white w-6 h-6"})}),e.jsxs("div",{children:[e.jsxs("span",{className:"text-xl font-bold text-text-main tracking-tight",children:["SmartExam",e.jsx("span",{className:"text-primary",children:"Pro"})]}),e.jsx("span",{className:"text-xs text-gray-500 ml-2",children:s("instructor.title")})]})]}),e.jsxs("div",{className:"flex items-center space-x-4",children:[e.jsx(Ie,{compact:!0}),e.jsxs("button",{onClick:()=>oe(!0),className:"flex items-center space-x-2 text-sm font-medium text-gray-600 bg-gray-100 px-3 py-1.5 rounded-full hover:bg-gray-200 transition-colors cursor-pointer",title:s("profile.settings")||"Cài đặt tài khoản",children:[e.jsx(Ae,{className:"w-4 h-4"}),e.jsx("span",{children:(N==null?void 0:N.full_name)||(t==null?void 0:t.email)}),e.jsx($e,{className:"w-3.5 h-3.5 text-gray-400"})]}),e.jsxs("button",{onClick:Ne,className:"flex items-center space-x-2 text-danger hover:bg-danger-50 px-4 py-2 rounded-lg transition-colors text-sm font-semibold",children:[e.jsx(De,{className:"w-4 h-4"}),e.jsx("span",{children:s("auth.logout")})]})]})]}),e.jsx(Re,{isOpen:be,onClose:()=>oe(!1)}),e.jsxs("div",{className:"flex",children:[e.jsxs("aside",{className:"w-64 bg-paper border-r border-gray-200 min-h-[calc(100vh-65px)] p-4",children:[e.jsxs("div",{className:"flex items-center justify-between mb-4",children:[e.jsx("h2",{className:"font-bold text-gray-700",children:s("instructor.classes")}),e.jsx("button",{onClick:()=>L(!0),className:"p-1.5 hover:bg-primary-50 rounded-lg transition-colors",title:s("instructor.createClass"),children:e.jsx(Q,{className:"w-5 h-5 text-primary"})})]}),e.jsxs("div",{className:"space-y-2",children:[u.map(c=>e.jsxs("button",{onClick:()=>C(c),className:`w-full text-left p-3 rounded-xl transition-all ${(a==null?void 0:a.id)===c.id?"bg-primary-50 border-2 border-primary":"bg-gray-50 hover:bg-gray-100 border-2 border-transparent"}`,children:[e.jsx("p",{className:`font-semibold text-sm ${(a==null?void 0:a.id)===c.id?"text-primary":"text-gray-800"}`,children:c.name}),e.jsx("p",{className:"text-xs text-gray-500 mt-0.5",children:c.code})]},c.id)),u.length===0&&e.jsxs("div",{className:"text-center py-8 text-gray-500",children:[e.jsx(Z,{className:"w-12 h-12 mx-auto mb-2 opacity-50"}),e.jsx("p",{className:"text-sm",children:s("instructor.noClasses")}),e.jsx("button",{onClick:()=>L(!0),className:"text-primary text-sm mt-2 hover:underline",children:s("instructor.createFirstClass")})]})]})]}),e.jsx("main",{className:"flex-1 p-6",children:a?e.jsxs(e.Fragment,{children:[e.jsxs("div",{className:"mb-6",children:[e.jsx("h1",{className:"text-2xl font-bold text-text-main",children:a.name}),e.jsxs("p",{className:"text-gray-500",children:[s("instructor.classCode"),": ",a.code]})]}),e.jsxs("div",{className:"grid grid-cols-4 gap-4 mb-6",children:[e.jsxs("div",{className:"card flex items-center space-x-4",children:[e.jsx("div",{className:"p-3 bg-primary-100 rounded-xl",children:e.jsx(se,{className:"w-6 h-6 text-primary"})}),e.jsxs("div",{children:[e.jsx("p",{className:"text-2xl font-bold text-text-main",children:m.totalStudents}),e.jsx("p",{className:"text-sm text-gray-500",children:s("stats.students")})]})]}),e.jsxs("div",{className:"card flex items-center space-x-4",children:[e.jsx("div",{className:"p-3 bg-success-100 rounded-xl",children:e.jsx(W,{className:"w-6 h-6 text-success"})}),e.jsxs("div",{children:[e.jsx("p",{className:"text-2xl font-bold text-text-main",children:m.totalExams}),e.jsx("p",{className:"text-sm text-gray-500",children:s("stats.exams")})]})]}),e.jsxs("div",{className:"card flex items-center space-x-4",children:[e.jsx("div",{className:"p-3 bg-warning-100 rounded-xl",children:e.jsx(qe,{className:"w-6 h-6 text-warning"})}),e.jsxs("div",{children:[e.jsx("p",{className:"text-2xl font-bold text-text-main",children:m.activeExams}),e.jsx("p",{className:"text-sm text-gray-500",children:s("stats.active")})]})]}),e.jsxs("div",{className:"card flex items-center space-x-4",children:[e.jsx("div",{className:"p-3 bg-danger-100 rounded-xl",children:e.jsx(xe,{className:"w-6 h-6 text-danger"})}),e.jsxs("div",{children:[e.jsx("p",{className:"text-2xl font-bold text-text-main",children:m.flaggedSessions}),e.jsx("p",{className:"text-sm text-gray-500",children:s("stats.suspicious")})]})]})]}),e.jsx("div",{className:"flex space-x-1 p-1 bg-gray-100 rounded-xl mb-6 w-fit",children:[{id:"exams",label:s("tabs.exams"),icon:W},{id:"students",label:s("tabs.students"),icon:se},{id:"analytics",label:s("tabs.analytics"),icon:re}].map(c=>e.jsxs("button",{onClick:()=>v(c.id),className:`flex items-center space-x-2 px-4 py-2 rounded-lg text-sm font-medium transition-colors ${i===c.id?"bg-white shadow text-primary":"text-gray-600 hover:text-gray-900"}`,children:[e.jsx(c.icon,{className:"w-4 h-4"}),e.jsx("span",{children:c.label})]},c.id))}),i==="exams"&&e.jsxs("div",{children:[e.jsxs("div",{className:"flex items-center justify-between mb-4",children:[e.jsx("h2",{className:"text-lg font-bold text-text-main",children:s("tabs.exams")}),e.jsxs("button",{onClick:()=>A(!0),className:"btn-primary",children:[e.jsx(Q,{className:"w-5 h-5 mr-2"}),s("exam.create")]})]}),b.length>0?e.jsx("div",{className:"space-y-3",children:b.map(c=>{const k=Se(c);return e.jsx("div",{className:"card hover:shadow-soft transition-shadow",children:e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsxs("div",{className:"flex-1",children:[e.jsxs("div",{className:"flex items-center space-x-3",children:[e.jsx("h3",{className:"font-semibold text-text-main",children:c.title}),e.jsx("span",{className:`px-2 py-0.5 rounded-full text-xs font-medium ${k.color}`,children:k.label})]}),e.jsxs("div",{className:"flex items-center space-x-4 mt-2 text-sm text-gray-500",children:[e.jsxs("span",{className:"flex items-center space-x-1",children:[e.jsx(le,{className:"w-4 h-4"}),e.jsxs("span",{children:[c.duration_minutes," ",s("exam.minutes")]})]}),e.jsxs("span",{className:"flex items-center space-x-1",children:[e.jsx(Fe,{className:"w-4 h-4"}),e.jsx("span",{children:we(c.start_time)})]})]})]}),e.jsxs("div",{className:"flex items-center space-x-2",children:[e.jsxs("button",{onClick:()=>je(c),className:"btn-secondary text-sm",title:s("exam.edit"),children:[e.jsx(ge,{className:"w-4 h-4 mr-1"}),s("exam.edit")]}),c.status==="draft"&&e.jsxs("button",{onClick:()=>ve(c.id),className:"btn-success text-sm",children:[e.jsx(he,{className:"w-4 h-4 mr-1"}),s("exam.publish")]}),e.jsxs("button",{onClick:()=>{z(c),S(!0)},className:"btn-secondary text-sm",title:s("exam.manageQuestions"),children:[e.jsx(W,{className:"w-4 h-4 mr-1"}),s("exam.manageQuestions")]})]})]})},c.id)})}):e.jsxs("div",{className:"text-center py-12 bg-gray-50 rounded-xl",children:[e.jsx(W,{className:"w-16 h-16 mx-auto mb-4 text-gray-300"}),e.jsx("p",{className:"text-gray-500 mb-4",children:s("exam.noExams")}),e.jsxs("button",{onClick:()=>A(!0),className:"btn-primary",children:[e.jsx(Q,{className:"w-5 h-5 mr-2"}),s("exam.createFirst")]})]})]}),i==="students"&&e.jsxs("div",{children:[e.jsxs("div",{className:"flex items-center justify-between mb-4",children:[e.jsx("h2",{className:"text-lg font-bold text-text-main",children:s("tabs.students")}),e.jsxs("button",{onClick:()=>j(!0),className:"btn-primary",children:[e.jsx(Q,{className:"w-5 h-5 mr-2"}),s("student.add")]})]}),e.jsxs("div",{className:"relative mb-4",children:[e.jsx(Oe,{className:"absolute left-3 top-1/2 -translate-y-1/2 w-5 h-5 text-gray-400"}),e.jsx("input",{type:"text",placeholder:s("student.searchPlaceholder"),value:K,onChange:c=>fe(c.target.value),className:"input pl-10"})]}),x.length>0?e.jsx("div",{className:"card overflow-hidden p-0",children:e.jsxs("table",{className:"w-full",children:[e.jsx("thead",{className:"bg-gray-50 border-b border-gray-200",children:e.jsxs("tr",{children:[e.jsx("th",{className:"text-left px-4 py-3 text-sm font-semibold text-gray-700",children:s("table.number")}),e.jsx("th",{className:"text-left px-4 py-3 text-sm font-semibold text-gray-700",children:s("table.name")}),e.jsx("th",{className:"text-left px-4 py-3 text-sm font-semibold text-gray-700",children:s("table.email")}),e.jsx("th",{className:"text-left px-4 py-3 text-sm font-semibold text-gray-700",children:s("table.studentId")}),e.jsx("th",{className:"text-left px-4 py-3 text-sm font-semibold text-gray-700",children:s("student.enrolledAt")}),e.jsx("th",{className:"text-left px-4 py-3 text-sm font-semibold text-gray-700",children:s("table.status")}),e.jsx("th",{className:"text-right px-4 py-3 text-sm font-semibold text-gray-700",children:s("table.actions")})]})}),e.jsx("tbody",{className:"divide-y divide-gray-100",children:x.filter(c=>{var P,F,V,J,O,U;if(!K)return!0;const k=K.toLowerCase();return((F=(P=c.student)==null?void 0:P.full_name)==null?void 0:F.toLowerCase().includes(k))||((J=(V=c.student)==null?void 0:V.email)==null?void 0:J.toLowerCase().includes(k))||((U=(O=c.student)==null?void 0:O.student_id)==null?void 0:U.toLowerCase().includes(k))}).map((c,k)=>{var F,V,J;const P=c.enrolled_at&&Date.now()-new Date(c.enrolled_at).getTime()<3e5;return e.jsxs("tr",{className:`hover:bg-gray-50 transition-colors ${P?"bg-success-50":""}`,children:[e.jsx("td",{className:"px-4 py-3 text-sm text-gray-500",children:k+1}),e.jsx("td",{className:"px-4 py-3",children:e.jsxs("div",{className:"flex items-center space-x-3",children:[e.jsx("div",{className:`w-8 h-8 rounded-full flex items-center justify-center ${P?"bg-success-100 ring-2 ring-success-300 ring-offset-1":"bg-primary-100"}`,children:e.jsx(Le,{className:`w-4 h-4 ${P?"text-success":"text-primary"}`})}),e.jsxs("div",{className:"flex items-center space-x-2",children:[e.jsx("span",{className:"font-medium text-text-main",children:((F=c.student)==null?void 0:F.full_name)||"N/A"}),P&&e.jsx("span",{className:"px-1.5 py-0.5 text-[10px] font-bold uppercase bg-success text-white rounded animate-pulse",children:"NEW"})]})]})}),e.jsx("td",{className:"px-4 py-3 text-sm text-gray-600",children:(V=c.student)==null?void 0:V.email}),e.jsx("td",{className:"px-4 py-3 text-sm text-gray-600",children:((J=c.student)==null?void 0:J.student_id)||"-"}),e.jsx("td",{className:"px-4 py-3 text-sm text-gray-500",children:c.enrolled_at?new Date(c.enrolled_at).toLocaleString("vi-VN",{day:"2-digit",month:"2-digit",year:"numeric",hour:"2-digit",minute:"2-digit"}):"-"}),e.jsx("td",{className:"px-4 py-3",children:e.jsx("span",{className:`badge ${c.status==="active"?"badge-success":"bg-gray-100 text-gray-600"}`,children:c.status==="active"?s("student.statusActive"):c.status})}),e.jsx("td",{className:"px-4 py-3 text-right",children:e.jsx("button",{onClick:()=>_e(c.id),className:"p-2 hover:bg-danger-50 rounded-lg transition-colors text-danger",title:s("student.remove"),children:e.jsx(ye,{className:"w-4 h-4"})})})]},c.id)})})]})}):e.jsxs("div",{className:"text-center py-12 bg-gray-50 rounded-xl",children:[e.jsx(se,{className:"w-16 h-16 mx-auto mb-4 text-gray-300"}),e.jsx("p",{className:"text-gray-500 mb-4",children:s("student.noStudents")}),e.jsxs("button",{onClick:()=>j(!0),className:"btn-primary",children:[e.jsx(Q,{className:"w-5 h-5 mr-2"}),s("student.add")]})]})]}),i==="analytics"&&e.jsx(We,{classId:a==null?void 0:a.id,exams:b})]}):e.jsx("div",{className:"flex items-center justify-center h-[60vh]",children:e.jsxs("div",{className:"text-center",children:[e.jsx(Z,{className:"w-20 h-20 mx-auto mb-4 text-gray-300"}),e.jsx("h2",{className:"text-xl font-bold text-gray-700 mb-2",children:s("instructor.welcome")}),e.jsx("p",{className:"text-gray-500 mb-6",children:s("instructor.welcomeDesc")}),e.jsxs("button",{onClick:()=>L(!0),className:"btn-primary",children:[e.jsx(Q,{className:"w-5 h-5 mr-2"}),s("instructor.createClass")]})]})})})]}),e.jsx(G,{isOpen:I,onClose:()=>L(!1),title:s("instructor.createClassTitle"),children:e.jsx(es,{onClose:()=>L(!1),onSuccess:c=>{d(k=>[c,...k]),C(c)}})}),e.jsx(G,{isOpen:T,onClose:()=>A(!1),title:s("instructor.createExamTitle"),children:e.jsx(Ye,{classId:a==null?void 0:a.id,onClose:()=>A(!1),onSuccess:c=>{y(k=>[c,...k])}})}),e.jsx(G,{isOpen:D,onClose:()=>{o(!1),M(null)},title:s("instructor.editExamTitle"),children:f&&e.jsx(Xe,{exam:f,onClose:()=>{o(!1),M(null)},onSuccess:c=>{y(k=>k.map(P=>P.id===c.id?c:P))}})}),e.jsx(G,{isOpen:w,onClose:()=>j(!1),title:s("instructor.addStudentTitle"),children:e.jsx(Ke,{classId:a==null?void 0:a.id,onClose:()=>j(!1),onSuccess:()=>{a&&$.from("enrollments").select("*, student:profiles(*)").eq("class_id",a.id).then(({data:c})=>g(c||[]))}})}),e.jsx(G,{isOpen:R,onClose:()=>{S(!1),z(null)},title:s("exam.manageQuestions"),children:q&&e.jsx(Je,{examId:q.id,examTitle:q.title,onClose:()=>{S(!1),z(null)}})})]})}export{ms as default};
