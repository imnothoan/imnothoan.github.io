import{c as Y,u as Z,a as ee,b as se,r as d,s as u,j as e,B as p}from"./index-DCeZEmk_.js";import{F as P,L as te}from"./LanguageSwitcher-CCaBvwPg.js";import{S as ae,C as re,F as ie,a as R,b as ne}from"./FaceVerification-BJPBiBND.js";import{S as ce,L as le,P as oe,C as A,G as de,B as me,U as xe}from"./ProfileSettings-DOWh9MSI.js";import{L as he,U as ue,m,A as F}from"./proxy-DeKowzOt.js";import{C as pe}from"./chevron-right-CKAtBuuj.js";/**
 * @license lucide-react v0.468.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const N=Y("CirclePlay",[["circle",{cx:"12",cy:"12",r:"10",key:"1mglay"}],["polygon",{points:"10 8 16 12 10 16 10 8",key:"1cimsy"}]]);function we(){var D;const{user:o,profile:c,profileLoading:y,logout:$,refetchProfile:q}=Z(),{t:s}=ee(),w=se(),[v,C]=d.useState([]),[k,V]=d.useState([]),[I,b]=d.useState(!0),[E,S]=d.useState(!1),[_,U]=d.useState(!0),[B,j]=d.useState(!1),[M,T]=d.useState(!1),g=!!(c!=null&&c.face_embedding||c!=null&&c.face_enrolled_at);d.useEffect(()=>{if(!y){S(!1);return}const t=setTimeout(()=>{console.warn("Dashboard: Profile loading timeout reached, proceeding with user metadata"),S(!0)},2e3);return()=>clearTimeout(t)},[y]),d.useEffect(()=>{if(!o)return;const t=async()=>{try{let r=[];try{const{data:i,error:n}=await u.rpc("get_my_enrollments");if(!n&&(i!=null&&i.success))r=i.enrollments||[];else throw new Error((n==null?void 0:n.message)||(i==null?void 0:i.error)||"Failed to load enrollments via RPC function")}catch(i){console.warn("[Dashboard] RPC get_my_enrollments failed, trying direct query:",i.message);const{data:n,error:l}=await u.from("enrollments").select(`
              id,
              status,
              enrolled_at,
              class:classes(
                id,
                name,
                code,
                description,
                semester,
                academic_year,
                instructor:profiles!classes_instructor_id_fkey(full_name, email)
              )
            `).eq("student_id",o.id).order("enrolled_at",{ascending:!1});if(l)throw console.error("[Dashboard] Error loading enrollments:",l),l;r=n||[]}V(r)}catch(r){console.error("Load classes error:",r)}};t();const a=u.channel(`enrollments-${o.id}`).on("postgres_changes",{event:"*",schema:"public",table:"enrollments",filter:`student_id=eq.${o.id}`},r=>{console.log("Enrollment change:",r),t()}).subscribe();return()=>{a.unsubscribe()}},[o]),d.useEffect(()=>{(async()=>{var i,n;if(!o){b(!1);return}if(y&&!c&&!E)return;const a=(c==null?void 0:c.role)||((i=o==null?void 0:o.user_metadata)==null?void 0:i.role)||"student";if(a==="instructor"||a==="admin"){b(!1);return}try{const{data:l,error:x}=await u.from("enrollments").select("class_id").eq("student_id",o.id).eq("status","active");if(x)throw x;if(!l||l.length===0){C([]),b(!1);return}const K=l.map(h=>h.class_id),{data:W,error:L}=await u.from("exams").select(`
            *,
            class:classes(name, code)
          `).in("class_id",K).eq("status","published").order("start_time",{ascending:!0});if(L)throw L;const{data:X}=await u.from("exam_sessions").select("exam_id, status, percentage").eq("student_id",o.id),J=new Map((X||[]).map(h=>[h.exam_id,h])),Q=(W||[]).map(h=>({...h,session:J.get(h.id)||null}));C(Q)}catch(l){console.error("Load exams error:",l);const x=((n=l.message)==null?void 0:n.toLowerCase())||"";x.includes("network")||x.includes("fetch")?p.error(s("error.network")):x.includes("permission")||x.includes("unauthorized")?p.error(s("error.sessionExpired")):p.error(s("error.loadExams"))}finally{b(!1)}})()},[o,c,y,E,s]);const z=async()=>{await $(),w("/login")},H=t=>{var n,l;const a=new Date,r=new Date(t.start_time),i=new Date(t.end_time);return((n=t.session)==null?void 0:n.status)==="submitted"||((l=t.session)==null?void 0:l.status)==="auto_submitted"?{type:"completed",label:s("exam.status.completed"),color:"bg-success-100 text-success-700",icon:ne,canTake:!1}:a<r?{type:"upcoming",label:s("exam.status.upcoming"),color:"bg-gray-100 text-gray-600",icon:R,canTake:!1}:a>i?{type:"ended",label:s("exam.status.ended"),color:"bg-gray-100 text-gray-500",icon:A,canTake:!1}:{type:"active",label:s("exam.status.active"),color:"bg-primary-100 text-primary-700",icon:N,canTake:!0}},O=t=>new Date(t).toLocaleString("vi-VN",{day:"2-digit",month:"2-digit",year:"numeric",hour:"2-digit",minute:"2-digit"}),G={hidden:{opacity:0},visible:{opacity:1,transition:{staggerChildren:.1}}},f={hidden:{y:20,opacity:0},visible:{y:0,opacity:1}};return I?e.jsx("div",{className:"min-h-screen bg-background flex items-center justify-center",children:e.jsx(he,{className:"w-8 h-8 animate-spin text-primary"})}):e.jsxs("div",{className:"min-h-screen bg-background font-sans text-text-main",children:[e.jsxs("nav",{className:"bg-paper shadow-sm border-b border-gray-200 px-8 py-4 flex justify-between items-center sticky top-0 z-10",children:[e.jsxs("div",{className:"flex items-center space-x-2",children:[e.jsx("div",{className:"bg-primary p-2 rounded-lg",children:e.jsx(P,{className:"text-white w-6 h-6"})}),e.jsxs("span",{className:"text-xl font-bold text-text-main tracking-tight",children:["SmartExam",e.jsx("span",{className:"text-primary",children:"Pro"})]})]}),e.jsxs("div",{className:"flex items-center space-x-4",children:[e.jsx(te,{compact:!0}),e.jsxs("button",{onClick:()=>T(!0),className:"flex items-center space-x-2 text-sm font-medium text-gray-600 bg-gray-100 px-3 py-1.5 rounded-full hover:bg-gray-200 transition-colors cursor-pointer",title:s("profile.settings")||"CÃ i Ä‘áº·t tÃ i khoáº£n",children:[e.jsx(ue,{className:"w-4 h-4"}),e.jsx("span",{children:(c==null?void 0:c.full_name)||(o==null?void 0:o.email)}),e.jsx(ce,{className:"w-3.5 h-3.5 text-gray-400"})]}),e.jsxs("button",{onClick:z,className:"flex items-center space-x-2 text-danger hover:bg-danger-50 px-4 py-2 rounded-lg transition-colors text-sm font-semibold",children:[e.jsx(le,{className:"w-4 h-4"}),e.jsx("span",{children:s("auth.logout")})]})]})]}),e.jsx(oe,{isOpen:M,onClose:()=>T(!1)}),e.jsxs(m.div,{variants:G,initial:"hidden",animate:"visible",className:"max-w-6xl mx-auto px-8 py-10",children:[e.jsxs("div",{className:"mb-8",children:[e.jsxs("h1",{className:"text-3xl font-bold text-text-main",children:[s("dashboard.hello"),", ",((D=c==null?void 0:c.full_name)==null?void 0:D.split(" ").pop())||s("auth.student"),"! ðŸ‘‹"]}),e.jsx("p",{className:"text-gray-500 mt-2",children:s("dashboard.selectExam")})]}),e.jsx(m.div,{variants:f,className:"mb-8",children:e.jsxs("div",{className:"bg-paper rounded-xl border border-gray-100 p-6 shadow-sm",children:[e.jsxs("div",{className:"flex items-center justify-between mb-4",children:[e.jsxs("div",{className:"flex items-center space-x-3",children:[e.jsx("div",{className:`p-3 rounded-full ${g?"bg-success-100":"bg-warning-100"}`,children:g?e.jsx(ae,{className:"w-6 h-6 text-success-600"}):e.jsx(re,{className:"w-6 h-6 text-warning-600"})}),e.jsxs("div",{children:[e.jsx("h3",{className:"font-bold text-text-main",children:s("profile.faceVerification")||"XÃ¡c minh khuÃ´n máº·t"}),e.jsx("p",{className:"text-sm text-gray-500",children:g?s("profile.faceRegistered")||"KhuÃ´n máº·t Ä‘Ã£ Ä‘Æ°á»£c Ä‘Äƒng kÃ½":s("profile.faceNotRegistered")||"ChÆ°a Ä‘Äƒng kÃ½ khuÃ´n máº·t - cáº§n Ä‘Äƒng kÃ½ Ä‘á»ƒ lÃ m bÃ i thi"})]})]}),e.jsx("button",{onClick:()=>j(!0),className:`px-4 py-2 rounded-lg font-medium transition-colors ${g?"bg-gray-100 text-gray-700 hover:bg-gray-200":"bg-primary text-white hover:bg-primary-600"}`,children:g?s("profile.updateFace")||"Cáº­p nháº­t áº£nh":s("profile.registerFace")||"ÄÄƒng kÃ½ ngay"})]}),!g&&e.jsxs("div",{className:"bg-warning-50 rounded-lg p-3 text-sm text-warning-700 flex items-start space-x-2",children:[e.jsx(A,{className:"w-5 h-5 flex-shrink-0 mt-0.5"}),e.jsx("p",{children:s("profile.faceRequiredWarning")||"Báº¡n cáº§n Ä‘Äƒng kÃ½ khuÃ´n máº·t trÆ°á»›c khi tham gia bÃ i thi Ä‘á»ƒ há»‡ thá»‘ng cÃ³ thá»ƒ xÃ¡c minh danh tÃ­nh."})]})]})}),e.jsx(F,{children:B&&e.jsx(m.div,{initial:{opacity:0},animate:{opacity:1},exit:{opacity:0},className:"fixed inset-0 bg-black/50 z-50 flex items-center justify-center p-4 overflow-y-auto",onClick:()=>j(!1),children:e.jsxs(m.div,{initial:{scale:.95,opacity:0},animate:{scale:1,opacity:1},exit:{scale:.95,opacity:0},className:"bg-paper rounded-2xl shadow-xl max-w-2xl w-full my-4 flex flex-col",style:{maxHeight:"calc(100vh - 2rem)"},onClick:t=>t.stopPropagation(),children:[e.jsxs("div",{className:"p-6 border-b border-gray-200 flex-shrink-0",children:[e.jsx("h2",{className:"text-xl font-bold text-text-main",children:s("profile.faceRegistrationTitle")||"ÄÄƒng kÃ½ khuÃ´n máº·t"}),e.jsx("p",{className:"text-sm text-gray-500 mt-1",children:s("profile.faceRegistrationDesc")||"ÄÃ¢y lÃ  láº§n Ä‘áº§u báº¡n thi. Vui lÃ²ng chá»¥p áº£nh khuÃ´n máº·t Ä‘á»ƒ Ä‘Äƒng kÃ½ xÃ¡c minh."})]}),e.jsx("div",{className:"p-6 overflow-y-auto flex-1",children:e.jsx(ie,{mode:"enroll",onEnrollComplete:async(t,a)=>{try{const{error:r}=await u.rpc("update_face_embedding",{p_embedding:t,p_image_url:a});if(r){console.error("Error saving face embedding:",r),p.error(s("error.general")||"CÃ³ lá»—i xáº£y ra khi lÆ°u");return}j(!1),await q(),p.success(s("profile.faceRegisteredSuccess")||"ÄÄƒng kÃ½ khuÃ´n máº·t thÃ nh cÃ´ng!")}catch(r){console.error("Face registration error:",r),p.error(s("error.general")||"CÃ³ lá»—i xáº£y ra")}},onFailure:()=>{p.error(s("face.failed")||"ÄÄƒng kÃ½ tháº¥t báº¡i. Vui lÃ²ng thá»­ láº¡i.")}})}),e.jsx("div",{className:"p-4 border-t border-gray-200 bg-gray-50 flex-shrink-0",children:e.jsx("button",{onClick:()=>j(!1),className:"w-full py-2 text-gray-600 hover:text-gray-800 text-sm font-medium",children:s("common.cancel")||"Há»§y"})})]})})}),k.length>0&&e.jsxs(m.div,{variants:f,className:"mb-10",children:[e.jsxs("div",{onClick:()=>U(!_),className:"flex items-center justify-between cursor-pointer mb-4 group",children:[e.jsxs("div",{className:"flex items-center space-x-2",children:[e.jsx(de,{className:"w-6 h-6 text-primary"}),e.jsx("h2",{className:"text-xl font-bold text-text-main",children:s("dashboard.myClasses")||"Lá»›p há»c cá»§a tÃ´i"}),e.jsx("span",{className:"bg-primary-100 text-primary-700 text-xs font-bold px-2 py-0.5 rounded-full",children:k.length})]}),e.jsx(pe,{className:`w-5 h-5 text-gray-400 transition-transform ${_?"rotate-90":""}`})]}),e.jsx(F,{children:_&&e.jsx(m.div,{initial:{height:0,opacity:0},animate:{height:"auto",opacity:1},exit:{height:0,opacity:0},transition:{duration:.2},className:"overflow-hidden",children:e.jsx("div",{className:"grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4",children:k.map(t=>{var a,r,i,n;return e.jsxs(m.div,{variants:f,className:"bg-paper rounded-xl border border-gray-100 p-4 hover:shadow-soft transition-all",children:[e.jsx("div",{className:"flex items-start justify-between mb-2",children:e.jsxs("div",{className:"flex items-center space-x-2",children:[e.jsx(me,{className:"w-5 h-5 text-primary"}),e.jsx("span",{className:`text-xs font-bold px-2 py-0.5 rounded-full ${t.status==="active"?"bg-success-100 text-success-700":t.status==="completed"?"bg-primary-100 text-primary-700":"bg-gray-100 text-gray-600"}`,children:t.status==="active"?s("student.statusActive")||"Äang há»c":t.status==="completed"?s("class.status.completed")||"HoÃ n thÃ nh":s("class.status.dropped")||"ÄÃ£ rá»i"})]})}),e.jsx("h3",{className:"font-bold text-text-main mb-1 line-clamp-2",children:((a=t.class)==null?void 0:a.name)||"N/A"}),e.jsxs("div",{className:"text-xs text-gray-500 space-y-1",children:[e.jsxs("p",{className:"flex items-center space-x-1",children:[e.jsxs("span",{className:"font-medium",children:[s("class.code")||"MÃ£ lá»›p",":"]}),e.jsx("span",{children:((r=t.class)==null?void 0:r.code)||"N/A"})]}),((i=t.class)==null?void 0:i.instructor)&&e.jsxs("p",{className:"flex items-center space-x-1",children:[e.jsx(xe,{className:"w-3 h-3"}),e.jsx("span",{children:t.class.instructor.full_name||t.class.instructor.email})]}),((n=t.class)==null?void 0:n.semester)&&e.jsxs("p",{children:[t.class.semester," - ",t.class.academic_year||""]})]}),e.jsxs("div",{className:"mt-3 pt-3 border-t border-gray-100 text-xs text-gray-400",children:[s("student.enrolledAt")||"Tham gia",": ",new Date(t.enrolled_at).toLocaleDateString("vi-VN")]})]},t.id)})})})})]}),v.length>0?e.jsx("div",{className:"grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6",children:v.map(t=>{var i,n,l;const a=H(t),r=a.icon;return e.jsxs(m.div,{variants:f,className:`card hover:shadow-soft transition-all group ${a.canTake?"":"opacity-75"}`,children:[e.jsxs("div",{className:"flex justify-between items-start mb-4",children:[e.jsx("div",{className:`px-3 py-1 rounded-full text-xs font-bold uppercase tracking-wider ${a.color}`,children:a.label}),e.jsx(r,{className:`w-5 h-5 ${a.type==="active"?"text-primary":a.type==="completed"?"text-success":"text-gray-400"}`})]}),e.jsx("h3",{className:`text-xl font-bold mb-2 ${a.canTake?"text-text-main group-hover:text-primary":"text-gray-700"} transition-colors`,children:t.title}),e.jsxs("div",{className:"space-y-1 text-sm text-gray-500 mb-4",children:[e.jsxs("p",{children:[s("exam.course"),": ",((i=t.class)==null?void 0:i.name)||"N/A"]}),e.jsxs("p",{children:[s("exam.code"),": ",((n=t.class)==null?void 0:n.code)||"N/A"]}),e.jsxs("p",{className:"flex items-center space-x-1",children:[e.jsx(R,{className:"w-4 h-4"}),e.jsxs("span",{children:[s("exam.duration"),": ",t.duration_minutes," ",s("exam.minutes")]})]})]}),a.type==="completed"&&((l=t.session)==null?void 0:l.percentage)!==null&&e.jsx("div",{className:"mb-4 p-3 bg-success-50 rounded-lg",children:e.jsxs("p",{className:"text-sm text-gray-600",children:[s("exam.score"),": ",e.jsxs("span",{className:"font-bold text-success-700",children:[t.session.percentage.toFixed(1),"%"]})]})}),a.type==="upcoming"&&e.jsx("div",{className:"mb-4 p-3 bg-gray-50 rounded-lg text-xs text-gray-500",children:e.jsxs("p",{children:[s("exam.startTime"),": ",O(t.start_time)]})}),a.canTake?e.jsxs("button",{onClick:()=>w(`/exam/${t.id}`),className:"w-full flex items-center justify-center space-x-2 btn-primary py-3",children:[e.jsx(N,{className:"w-5 h-5"}),e.jsx("span",{children:s("dashboard.enterExam")})]}):a.type==="completed"&&t.allow_review?e.jsx("button",{className:"w-full btn-secondary py-3",children:s("dashboard.reviewExam")}):e.jsx("button",{disabled:!0,className:"w-full bg-gray-200 text-gray-500 py-3 rounded-xl font-semibold cursor-not-allowed",children:a.type==="upcoming"?s("dashboard.notStarted"):a.type==="ended"?s("dashboard.expired"):s("dashboard.notAvailable")})]},t.id)})}):e.jsxs("div",{className:"text-center py-16 bg-paper rounded-2xl border border-gray-100",children:[e.jsx(P,{className:"w-20 h-20 mx-auto mb-4 text-gray-300"}),e.jsx("h2",{className:"text-xl font-bold text-gray-700 mb-2",children:s("dashboard.noExams")}),e.jsx("p",{className:"text-gray-500",children:s("dashboard.noExamsDesc")})]}),v.length===0&&e.jsxs("div",{className:"mt-8",children:[e.jsx("p",{className:"text-sm text-gray-500 mb-4",children:s("dashboard.demoExam")}),e.jsxs(m.div,{variants:f,className:"card hover:shadow-soft transition-all group max-w-md",children:[e.jsxs("div",{className:"flex justify-between items-start mb-4",children:[e.jsx("div",{className:"bg-primary-100 text-primary-700 px-3 py-1 rounded-full text-xs font-bold uppercase tracking-wider",children:"Demo"}),e.jsx(N,{className:"w-5 h-5 text-primary"})]}),e.jsx("h3",{className:"text-xl font-bold text-text-main mb-2 group-hover:text-primary transition-colors",children:"TrÃ­ tuá»‡ nhÃ¢n táº¡o (AI)"}),e.jsxs("p",{className:"text-gray-500 text-sm mb-6",children:[s("exam.code"),": INT3401 â€¢ ",s("exam.duration"),": 45 ",s("exam.minutes")]}),e.jsxs("button",{onClick:()=>w("/exam/demo"),className:"w-full flex items-center justify-center space-x-2 btn-primary py-3",children:[e.jsx(N,{className:"w-5 h-5"}),e.jsx("span",{children:s("dashboard.enterExam")})]})]})]})]})]})}export{we as default};
