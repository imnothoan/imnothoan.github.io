import{c as A,u as O,a as H,b as J,r as d,s as p,j as e,B as w}from"./index-BJ0FpwaS.js";import{F as T,L as K}from"./LanguageSwitcher-D1WvzkB_.js";import{L as Q,U as W,m as u,A as X}from"./proxy-Dhp-gnbP.js";import{L as Y,G as Z,B as ee,U as se}from"./users-C5FNj_L9.js";import{C as te}from"./chevron-right--18C0Quo.js";import{C as D,a as ae}from"./clock-Be7EPjpt.js";/**
 * @license lucide-react v0.468.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const re=A("CircleAlert",[["circle",{cx:"12",cy:"12",r:"10",key:"1mglay"}],["line",{x1:"12",x2:"12",y1:"8",y2:"12",key:"1pkeuh"}],["line",{x1:"12",x2:"12.01",y1:"16",y2:"16",key:"4dfq90"}]]);/**
 * @license lucide-react v0.468.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const f=A("CirclePlay",[["circle",{cx:"12",cy:"12",r:"10",key:"1mglay"}],["polygon",{points:"10 8 16 12 10 16 10 8",key:"1cimsy"}]]);function me(){var C;const{user:r,profile:l,profileLoading:h,logout:S}=O(),{t}=H(),b=J(),[j,_]=d.useState([]),[N,$]=d.useState([]),[q,g]=d.useState(!0),[k,E]=d.useState(!1),[v,I]=d.useState(!0);d.useEffect(()=>{if(!h){E(!1);return}const s=setTimeout(()=>{console.warn("Dashboard: Profile loading timeout reached, proceeding with user metadata"),E(!0)},2e3);return()=>clearTimeout(s)},[h]),d.useEffect(()=>{if(!r)return;const s=async()=>{try{const{data:c,error:i}=await p.from("enrollments").select(`
            id,
            status,
            enrolled_at,
            class:classes(
              id,
              name,
              code,
              description,
              semester,
              academic_year,
              instructor:profiles!classes_instructor_id_fkey(full_name, email)
            )
          `).eq("student_id",r.id).order("enrolled_at",{ascending:!1});if(i)throw console.error("[Dashboard] Error loading enrollments:",i),i;$(c||[])}catch(c){console.error("Load classes error:",c)}};s();const a=p.channel(`enrollments-${r.id}`).on("postgres_changes",{event:"*",schema:"public",table:"enrollments",filter:`student_id=eq.${r.id}`},c=>{console.log("Enrollment change:",c),s()}).subscribe();return()=>{a.unsubscribe()}},[r]),d.useEffect(()=>{(async()=>{var i,o;if(!r){g(!1);return}if(h&&!l&&!k)return;const a=(l==null?void 0:l.role)||((i=r==null?void 0:r.user_metadata)==null?void 0:i.role)||"student";if(a==="instructor"||a==="admin"){g(!1);return}try{const{data:n,error:m}=await p.from("enrollments").select("class_id").eq("student_id",r.id).eq("status","active");if(m)throw m;if(!n||n.length===0){_([]),g(!1);return}const M=n.map(x=>x.class_id),{data:V,error:L}=await p.from("exams").select(`
            *,
            class:classes(name, code)
          `).in("class_id",M).eq("status","published").order("start_time",{ascending:!0});if(L)throw L;const{data:F}=await p.from("exam_sessions").select("exam_id, status, percentage").eq("student_id",r.id),z=new Map((F||[]).map(x=>[x.exam_id,x])),G=(V||[]).map(x=>({...x,session:z.get(x.id)||null}));_(G)}catch(n){console.error("Load exams error:",n);const m=((o=n.message)==null?void 0:o.toLowerCase())||"";m.includes("network")||m.includes("fetch")?w.error(t("error.network")):m.includes("permission")||m.includes("unauthorized")?w.error(t("error.sessionExpired")):w.error(t("error.loadExams"))}finally{g(!1)}})()},[r,l,h,k,t]);const P=async()=>{await S(),b("/login")},U=s=>{var o,n;const a=new Date,c=new Date(s.start_time),i=new Date(s.end_time);return((o=s.session)==null?void 0:o.status)==="submitted"||((n=s.session)==null?void 0:n.status)==="auto_submitted"?{type:"completed",label:t("exam.status.completed"),color:"bg-success-100 text-success-700",icon:ae,canTake:!1}:a<c?{type:"upcoming",label:t("exam.status.upcoming"),color:"bg-gray-100 text-gray-600",icon:D,canTake:!1}:a>i?{type:"ended",label:t("exam.status.ended"),color:"bg-gray-100 text-gray-500",icon:re,canTake:!1}:{type:"active",label:t("exam.status.active"),color:"bg-primary-100 text-primary-700",icon:f,canTake:!0}},R=s=>new Date(s).toLocaleString("vi-VN",{day:"2-digit",month:"2-digit",year:"numeric",hour:"2-digit",minute:"2-digit"}),B={hidden:{opacity:0},visible:{opacity:1,transition:{staggerChildren:.1}}},y={hidden:{y:20,opacity:0},visible:{y:0,opacity:1}};return q?e.jsx("div",{className:"min-h-screen bg-background flex items-center justify-center",children:e.jsx(Q,{className:"w-8 h-8 animate-spin text-primary"})}):e.jsxs("div",{className:"min-h-screen bg-background font-sans text-text-main",children:[e.jsxs("nav",{className:"bg-paper shadow-sm border-b border-gray-200 px-8 py-4 flex justify-between items-center sticky top-0 z-10",children:[e.jsxs("div",{className:"flex items-center space-x-2",children:[e.jsx("div",{className:"bg-primary p-2 rounded-lg",children:e.jsx(T,{className:"text-white w-6 h-6"})}),e.jsxs("span",{className:"text-xl font-bold text-text-main tracking-tight",children:["SmartExam",e.jsx("span",{className:"text-primary",children:"Pro"})]})]}),e.jsxs("div",{className:"flex items-center space-x-6",children:[e.jsx(K,{compact:!0}),e.jsxs("div",{className:"flex items-center space-x-2 text-sm font-medium text-gray-600 bg-gray-100 px-3 py-1.5 rounded-full",children:[e.jsx(W,{className:"w-4 h-4"}),e.jsx("span",{children:(l==null?void 0:l.full_name)||(r==null?void 0:r.email)})]}),e.jsxs("button",{onClick:P,className:"flex items-center space-x-2 text-danger hover:bg-danger-50 px-4 py-2 rounded-lg transition-colors text-sm font-semibold",children:[e.jsx(Y,{className:"w-4 h-4"}),e.jsx("span",{children:t("auth.logout")})]})]})]}),e.jsxs(u.div,{variants:B,initial:"hidden",animate:"visible",className:"max-w-6xl mx-auto px-8 py-10",children:[e.jsxs("div",{className:"mb-8",children:[e.jsxs("h1",{className:"text-3xl font-bold text-text-main",children:[t("dashboard.hello"),", ",((C=l==null?void 0:l.full_name)==null?void 0:C.split(" ").pop())||t("auth.student"),"! ðŸ‘‹"]}),e.jsx("p",{className:"text-gray-500 mt-2",children:t("dashboard.selectExam")})]}),N.length>0&&e.jsxs(u.div,{variants:y,className:"mb-10",children:[e.jsxs("div",{onClick:()=>I(!v),className:"flex items-center justify-between cursor-pointer mb-4 group",children:[e.jsxs("div",{className:"flex items-center space-x-2",children:[e.jsx(Z,{className:"w-6 h-6 text-primary"}),e.jsx("h2",{className:"text-xl font-bold text-text-main",children:t("dashboard.myClasses")||"Lá»›p há»c cá»§a tÃ´i"}),e.jsx("span",{className:"bg-primary-100 text-primary-700 text-xs font-bold px-2 py-0.5 rounded-full",children:N.length})]}),e.jsx(te,{className:`w-5 h-5 text-gray-400 transition-transform ${v?"rotate-90":""}`})]}),e.jsx(X,{children:v&&e.jsx(u.div,{initial:{height:0,opacity:0},animate:{height:"auto",opacity:1},exit:{height:0,opacity:0},transition:{duration:.2},className:"overflow-hidden",children:e.jsx("div",{className:"grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4",children:N.map(s=>{var a,c,i,o;return e.jsxs(u.div,{variants:y,className:"bg-paper rounded-xl border border-gray-100 p-4 hover:shadow-soft transition-all",children:[e.jsx("div",{className:"flex items-start justify-between mb-2",children:e.jsxs("div",{className:"flex items-center space-x-2",children:[e.jsx(ee,{className:"w-5 h-5 text-primary"}),e.jsx("span",{className:`text-xs font-bold px-2 py-0.5 rounded-full ${s.status==="active"?"bg-success-100 text-success-700":s.status==="completed"?"bg-primary-100 text-primary-700":"bg-gray-100 text-gray-600"}`,children:s.status==="active"?t("student.statusActive")||"Äang há»c":s.status==="completed"?t("class.status.completed")||"HoÃ n thÃ nh":t("class.status.dropped")||"ÄÃ£ rá»i"})]})}),e.jsx("h3",{className:"font-bold text-text-main mb-1 line-clamp-2",children:((a=s.class)==null?void 0:a.name)||"N/A"}),e.jsxs("div",{className:"text-xs text-gray-500 space-y-1",children:[e.jsxs("p",{className:"flex items-center space-x-1",children:[e.jsxs("span",{className:"font-medium",children:[t("class.code")||"MÃ£ lá»›p",":"]}),e.jsx("span",{children:((c=s.class)==null?void 0:c.code)||"N/A"})]}),((i=s.class)==null?void 0:i.instructor)&&e.jsxs("p",{className:"flex items-center space-x-1",children:[e.jsx(se,{className:"w-3 h-3"}),e.jsx("span",{children:s.class.instructor.full_name||s.class.instructor.email})]}),((o=s.class)==null?void 0:o.semester)&&e.jsxs("p",{children:[s.class.semester," - ",s.class.academic_year||""]})]}),e.jsxs("div",{className:"mt-3 pt-3 border-t border-gray-100 text-xs text-gray-400",children:[t("student.enrolledAt")||"Tham gia",": ",new Date(s.enrolled_at).toLocaleDateString("vi-VN")]})]},s.id)})})})})]}),j.length>0?e.jsx("div",{className:"grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6",children:j.map(s=>{var i,o,n;const a=U(s),c=a.icon;return e.jsxs(u.div,{variants:y,className:`card hover:shadow-soft transition-all group ${a.canTake?"":"opacity-75"}`,children:[e.jsxs("div",{className:"flex justify-between items-start mb-4",children:[e.jsx("div",{className:`px-3 py-1 rounded-full text-xs font-bold uppercase tracking-wider ${a.color}`,children:a.label}),e.jsx(c,{className:`w-5 h-5 ${a.type==="active"?"text-primary":a.type==="completed"?"text-success":"text-gray-400"}`})]}),e.jsx("h3",{className:`text-xl font-bold mb-2 ${a.canTake?"text-text-main group-hover:text-primary":"text-gray-700"} transition-colors`,children:s.title}),e.jsxs("div",{className:"space-y-1 text-sm text-gray-500 mb-4",children:[e.jsxs("p",{children:[t("exam.course"),": ",((i=s.class)==null?void 0:i.name)||"N/A"]}),e.jsxs("p",{children:[t("exam.code"),": ",((o=s.class)==null?void 0:o.code)||"N/A"]}),e.jsxs("p",{className:"flex items-center space-x-1",children:[e.jsx(D,{className:"w-4 h-4"}),e.jsxs("span",{children:[t("exam.duration"),": ",s.duration_minutes," ",t("exam.minutes")]})]})]}),a.type==="completed"&&((n=s.session)==null?void 0:n.percentage)!==null&&e.jsx("div",{className:"mb-4 p-3 bg-success-50 rounded-lg",children:e.jsxs("p",{className:"text-sm text-gray-600",children:[t("exam.score"),": ",e.jsxs("span",{className:"font-bold text-success-700",children:[s.session.percentage.toFixed(1),"%"]})]})}),a.type==="upcoming"&&e.jsx("div",{className:"mb-4 p-3 bg-gray-50 rounded-lg text-xs text-gray-500",children:e.jsxs("p",{children:[t("exam.startTime"),": ",R(s.start_time)]})}),a.canTake?e.jsxs("button",{onClick:()=>b(`/exam/${s.id}`),className:"w-full flex items-center justify-center space-x-2 btn-primary py-3",children:[e.jsx(f,{className:"w-5 h-5"}),e.jsx("span",{children:t("dashboard.enterExam")})]}):a.type==="completed"&&s.allow_review?e.jsx("button",{className:"w-full btn-secondary py-3",children:t("dashboard.reviewExam")}):e.jsx("button",{disabled:!0,className:"w-full bg-gray-200 text-gray-500 py-3 rounded-xl font-semibold cursor-not-allowed",children:a.type==="upcoming"?t("dashboard.notStarted"):a.type==="ended"?t("dashboard.expired"):t("dashboard.notAvailable")})]},s.id)})}):e.jsxs("div",{className:"text-center py-16 bg-paper rounded-2xl border border-gray-100",children:[e.jsx(T,{className:"w-20 h-20 mx-auto mb-4 text-gray-300"}),e.jsx("h2",{className:"text-xl font-bold text-gray-700 mb-2",children:t("dashboard.noExams")}),e.jsx("p",{className:"text-gray-500",children:t("dashboard.noExamsDesc")})]}),j.length===0&&e.jsxs("div",{className:"mt-8",children:[e.jsx("p",{className:"text-sm text-gray-500 mb-4",children:t("dashboard.demoExam")}),e.jsxs(u.div,{variants:y,className:"card hover:shadow-soft transition-all group max-w-md",children:[e.jsxs("div",{className:"flex justify-between items-start mb-4",children:[e.jsx("div",{className:"bg-primary-100 text-primary-700 px-3 py-1 rounded-full text-xs font-bold uppercase tracking-wider",children:"Demo"}),e.jsx(f,{className:"w-5 h-5 text-primary"})]}),e.jsx("h3",{className:"text-xl font-bold text-text-main mb-2 group-hover:text-primary transition-colors",children:"TrÃ­ tuá»‡ nhÃ¢n táº¡o (AI)"}),e.jsxs("p",{className:"text-gray-500 text-sm mb-6",children:[t("exam.code"),": INT3401 â€¢ ",t("exam.duration"),": 45 ",t("exam.minutes")]}),e.jsxs("button",{onClick:()=>b("/exam/demo"),className:"w-full flex items-center justify-center space-x-2 btn-primary py-3",children:[e.jsx(f,{className:"w-5 h-5"}),e.jsx("span",{children:t("dashboard.enterExam")})]})]})]})]})]})}export{me as default};
