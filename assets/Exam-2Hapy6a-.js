import{c as L,d as Mt,u as At,a as Tt,r as i,b as Dt,B as c,t as f,s as v,j as e,T as xe}from"./index-DJ_vdbw9.js";import{S as Qe,b as Ye,c as ge,C as pe,F as Ze,a as It}from"./FaceVerification-Fm_SFaj-.js";import{m as U,L as ye,A as se}from"./proxy-DchzCbfh.js";import{C as Ft}from"./chevron-right-CEez1eiP.js";import{E as Rt,a as Lt}from"./eye-CDyFPUFa.js";/**
 * @license lucide-react v0.468.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const Ot=L("ChevronLeft",[["path",{d:"m15 18-6-6 6-6",key:"1wnfg3"}]]);/**
 * @license lucide-react v0.468.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const qt=L("FlagOff",[["path",{d:"M8 2c3 0 5 2 8 2s4-1 4-1v11",key:"9rwyz9"}],["path",{d:"M4 22V4",key:"1plyxx"}],["path",{d:"M4 15s1-1 4-1 5 2 8 2",key:"1myooe"}],["line",{x1:"2",x2:"22",y1:"2",y2:"22",key:"a6p6uj"}]]);/**
 * @license lucide-react v0.468.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const we=L("Flag",[["path",{d:"M4 15s1-1 4-1 5 2 8 2 4-1 4-1V3s-1 1-4 1-5-2-8-2-4 1-4 1z",key:"i9b6wo"}],["line",{x1:"4",x2:"4",y1:"22",y2:"15",key:"1cm3nv"}]]);/**
 * @license lucide-react v0.468.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const Vt=L("Monitor",[["rect",{width:"20",height:"14",x:"2",y:"3",rx:"2",key:"48i651"}],["line",{x1:"8",x2:"16",y1:"21",y2:"21",key:"1svkeh"}],["line",{x1:"12",x2:"12",y1:"17",y2:"21",key:"vw1qmm"}]]);/**
 * @license lucide-react v0.468.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const Xe=L("Send",[["path",{d:"M14.536 21.686a.5.5 0 0 0 .937-.024l6.5-19a.496.496 0 0 0-.635-.635l-19 6.5a.5.5 0 0 0-.024.937l7.93 3.18a2 2 0 0 1 1.112 1.11z",key:"1ffxy3"}],["path",{d:"m21.854 2.147-10.94 10.939",key:"12cjpa"}]]);/**
 * @license lucide-react v0.468.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const Pt=L("StickyNote",[["path",{d:"M16 3H5a2 2 0 0 0-2 2v14a2 2 0 0 0 2 2h14a2 2 0 0 0 2-2V8Z",key:"qazsjp"}],["path",{d:"M15 3v4a2 2 0 0 0 2 2h4",key:"40519r"}]]);/**
 * @license lucide-react v0.468.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const Je=L("WifiOff",[["path",{d:"M12 20h.01",key:"zekei9"}],["path",{d:"M8.5 16.429a5 5 0 0 1 7 0",key:"1bycff"}],["path",{d:"M5 12.859a10 10 0 0 1 5.17-2.69",key:"1dl1wf"}],["path",{d:"M19 12.859a10 10 0 0 0-2.007-1.523",key:"4k23kn"}],["path",{d:"M2 8.82a15 15 0 0 1 4.177-2.643",key:"1grhjp"}],["path",{d:"M22 8.82a15 15 0 0 0-11.288-3.764",key:"z3jwby"}],["path",{d:"m2 2 20 20",key:"1ooewy"}]]);/**
 * @license lucide-react v0.468.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const Ht=L("Wifi",[["path",{d:"M12 20h.01",key:"zekei9"}],["path",{d:"M2 8.82a15 15 0 0 1 20 0",key:"dnpr2z"}],["path",{d:"M5 12.859a10 10 0 0 1 14 0",key:"1x1e6c"}],["path",{d:"M8.5 16.429a5 5 0 0 1 7 0",key:"1bycff"}]]),Ut=["teamviewer","anydesk","ultraviewer","parsec","vnc","remotedesktop","citrix","logmein","splashtop","chrome remote","microsoft remote","rdp","ammyy","supremo"],be=typeof navigator<"u"&&/^((?!chrome|android).)*safari/i.test(navigator.userAgent),et=["demo","1"],tt=["demo-session","demo-session-id"],$t=3e4,st="SUBMIT_TIMEOUT";function Zt(){const{id:x}=Mt(),{user:j,profile:zt}=At(),{t:n}=Tt(),g=i.useRef(null),A=i.useRef(null),re=i.useRef(null);i.useRef(null);const K=i.useRef(!1),T=Dt(),[E,ve]=i.useState(null),[k,je]=i.useState([]),[D,rt]=i.useState(0),[_,Ne]=i.useState({}),[C,_e]=i.useState(new Set),[I,Ee]=i.useState({}),[h,B]=i.useState(null),[ne,Q]=i.useState(null),[nt,at]=i.useState(!1),[it,ke]=i.useState(null),[Se,Ce]=i.useState(0),[Me,ct]=i.useState(0),[Ae,ot]=i.useState(0),[Te,lt]=i.useState(0),[Y,$]=i.useState(!1),[z,ae]=i.useState("verify"),[ie,De]=i.useState(null),[Wt,dt]=i.useState(0),[Z,X]=i.useState(null),[J,Ie]=i.useState(!navigator.onLine),[mt,ce]=i.useState(!1),[Fe,oe]=i.useState(!1),[Re,ut]=i.useState(!1),[p,Le]=i.useState(!1),[F,Oe]=i.useState(!1),[M,O]=i.useState("loading"),[qe,ft]=i.useState(!1),[le,ht]=i.useState(!0),y=k[D],xt=i.useCallback(()=>{const t=navigator.userAgent.toLowerCase();for(const o of Ut)if(t.includes(o))return!0;const r=window.screen.width/window.screen.height,s=window.innerWidth/window.innerHeight;Math.abs(r-s)>.2&&console.warn("Suspicious screen ratio detected");try{const o=document.createElement("canvas"),a=o.getContext("webgl")||o.getContext("experimental-webgl");if(a){const l=a.getExtension("WEBGL_debug_renderer_info");if(l){const m=a.getParameter(l.UNMASKED_RENDERER_WEBGL).toLowerCase(),w=["vmware","virtualbox","parallels","hyper-v","swiftshader","llvmpipe"];for(const u of w)if(m.includes(u))return console.warn("Virtual machine renderer detected:",m),!0}}}catch(o){console.warn("WebGL check failed:",o)}return!1},[]),gt=i.useCallback(async()=>{try{if("isExtended"in window.screen&&window.screen.isExtended)return oe(!0),c.error("PH√ÅT HI·ªÜN 2 M√ÄN H√åNH! Vui l√≤ng ng·∫Øt k·∫øt n·ªëi m√†n h√¨nh ph·ª• ƒë·ªÉ thi.",{autoClose:!1}),!1;if("getScreenDetails"in window)try{const t=await window.getScreenDetails();if(t&&t.screens.length>1)return oe(!0),c.error(`PH√ÅT HI·ªÜN ${t.screens.length} M√ÄN H√åNH! Nghi v·∫•n gian l·∫≠n.`,{autoClose:!1}),!1}catch{console.warn("Screen details permission denied")}}catch(t){console.warn("Screen API not supported",t)}return oe(!1),!0},[]),Ve=async()=>{try{const t=document.documentElement;t.requestFullscreen?await t.requestFullscreen():t.webkitRequestFullscreen?await t.webkitRequestFullscreen():t.mozRequestFullScreen?await t.mozRequestFullScreen():t.msRequestFullscreen&&await t.msRequestFullscreen(),ce(!0)}catch{be?(console.warn("Safari fullscreen not fully supported, continuing without fullscreen requirement"),ce(!0)):c.error(n("anticheat.fullscreenRequired"))}};i.useEffect(()=>{const t=()=>{const r=!!(document.fullscreenElement||document.webkitFullscreenElement||document.mozFullScreenElement||document.msFullscreenElement);if(ce(r),be){console.log("Safari fullscreen state change - skipping violation check");return}!r&&p&&!K.current&&ot(s=>{const o=s+1;return c.error(f("anticheat.fullscreenExit",{count:o})),V("fullscreen_exit",{count:o}),o})};return document.addEventListener("fullscreenchange",t),document.addEventListener("webkitfullscreenchange",t),document.addEventListener("mozfullscreenchange",t),document.addEventListener("MSFullscreenChange",t),()=>{document.removeEventListener("fullscreenchange",t),document.removeEventListener("webkitfullscreenchange",t),document.removeEventListener("mozfullscreenchange",t),document.removeEventListener("MSFullscreenChange",t)}},[p]),i.useEffect(()=>{const t=()=>{document.hidden&&p&&!K.current&&ct(r=>{const s=r+1;return c.warning(f("anticheat.tabSwitch",{count:s})),V("tab_switch",{count:s}),s})};return document.addEventListener("visibilitychange",t),()=>document.removeEventListener("visibilitychange",t)},[p]),i.useEffect(()=>{if(!p)return;const t=s=>{var a;const o=[{ctrl:!0,key:"c"},{ctrl:!0,key:"v"},{ctrl:!0,key:"p"},{ctrl:!0,key:"s"},{ctrl:!0,key:"f"},{ctrl:!0,shift:!0,key:"i"},{key:"F12"},{alt:!0,key:"Tab"},{key:"PrintScreen"}];for(const l of o)if((!l.ctrl||s.ctrlKey)&&(!l.shift||s.shiftKey)&&(!l.alt||s.altKey)&&(s.key.toLowerCase()===((a=l.key)==null?void 0:a.toLowerCase())||s.key===l.key)&&l.key){s.preventDefault(),c.warning("Ph√≠m t·∫Øt b·ªã v√¥ hi·ªáu h√≥a trong ph√≤ng thi!"),V("keyboard_shortcut",{key:s.key,ctrl:s.ctrlKey,alt:s.altKey,shift:s.shiftKey});return}},r=s=>{s.preventDefault(),c.warning("Click chu·ªôt ph·∫£i b·ªã v√¥ hi·ªáu h√≥a!"),V("right_click",{})};return document.addEventListener("keydown",t),document.addEventListener("contextmenu",r),()=>{document.removeEventListener("keydown",t),document.removeEventListener("contextmenu",r)}},[p]);const R=i.useRef(null),q=i.useRef(null),G=i.useRef(null),W=i.useRef(null),de=t=>{R.current=t,g.current&&(g.current.srcObject=t),G.current||(G.current=document.createElement("canvas"),G.current.width=640,G.current.height=480,W.current=G.current.getContext("2d",{willReadFrequently:!0}))},Pe=async()=>{O("loading");try{R.current&&R.current.getTracks().forEach(s=>s.stop());const t={video:{width:{ideal:640,min:320},height:{ideal:480,min:240},facingMode:"user"},audio:!1},r=await navigator.mediaDevices.getUserMedia(t);de(r),O("ready"),c.success(n("proctoring.camera")+" OK")}catch(t){console.error("Camera retry error:",t),O("error"),c.error(n("anticheat.cameraAccess"))}};i.useEffect(()=>((async()=>{O("loading");try{const r={video:{width:{ideal:640,min:320},height:{ideal:480,min:240},facingMode:"user"},audio:!1},s=await navigator.mediaDevices.getUserMedia(r);de(s),O("ready")}catch(r){if(console.error("Camera access error:",r),O("error"),r.name==="NotAllowedError"||r.name==="PermissionDeniedError")c.error(n("anticheat.cameraAccess")+" (Permission denied)");else if(r.name==="NotFoundError"||r.name==="DevicesNotFoundError")c.error(n("anticheat.cameraAccess")+" (No camera found)");else if(r.name==="NotReadableError"||r.name==="TrackStartError")c.error(n("anticheat.cameraAccess")+" (Camera in use by another app)");else if(r.name==="OverconstrainedError")try{const s=await navigator.mediaDevices.getUserMedia({video:!0});de(s),O("ready")}catch(s){console.error("Camera fallback failed:",s),c.error(n("anticheat.cameraAccess"))}else c.error(n("anticheat.cameraAccess"))}})(),()=>{R.current&&R.current.getTracks().forEach(r=>r.stop())}),[]);const pt=[50,100,200,500,1e3],yt=3e3,wt=250,bt=t=>{if(!t)return!1;const r=t.getTracks();return r.length>0&&r.some(s=>s.readyState==="live")};i.useEffect(()=>{const t=()=>{if(R.current&&g.current){const a=R.current,l=g.current;if(!bt(a)){console.warn("[Exam] Camera stream is not active, attempting to restart camera"),Pe();return}l.srcObject!==a&&(console.log("[Exam] Attaching camera stream to video element"),l.srcObject=a),(l.paused||l.readyState<HTMLMediaElement.HAVE_CURRENT_DATA)&&l.play().catch(m=>{console.warn("Video play failed:",m),l.muted=!0,l.play().catch(()=>{})})}};t();const r=pt.map(a=>setTimeout(t,a)),s=setInterval(()=>{g.current&&R.current&&(t(),g.current.readyState>=HTMLMediaElement.HAVE_CURRENT_DATA&&clearInterval(s))},wt),o=setTimeout(()=>{clearInterval(s)},yt);return()=>{r.forEach(a=>clearTimeout(a)),clearInterval(s),clearTimeout(o)}},[p]),i.useEffect(()=>{const t=()=>{Ie(!1),c.success(f("anticheat.networkOnline"))},r=()=>{Ie(!0),c.error(f("anticheat.networkOffline"))};window.addEventListener("online",t),window.addEventListener("offline",r);const s=u=>{const{code:d,payload:N,detectedClass:b,confidence:S,count:P}=u,ee={phone:f("anticheat.phoneDetected"),material:f("anticheat.materialDetected"),headphones:f("anticheat.headphonesDetected"),person:f("anticheat.noFace")},te={lookAtScreen:f("anticheat.lookAtScreen"),NO_FACE:f("anticheat.noFace"),LOOK_RIGHT:f("anticheat.lookRight"),LOOK_LEFT:f("anticheat.lookLeft"),LOOK_DOWN:f("anticheat.lookDown"),LOOK_UP:f("anticheat.lookUp"),GAZE_LEFT:f("anticheat.gazeLeft"),GAZE_RIGHT:f("anticheat.gazeRight"),speakingDetected:f("anticheat.speakingDetected"),multiPerson:f("anticheat.multiPerson",{count:P||2}),phoneDetected:f("anticheat.phoneDetected"),materialDetected:f("anticheat.materialDetected"),headphonesDetected:f("anticheat.headphonesDetected"),monitoring:f("anticheat.monitoring"),aiLoading:f("anticheat.aiLoading"),yoloLoading:f("anticheat.yoloLoading"),basicMode:f("anticheat.basicMode"),faceOnly:f("anticheat.faceOnly"),yoloOnly:f("anticheat.yoloOnly")};return d==="detection"&&b&&ee[b]?`${ee[b]} (${((S||0)*100).toFixed(0)}%)`:te[d]||te[N]||N};A.current=new Worker(new URL("/assets/ai.worker-VDgijyw7.js",import.meta.url),{type:"module"}),A.current.onmessage=u=>{const{type:d,payload:N,code:b}=u.data,S=s(u.data);d==="STATUS"?ke(S):d==="ALERT"?(Ce(P=>P+1),c.warning(`${f("anticheat.aiWarning")}: ${S}`),V("ai_alert",{message:N,code:b})):d==="GAZE_AWAY"&&lt(P=>P+1)},A.current.onerror=u=>{console.error("AI Worker error:",u),ke("AI Worker error - basic mode")};const o=[200,500,1e3,1500,2e3],a=200,l=()=>{var u,d,N;if(!q.current)return!g.current||!W.current||!A.current?(console.log("üé¨ Frame processing prerequisites not met yet"),!1):g.current.readyState<HTMLMediaElement.HAVE_CURRENT_DATA?(console.log("üé¨ Video not ready yet, readyState:",g.current.readyState),!1):(console.log("üé¨ Starting AI frame processing..."),console.log("   Video ready:",!!g.current,"readyState:",(u=g.current)==null?void 0:u.readyState),console.log("   Video dimensions:",(d=g.current)==null?void 0:d.videoWidth,"x",(N=g.current)==null?void 0:N.videoHeight),console.log("   Canvas context ready:",!!W.current),console.log("   Worker ready:",!!A.current),q.current=setInterval(()=>{if(g.current&&A.current&&W.current&&!K.current)try{if(g.current.readyState>=HTMLMediaElement.HAVE_CURRENT_DATA&&g.current.videoWidth>0){W.current.drawImage(g.current,0,0,640,480);const b=W.current.getImageData(0,0,640,480);b.data&&b.data.length>0&&A.current.postMessage({type:"PROCESS_FRAME",payload:b},[b.data.buffer])}}catch(b){console.warn("Error sending frame to worker:",b)}},a),!0)},m=[];let w=null;return p&&M==="ready"&&(o.forEach(u=>{const d=setTimeout(()=>{q.current||l()},u);m.push(d)}),w=setInterval(()=>{(q.current||l())&&clearInterval(w)},300),m.push(setTimeout(()=>{w&&clearInterval(w)},5e3))),()=>{window.removeEventListener("online",t),window.removeEventListener("offline",r),m.forEach(u=>clearTimeout(u)),w&&clearInterval(w),q.current&&(clearInterval(q.current),q.current=null),A.current&&A.current.terminate()}},[p,M]),i.useEffect(()=>{if(!(!p||ne===null))return re.current=setInterval(()=>{Q(t=>t<=1?(clearInterval(re.current),ze(),0):(t===300&&(at(!0),c.warning("‚ö†Ô∏è C√≤n 5 ph√∫t! H√£y ki·ªÉm tra l·∫°i b√†i l√†m.")),t===60&&c.error("‚ö†Ô∏è C√≤n 1 ph√∫t!"),t-1))},1e3),()=>clearInterval(re.current)},[p,ne]),i.useEffect(()=>{const t=async()=>{var o;if(x==="demo"||x==="1"){ve({id:x,title:"Tr√≠ tu·ªá nh√¢n t·∫°o (AI) - B√ÄI THI M·∫™U",code:"INT3401",duration_minutes:45,require_camera:!0,require_fullscreen:!0}),je([{id:"1",question_text:"Deep Learning l√† g√¨?",question_type:"multiple_choice",options:[{id:"A",text:"M·ªôt lo·∫°i m√°y h·ªçc d·ª±a tr√™n m·∫°ng n∆°-ron nh√¢n t·∫°o"},{id:"B",text:"M·ªôt ph·∫ßn m·ªÅm ch·ªânh s·ª≠a ·∫£nh"},{id:"C",text:"M·ªôt thu·∫≠t to√°n s·∫Øp x·∫øp"},{id:"D",text:"M·ªôt ng√¥n ng·ªØ l·∫≠p tr√¨nh"}],points:2},{id:"2",question_text:"M·∫°ng n∆°-ron t√≠ch ch·∫≠p (CNN) th∆∞·ªùng ƒë∆∞·ª£c s·ª≠ d·ª•ng cho lo·∫°i d·ªØ li·ªáu n√†o?",question_type:"multiple_choice",options:[{id:"A",text:"D·ªØ li·ªáu vƒÉn b·∫£n"},{id:"B",text:"D·ªØ li·ªáu √¢m thanh"},{id:"C",text:"D·ªØ li·ªáu h√¨nh ·∫£nh"},{id:"D",text:"D·ªØ li·ªáu b·∫£ng"}],points:2},{id:"3",question_text:"H√†m k√≠ch ho·∫°t ReLU c√≥ c√¥ng th·ª©c l√† g√¨?",question_type:"multiple_choice",options:[{id:"A",text:"f(x) = max(0, x)"},{id:"B",text:"f(x) = 1/(1+e^(-x))"},{id:"C",text:"f(x) = tanh(x)"},{id:"D",text:"f(x) = x^2"}],points:2},{id:"4",question_text:"Overfitting x·∫£y ra khi:",question_type:"multiple_choice",options:[{id:"A",text:"Model h·ªçc qu√° t·ªët tr√™n t·∫≠p train nh∆∞ng k√©m tr√™n t·∫≠p test"},{id:"B",text:"Model kh√¥ng h·ªçc ƒë∆∞·ª£c g√¨ t·ª´ d·ªØ li·ªáu"},{id:"C",text:"Model c√≥ qu√° √≠t tham s·ªë"},{id:"D",text:"D·ªØ li·ªáu train qu√° √≠t"}],points:2},{id:"5",question_text:"Transformer ƒë∆∞·ª£c gi·ªõi thi·ªáu trong b√†i b√°o n√†o?",question_type:"multiple_choice",options:[{id:"A",text:"Attention Is All You Need"},{id:"B",text:"ImageNet Classification with Deep CNNs"},{id:"C",text:"Playing Atari with Deep RL"},{id:"D",text:"Generative Adversarial Networks"}],points:2}]),Q(2700),B("demo-session");return}try{const{data:a,error:l}=await v.from("exams").select(`
            *,
            class:classes(name, code)
          `).eq("id",x).single();if(l){console.error("Failed to load exam:",l),c.error(n("error.loadExam")),T("/");return}const m=new Date,w=new Date(a.start_time),u=new Date(a.end_time);if(a.status!=="published"){c.error(n("exam.notPublished")),T("/");return}if(m<w){c.error(n("exam.notStarted")),T("/");return}if(m>u){c.error(n("exam.ended")),T("/");return}ve({id:a.id,title:a.title,code:((o=a.class)==null?void 0:o.code)||"N/A",duration_minutes:a.duration_minutes,require_camera:a.require_camera,require_fullscreen:a.require_fullscreen,max_tab_violations:a.max_tab_violations,max_fullscreen_violations:a.max_fullscreen_violations});const{data:d,error:N}=await v.from("questions").select("id, question_text, question_type, options, points, order_index").eq("exam_id",x).order("order_index");if(N){console.error("Failed to load questions:",N),c.error(n("error.loadQuestions")),T("/");return}const b=a.is_shuffled?r(d):d;je(b),Q(a.duration_minutes*60);const{data:S}=await v.from("exam_sessions").select("id, status, started_at").eq("exam_id",x).eq("student_id",j==null?void 0:j.id).eq("status","in_progress").single();if(S){B(S.id);const P=new Date(S.started_at).getTime(),ee=Date.now(),te=Math.floor((ee-P)/1e3),he=Math.max(0,a.duration_minutes*60-te);if(Q(he),he===0){c.warning(n("exam.timeExpired")),Le(!0),ze();return}const{data:We}=await v.from("answers").select("question_id, student_answer, is_flagged, student_notes").eq("session_id",S.id);if(We){const Ke={},Ge=new Set,Be={};We.forEach(H=>{Ke[H.question_id]=H.student_answer,H.is_flagged&&Ge.add(H.question_id),H.student_notes&&(Be[H.question_id]=H.student_notes)}),Ne(Ke),_e(Ge),Ee(Be)}c.info(n("exam.sessionRestored"))}}catch(a){console.error("Error loading exam:",a),c.error(n("exam.loadError")),T("/")}},r=s=>{const o=[...s];for(let a=o.length-1;a>0;a--){const l=Math.floor(Math.random()*(a+1));[o[a],o[l]]=[o[l],o[a]]}return o};t()},[x,j,T]);const V=async(t,r)=>{if(h&&!(tt.includes(h)||et.includes(x)))try{await v.from("proctoring_logs").insert({session_id:h,event_type:t,details:r,severity:t.includes("detected")?"critical":"warning"})}catch(s){console.warn("Failed to log proctoring event:",(s==null?void 0:s.message)||s)}};i.useEffect(()=>{(async()=>{if(j!=null&&j.id)try{const{data:r}=await v.from("profiles").select("face_embedding").eq("id",j.id).single();r!=null&&r.face_embedding&&De(r.face_embedding)}catch(r){console.warn("Could not load face embedding:",r)}})()},[j==null?void 0:j.id]),i.useEffect(()=>{if(!p||!h||x==="demo"||x==="1")return;const r=180*1e3;console.log("[Face Verification] Setting up 3-minute interval checks");const s=setInterval(()=>{p&&!F&&!Y&&(console.log("[Face Verification] Triggering random check (3-min interval)"),vt())},r);return()=>{clearInterval(s)}},[p,h,x,F,Y]);const vt=()=>{ae("random"),$(!0),V("face_verification_triggered",{type:"random"})},He=async t=>{if($(!1),dt(r=>r+1),h&&h!=="demo-session-id")try{await v.rpc("log_face_verification",{p_session_id:h,p_verification_type:z,p_similarity_score:t||1,p_is_match:!0})}catch(r){console.warn("Could not log face verification:",r)}c.success(n("face.success")),Z&&(Z(),X(null))},Ue=async(t,r)=>{if(h&&h!=="demo-session-id")try{await v.rpc("log_face_verification",{p_session_id:h,p_verification_type:z,p_similarity_score:r||0,p_is_match:!1,p_error_reason:t})}catch(s){console.warn("Could not log face verification:",s)}V("face_verification_failed",{reason:t,similarity:r,type:z}),z==="random"&&(c.warning(n("face.mismatch")),Ce(s=>s+1),$(!1))},$e=async(t,r)=>{if(De(t),$(!1),j!=null&&j.id)try{await v.rpc("update_face_embedding",{p_embedding:t,p_image_url:r})}catch(s){console.warn("Could not save face embedding:",s)}c.success(n("face.enrollSuccess")),Z&&(Z(),X(null))},jt=(t,r)=>{Ne(s=>({...s,[t]:r}))},Nt=t=>{_e(r=>{const s=new Set(r);return s.has(t)?s.delete(t):s.add(t),s})},_t=(t,r)=>{Ee(s=>({...s,[t]:r}))},me=t=>{t>=0&&t<k.length&&rt(t)},Et=()=>me(D+1),kt=()=>me(D-1);i.useEffect(()=>{if(!p||!h||x==="demo"||x==="1")return;let r={..._},s=new Set(C),o={...I};const l=setInterval(async()=>{try{const m=k.filter(d=>{const N=_[d.id]!==r[d.id],b=C.has(d.id)!==s.has(d.id),S=I[d.id]!==o[d.id];return N||b||S});if(m.length===0)return;const w=m.map(d=>({session_id:h,question_id:d.id,student_answer:_[d.id]||null,is_flagged:C.has(d.id),student_notes:I[d.id]||null})),{error:u}=await v.from("answers").upsert(w,{onConflict:"session_id,question_id"});if(u)throw u;r={..._},s=new Set(C),o={...I}}catch(m){console.error("Auto-save error:",m)}},3e4);return()=>clearInterval(l)},[p,h,x,k,_,C,I]);const ze=async()=>{c.warning(n("exam.timeUp")),await ue(!0)},ue=async(t=!1)=>{if(!F){if(!t){const r=k.filter(a=>!_[a.id]).length,s=C.size;let o=n("exam.submitConfirm");if(r>0&&(o+=`

‚ö†Ô∏è ${r} ${n("exam.unansweredWarning")}`),s>0&&(o+=`
‚ö†Ô∏è ${s} ${n("exam.flaggedWarning")}`),!window.confirm(o))return}Oe(!0),K.current=!0;try{if(et.includes(x)||tt.includes(h)){const s={1:"A",2:"C",3:"A",4:"A",5:"A"};let o=0,a=0;k.forEach(m=>{a+=m.points,_[m.id]===s[m.id]&&(o+=m.points)}),await new Promise(m=>setTimeout(m,500));const l=a>0?(o/a*100).toFixed(1):0;c.success(`${n("exam.submitSuccess")} ${n("exam.score")}: ${o}/${a} (${l}%)`)}else{const s=async()=>{const l=k.map(u=>({session_id:h,question_id:u.id,student_answer:_[u.id]||null,is_flagged:C.has(u.id),student_notes:I[u.id]||null})),{error:m}=await v.from("answers").upsert(l,{onConflict:"session_id,question_id"});if(m)throw console.error("Error saving answers:",m),new Error(n("exam.submitError"));const{error:w}=await v.from("exam_sessions").update({cheat_count:Se,tab_violations:Me,fullscreen_violations:Ae,gaze_away_count:Te}).eq("id",h);w&&console.error("Error saving violations:",w);try{const{data:u,error:d}=await v.rpc("submit_exam",{p_session_id:h,p_auto_submit:t});if(d){console.warn("RPC submit_exam failed, using direct update:",d);const{error:N}=await v.from("exam_sessions").update({status:t?"auto_submitted":"submitted",submitted_at:new Date().toISOString()}).eq("id",h);if(N)throw N;return{success:!0,fallback:!0}}return u}catch(u){console.warn("RPC call failed, using fallback:",u);const{error:d}=await v.from("exam_sessions").update({status:t?"auto_submitted":"submitted",submitted_at:new Date().toISOString()}).eq("id",h);if(d)throw d;return{success:!0,fallback:!0}}},o=new Promise((l,m)=>setTimeout(()=>m(new Error(st)),$t)),a=await Promise.race([s(),o]);if(a&&a.percentage!==void 0){const l=a.percentage||0,m=a.passed;c.success(`${n("exam.submitSuccess")} ${n("exam.score")}: ${l.toFixed(1)}% ${m?"‚úì":"‚úó"}`)}else c.success(n("exam.submitSuccess"))}try{(document.fullscreenElement||document.webkitFullscreenElement)&&(document.exitFullscreen?await document.exitFullscreen():document.webkitExitFullscreen&&await document.webkitExitFullscreen())}catch(s){console.warn("Error exiting fullscreen:",s)}T("/")}catch(r){console.error("Submit error:",r),r.message===st?c.error(n("error.timeout")):c.error(n("exam.submitError"))}finally{Oe(!1),K.current=!1}}},St=async()=>{if(xt()){ut(!0),c.error(n("anticheat.remoteDesktop"),{autoClose:!1});return}if(!await gt())return;if(await Ve(),!(x==="demo"||x==="1")&&(E==null?void 0:E.require_camera)!==!1)if(ie){ae("verify"),X(()=>fe),$(!0);return}else{ae("enroll"),X(()=>fe),$(!0);return}await fe()},fe=async()=>{if(x==="demo"||x==="1")B("demo-session-id");else if(!h&&j)try{const{data:r,error:s}=await v.rpc("start_exam_session",{p_exam_id:x,p_user_agent:navigator.userAgent,p_ip_address:null});if(s){console.error("Failed to create session:",s),s.message.includes("Maximum attempts")?c.error(n("error.general")):s.message.includes("not enrolled")?c.error(n("error.permission")):c.error(n("error.general"));return}B(r)}catch(r){console.error("Session creation error:",r),c.error(n("error.general"));return}Le(!0),c.info(n("common.success"))},Ct=t=>{const r=Math.floor(t/60),s=t%60;return`${r.toString().padStart(2,"0")}:${s.toString().padStart(2,"0")}`};return p?e.jsxs("div",{className:"flex h-screen bg-background no-select",children:[e.jsx(se,{children:Y&&e.jsx(U.div,{initial:{opacity:0},animate:{opacity:1},exit:{opacity:0},className:"fixed inset-0 bg-black/70 z-[100] flex items-center justify-center p-4",children:e.jsx(Ze,{mode:z,storedEmbedding:ie,onSuccess:He,onFailure:Ue,onEnrollComplete:$e})})}),e.jsxs(se,{children:[J&&e.jsx(U.div,{initial:{height:0},animate:{height:"auto"},exit:{height:0},className:"fixed top-0 left-0 right-0 bg-danger text-white text-center font-bold z-50",children:e.jsxs("div",{className:"flex items-center justify-center space-x-2 p-2",children:[e.jsx(Je,{className:"w-5 h-5"}),e.jsx("span",{children:n("anticheat.networkOffline")})]})}),!mt&&!F&&!be&&e.jsxs(U.div,{initial:{opacity:0},animate:{opacity:1},className:"fixed inset-0 bg-black/95 z-40 flex items-center justify-center text-white flex-col",children:[e.jsx(xe,{className:"w-20 h-20 text-danger mb-4 animate-bounce"}),e.jsxs("h2",{className:"text-3xl font-bold mb-4",children:["‚ö†Ô∏è ",n("anticheat.violation")]}),e.jsx("p",{className:"mb-6 text-gray-300",children:n("anticheat.returnFullscreen")}),e.jsx("button",{onClick:Ve,className:"btn-danger px-8 py-3 text-lg",children:n("anticheat.fullscreenReturn")})]})]}),e.jsxs("div",{className:"flex-1 flex flex-col overflow-hidden",children:[e.jsxs("header",{className:"bg-paper border-b border-gray-200 px-6 py-3 flex items-center justify-between flex-shrink-0",children:[e.jsxs("div",{children:[e.jsx("h1",{className:"text-lg font-bold text-text-main",children:E==null?void 0:E.title}),e.jsxs("p",{className:"text-sm text-gray-500",children:[n("exam.code"),": ",E==null?void 0:E.code]})]}),e.jsxs("div",{className:"flex items-center space-x-4",children:[e.jsxs("div",{className:`flex items-center space-x-1 text-sm ${J?"text-danger":"text-success"}`,children:[J?e.jsx(Je,{className:"w-4 h-4"}):e.jsx(Ht,{className:"w-4 h-4"}),e.jsx("span",{children:J?"Offline":"Online"})]}),e.jsxs("div",{className:`flex items-center space-x-2 px-4 py-2 rounded-lg font-mono text-lg font-bold ${nt?"bg-danger-100 text-danger animate-pulse":"bg-primary-50 text-primary"}`,children:[e.jsx(It,{className:"w-5 h-5"}),e.jsx("span",{children:Ct(ne||0)})]})]})]}),e.jsx("div",{className:"flex-1 overflow-y-auto p-6",children:y&&e.jsxs(U.div,{initial:{opacity:0,x:20},animate:{opacity:1,x:0},className:"max-w-3xl mx-auto",children:[e.jsxs("div",{className:"flex items-center justify-between mb-4",children:[e.jsxs("div",{className:"flex items-center space-x-3",children:[e.jsx("span",{className:"inline-flex items-center justify-center w-10 h-10 bg-primary text-white font-bold rounded-full",children:D+1}),e.jsxs("div",{children:[e.jsxs("span",{className:"text-sm text-gray-500",children:["C√¢u ",D+1,"/",k.length]}),e.jsxs("span",{className:"text-sm text-gray-400 ml-2",children:["(",y.points," ƒëi·ªÉm)"]})]})]}),e.jsx("button",{onClick:()=>Nt(y.id),className:`flex items-center space-x-1 px-3 py-1.5 rounded-lg transition-colors ${C.has(y.id)?"bg-warning-100 text-warning-700":"bg-gray-100 text-gray-600 hover:bg-gray-200"}`,children:C.has(y.id)?e.jsxs(e.Fragment,{children:[e.jsx(we,{className:"w-4 h-4"}),e.jsx("span",{className:"text-sm font-medium",children:"ƒê√£ g·∫Øn c·ªù"})]}):e.jsxs(e.Fragment,{children:[e.jsx(qt,{className:"w-4 h-4"}),e.jsx("span",{className:"text-sm font-medium",children:"G·∫Øn c·ªù"})]})})]}),e.jsxs("div",{className:"card mb-4",children:[e.jsx("h2",{className:"text-lg font-semibold text-text-main mb-6",children:y.question_text}),e.jsx("div",{className:"space-y-3",children:y.options.map(t=>e.jsxs("label",{className:`flex items-center p-4 border-2 rounded-xl cursor-pointer transition-all ${_[y.id]===t.id?"border-primary bg-primary-50":"border-gray-200 hover:border-primary-300 hover:bg-gray-50"}`,children:[e.jsx("input",{type:"radio",name:`question-${y.id}`,value:t.id,checked:_[y.id]===t.id,onChange:()=>jt(y.id,t.id),className:"sr-only"}),e.jsx("div",{className:`w-8 h-8 rounded-full border-2 flex items-center justify-center mr-4 flex-shrink-0 ${_[y.id]===t.id?"border-primary bg-primary text-white":"border-gray-300"}`,children:e.jsx("span",{className:"font-semibold",children:t.id})}),e.jsx("span",{className:"text-gray-700",children:t.text})]},t.id))})]}),e.jsxs("div",{className:"card",children:[e.jsxs("button",{onClick:()=>ft(!qe),className:"flex items-center space-x-2 text-gray-600 hover:text-primary transition-colors",children:[e.jsx(Pt,{className:"w-5 h-5"}),e.jsx("span",{className:"font-medium",children:"Ghi ch√∫ nh√°p"}),I[y.id]&&e.jsx("span",{className:"w-2 h-2 bg-primary rounded-full"})]}),e.jsx(se,{children:qe&&e.jsx(U.div,{initial:{height:0,opacity:0},animate:{height:"auto",opacity:1},exit:{height:0,opacity:0},className:"overflow-hidden",children:e.jsx("textarea",{placeholder:"Ghi ch√∫ c√° nh√¢n cho c√¢u h·ªèi n√†y... (ch·ªâ b·∫°n th·∫•y)",value:I[y.id]||"",onChange:t=>_t(y.id,t.target.value),className:"w-full mt-3 p-3 border border-gray-200 rounded-lg resize-none focus:outline-none focus:ring-2 focus:ring-primary-500",rows:3})})})]}),e.jsxs("div",{className:"flex items-center justify-between mt-6",children:[e.jsxs("button",{onClick:kt,disabled:D===0,className:"btn-secondary disabled:opacity-50 disabled:cursor-not-allowed",children:[e.jsx(Ot,{className:"w-5 h-5 mr-1"}),n("common.previous")]}),D===k.length-1?e.jsxs("button",{onClick:()=>ue(!1),disabled:F,className:"btn-success",children:[F?e.jsx(ye,{className:"w-5 h-5 mr-2 animate-spin"}):e.jsx(Xe,{className:"w-5 h-5 mr-2"}),n("common.submit")]}):e.jsxs("button",{onClick:Et,className:"btn-primary",children:[n("common.next"),e.jsx(Ft,{className:"w-5 h-5 ml-1"})]})]})]},y.id)})]}),e.jsxs("div",{className:"w-80 bg-paper border-l border-gray-200 flex flex-col flex-shrink-0",children:[e.jsxs("div",{className:"p-4 border-b border-gray-200",children:[e.jsxs("div",{className:"flex items-center justify-between mb-2",children:[e.jsxs("h3",{className:"font-bold text-gray-700 flex items-center space-x-2",children:[e.jsx(pe,{className:"w-4 h-4"}),e.jsx("span",{children:n("proctoring.camera")})]}),e.jsxs("div",{className:"flex items-center space-x-1",children:[e.jsx("div",{className:"w-2 h-2 bg-danger rounded-full animate-pulse"}),e.jsx("span",{className:"text-xs text-danger font-bold",children:n("proctoring.recording")})]})]}),e.jsx("div",{className:"relative bg-gray-900 rounded-lg overflow-hidden aspect-video",children:e.jsx("video",{ref:g,autoPlay:!0,playsInline:!0,muted:!0,className:"w-full h-full object-cover"})}),e.jsx("p",{className:"text-xs mt-2 text-gray-500 text-center",children:it||n("common.loading")})]}),e.jsxs("div",{className:"p-4 border-b border-gray-200 space-y-2",children:[e.jsxs("div",{className:"flex items-center justify-between p-2 bg-danger-50 rounded-lg",children:[e.jsx("span",{className:"text-xs text-gray-600",children:n("proctoring.aiDetection")}),e.jsx("span",{className:"font-bold text-danger",children:Se})]}),e.jsxs("div",{className:"flex items-center justify-between p-2 bg-warning-50 rounded-lg",children:[e.jsx("span",{className:"text-xs text-gray-600",children:n("proctoring.tabViolations")}),e.jsx("span",{className:"font-bold text-warning",children:Me})]}),e.jsxs("div",{className:"flex items-center justify-between p-2 bg-warning-50 rounded-lg",children:[e.jsx("span",{className:"text-xs text-gray-600",children:n("proctoring.fullscreenViolations")}),e.jsx("span",{className:"font-bold text-warning",children:Ae})]}),e.jsxs("div",{className:"flex items-center justify-between p-2 bg-gray-50 rounded-lg",children:[e.jsx("span",{className:"text-xs text-gray-600",children:n("proctoring.gazeAway")}),e.jsx("span",{className:"font-bold text-gray-600",children:Te})]})]}),e.jsxs("div",{className:"flex-1 overflow-y-auto p-4",children:[e.jsxs("div",{className:"flex items-center justify-between mb-3",children:[e.jsx("h3",{className:"font-bold text-gray-700",children:n("proctoring.questionList")}),e.jsx("button",{onClick:()=>ht(!le),className:"text-gray-400 hover:text-gray-600",children:le?e.jsx(Rt,{className:"w-4 h-4"}):e.jsx(Lt,{className:"w-4 h-4"})})]}),le&&e.jsx("div",{className:"grid grid-cols-5 gap-2",children:k.map((t,r)=>{const s=!!_[t.id],o=C.has(t.id),a=r===D;return e.jsxs("button",{onClick:()=>me(r),className:`relative w-10 h-10 rounded-lg font-medium text-sm transition-all ${a?"bg-primary text-white ring-2 ring-primary ring-offset-2":s?"bg-success-100 text-success-700 hover:bg-success-200":"bg-gray-100 text-gray-600 hover:bg-gray-200"}`,children:[r+1,o&&e.jsx(we,{className:"absolute -top-1 -right-1 w-3 h-3 text-warning fill-warning"})]},t.id)})}),e.jsxs("div",{className:"mt-4 space-y-1 text-xs text-gray-500",children:[e.jsxs("div",{className:"flex items-center space-x-2",children:[e.jsx("div",{className:"w-4 h-4 bg-success-100 rounded"}),e.jsx("span",{children:n("proctoring.answered")})]}),e.jsxs("div",{className:"flex items-center space-x-2",children:[e.jsx("div",{className:"w-4 h-4 bg-gray-100 rounded"}),e.jsx("span",{children:n("proctoring.unanswered")})]}),e.jsxs("div",{className:"flex items-center space-x-2",children:[e.jsx(we,{className:"w-4 h-4 text-warning fill-warning"}),e.jsx("span",{children:n("proctoring.flagged")})]})]})]}),e.jsx("div",{className:"p-4 border-t border-gray-200",children:e.jsxs("button",{onClick:()=>ue(!1),disabled:F,className:"btn-success w-full py-3",children:[F?e.jsx(ye,{className:"w-5 h-5 mr-2 animate-spin"}):e.jsx(Xe,{className:"w-5 h-5 mr-2"}),n("common.submit")," (",Object.keys(_).length,"/",k.length,")"]})})]})]}):e.jsxs("div",{className:"flex flex-col items-center justify-center min-h-screen bg-gradient-to-br from-primary-50 to-background p-4",children:[e.jsxs(U.div,{initial:{opacity:0,y:20},animate:{opacity:1,y:0},className:"bg-paper p-8 rounded-2xl shadow-soft max-w-lg w-full",children:[e.jsxs("div",{className:"text-center mb-6",children:[e.jsx("div",{className:"inline-flex items-center justify-center w-16 h-16 bg-primary-100 rounded-full mb-4",children:e.jsx(Qe,{className:"w-8 h-8 text-primary"})}),e.jsx("h2",{className:"text-2xl font-bold text-text-main",children:n("exam.rules.title")}),e.jsx("p",{className:"text-gray-500 mt-1",children:(E==null?void 0:E.title)||n("common.loading")})]}),e.jsxs("div",{className:"space-y-3 mb-6",children:[e.jsxs("div",{className:"flex items-start space-x-3 p-3 bg-success-50 rounded-lg",children:[e.jsx(Ye,{className:"w-5 h-5 text-success mt-0.5 flex-shrink-0"}),e.jsx("span",{className:"text-sm text-gray-700",children:n("exam.rules.camera")})]}),e.jsxs("div",{className:"flex items-start space-x-3 p-3 bg-success-50 rounded-lg",children:[e.jsx(Ye,{className:"w-5 h-5 text-success mt-0.5 flex-shrink-0"}),e.jsx("span",{className:"text-sm text-gray-700",children:n("exam.rules.fullscreen")})]}),e.jsxs("div",{className:"flex items-start space-x-3 p-3 bg-danger-50 rounded-lg",children:[e.jsx(ge,{className:"w-5 h-5 text-danger mt-0.5 flex-shrink-0"}),e.jsx("span",{className:"text-sm text-gray-700",children:n("exam.rules.noMultiScreen")})]}),e.jsxs("div",{className:"flex items-start space-x-3 p-3 bg-danger-50 rounded-lg",children:[e.jsx(ge,{className:"w-5 h-5 text-danger mt-0.5 flex-shrink-0"}),e.jsx("span",{className:"text-sm text-gray-700",children:n("exam.rules.noTabSwitch")})]}),e.jsxs("div",{className:"flex items-start space-x-3 p-3 bg-danger-50 rounded-lg",children:[e.jsx(ge,{className:"w-5 h-5 text-danger mt-0.5 flex-shrink-0"}),e.jsx("span",{className:"text-sm text-gray-700",children:n("exam.rules.noRemoteDesktop")})]})]}),Fe&&e.jsxs("div",{className:"p-4 bg-danger-100 border border-danger-200 rounded-lg mb-4 flex items-center space-x-3",children:[e.jsx(Vt,{className:"w-6 h-6 text-danger"}),e.jsx("span",{className:"text-sm font-bold text-danger",children:n("anticheat.multiScreen")})]}),Re&&e.jsxs("div",{className:"p-4 bg-danger-100 border border-danger-200 rounded-lg mb-4 flex items-center space-x-3",children:[e.jsx(xe,{className:"w-6 h-6 text-danger"}),e.jsx("span",{className:"text-sm font-bold text-danger",children:n("anticheat.remoteDesktop")})]}),e.jsxs("div",{className:"mb-6",children:[e.jsx("p",{className:"text-sm font-medium text-gray-700 mb-2",children:n("exam.rules.cameraCheck")}),e.jsxs("div",{className:"relative bg-gray-900 rounded-lg overflow-hidden aspect-video",children:[M==="loading"&&e.jsxs("div",{className:"absolute inset-0 flex items-center justify-center flex-col",children:[e.jsx(ye,{className:"w-8 h-8 text-white animate-spin mb-2"}),e.jsx("p",{className:"text-white text-sm",children:n("common.loading")})]}),M==="error"&&e.jsxs("div",{className:"absolute inset-0 flex items-center justify-center flex-col p-4",children:[e.jsx(xe,{className:"w-12 h-12 text-danger mb-2"}),e.jsx("p",{className:"text-white text-sm text-center mb-3",children:n("anticheat.cameraAccess")}),e.jsxs("button",{onClick:Pe,className:"flex items-center space-x-2 bg-primary hover:bg-primary-700 text-white px-4 py-2 rounded-lg text-sm font-medium transition-colors",children:[e.jsx(pe,{className:"w-4 h-4"}),e.jsx("span",{children:n("face.retake")})]})]}),e.jsx("video",{ref:g,autoPlay:!0,playsInline:!0,muted:!0,className:"w-full h-full object-cover"}),e.jsxs("div",{className:"absolute bottom-2 left-2 flex items-center space-x-1 bg-black/50 text-white text-xs px-2 py-1 rounded",children:[e.jsx(pe,{className:"w-3 h-3"}),e.jsx("span",{children:n("proctoring.camera")}),M==="ready"&&e.jsx("span",{className:"w-2 h-2 rounded-full bg-green-500 ml-1 animate-pulse"}),M==="error"&&e.jsx("span",{className:"w-2 h-2 rounded-full bg-red-500 ml-1"})]})]}),M==="error"&&e.jsxs("p",{className:"text-xs text-danger mt-2 text-center",children:[n("anticheat.cameraAccess")," - ",n("exam.rules.camera")]})]}),e.jsxs("button",{onClick:St,disabled:Fe||Re||M!=="ready",className:"btn-primary w-full py-3 text-lg disabled:opacity-50 disabled:cursor-not-allowed",children:[e.jsx(Qe,{className:"w-5 h-5 mr-2"}),n("exam.rules.agree")]}),M!=="ready"&&e.jsxs("p",{className:"text-xs text-center text-gray-500 mt-2",children:[n("exam.rules.cameraCheck")," ",M==="loading"?"...":""]})]}),e.jsx(se,{children:Y&&e.jsx(U.div,{initial:{opacity:0},animate:{opacity:1},exit:{opacity:0},className:"fixed inset-0 bg-black/70 z-50 flex items-center justify-center p-4",children:e.jsx(Ze,{mode:z,storedEmbedding:ie,onSuccess:He,onFailure:Ue,onEnrollComplete:$e})})})]})}export{Zt as default};
