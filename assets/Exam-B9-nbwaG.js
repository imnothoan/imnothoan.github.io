import{c as L,d as St,u as Ct,a as Mt,r as a,b as Dt,B as c,t as d,s as w,j as e,T as fe}from"./index-CKhVfOUJ.js";import{S as Be,b as Qe,c as xe,C as he,F as Ye,a as Ft}from"./FaceVerification-9Ql1pZTM.js";import{m as P,L as ge,A as te}from"./proxy-dxJY_AFk.js";import{C as At}from"./chevron-right-BsIftr2B.js";import{E as Rt,a as Tt}from"./eye-DHMALM6Y.js";/**
 * @license lucide-react v0.468.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const It=L("ChevronLeft",[["path",{d:"m15 18-6-6 6-6",key:"1wnfg3"}]]);/**
 * @license lucide-react v0.468.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const Lt=L("FlagOff",[["path",{d:"M8 2c3 0 5 2 8 2s4-1 4-1v11",key:"9rwyz9"}],["path",{d:"M4 22V4",key:"1plyxx"}],["path",{d:"M4 15s1-1 4-1 5 2 8 2",key:"1myooe"}],["line",{x1:"2",x2:"22",y1:"2",y2:"22",key:"a6p6uj"}]]);/**
 * @license lucide-react v0.468.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const pe=L("Flag",[["path",{d:"M4 15s1-1 4-1 5 2 8 2 4-1 4-1V3s-1 1-4 1-5-2-8-2-4 1-4 1z",key:"i9b6wo"}],["line",{x1:"4",x2:"4",y1:"22",y2:"15",key:"1cm3nv"}]]);/**
 * @license lucide-react v0.468.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const Ot=L("Monitor",[["rect",{width:"20",height:"14",x:"2",y:"3",rx:"2",key:"48i651"}],["line",{x1:"8",x2:"16",y1:"21",y2:"21",key:"1svkeh"}],["line",{x1:"12",x2:"12",y1:"17",y2:"21",key:"vw1qmm"}]]);/**
 * @license lucide-react v0.468.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const Ze=L("Send",[["path",{d:"M14.536 21.686a.5.5 0 0 0 .937-.024l6.5-19a.496.496 0 0 0-.635-.635l-19 6.5a.5.5 0 0 0-.024.937l7.93 3.18a2 2 0 0 1 1.112 1.11z",key:"1ffxy3"}],["path",{d:"m21.854 2.147-10.94 10.939",key:"12cjpa"}]]);/**
 * @license lucide-react v0.468.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const qt=L("StickyNote",[["path",{d:"M16 3H5a2 2 0 0 0-2 2v14a2 2 0 0 0 2 2h14a2 2 0 0 0 2-2V8Z",key:"qazsjp"}],["path",{d:"M15 3v4a2 2 0 0 0 2 2h4",key:"40519r"}]]);/**
 * @license lucide-react v0.468.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const Xe=L("WifiOff",[["path",{d:"M12 20h.01",key:"zekei9"}],["path",{d:"M8.5 16.429a5 5 0 0 1 7 0",key:"1bycff"}],["path",{d:"M5 12.859a10 10 0 0 1 5.17-2.69",key:"1dl1wf"}],["path",{d:"M19 12.859a10 10 0 0 0-2.007-1.523",key:"4k23kn"}],["path",{d:"M2 8.82a15 15 0 0 1 4.177-2.643",key:"1grhjp"}],["path",{d:"M22 8.82a15 15 0 0 0-11.288-3.764",key:"z3jwby"}],["path",{d:"m2 2 20 20",key:"1ooewy"}]]);/**
 * @license lucide-react v0.468.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const Vt=L("Wifi",[["path",{d:"M12 20h.01",key:"zekei9"}],["path",{d:"M2 8.82a15 15 0 0 1 20 0",key:"dnpr2z"}],["path",{d:"M5 12.859a10 10 0 0 1 14 0",key:"1x1e6c"}],["path",{d:"M8.5 16.429a5 5 0 0 1 7 0",key:"1bycff"}]]),Pt=["teamviewer","anydesk","ultraviewer","parsec","vnc","remotedesktop","citrix","logmein","splashtop","chrome remote","microsoft remote","rdp","ammyy","supremo"],ye=typeof navigator<"u"&&/^((?!chrome|android).)*safari/i.test(navigator.userAgent),Je=["demo","1"],et=["demo-session","demo-session-id"],$t=3e4,tt="SUBMIT_TIMEOUT";function Qt(){const{id:g}=St(),{user:b,profile:zt}=Ct(),{t:r}=Mt(),v=a.useRef(null),M=a.useRef(null),se=a.useRef(null);a.useRef(null);const W=a.useRef(!1),D=Dt(),[_,we]=a.useState(null),[E,be]=a.useState([]),[F,st]=a.useState(0),[j,ve]=a.useState({}),[S,je]=a.useState(new Set),[A,Ne]=a.useState({}),[h,K]=a.useState(null),[ne,B]=a.useState(null),[nt,rt]=a.useState(!1),[at,_e]=a.useState(null),[ke,Ee]=a.useState(0),[Se,it]=a.useState(0),[Ce,ct]=a.useState(0),[Me,ot]=a.useState(0),[Q,$]=a.useState(!1),[z,re]=a.useState("verify"),[ae,De]=a.useState(null),[Ut,lt]=a.useState(0),[Y,Z]=a.useState(null),[X,Fe]=a.useState(!navigator.onLine),[dt,ie]=a.useState(!1),[Ae,ce]=a.useState(!1),[Re,mt]=a.useState(!1),[p,Te]=a.useState(!1),[R,Ie]=a.useState(!1),[C,O]=a.useState("loading"),[Le,ut]=a.useState(!1),[oe,ft]=a.useState(!0),y=E[F],xt=a.useCallback(()=>{const t=navigator.userAgent.toLowerCase();for(const o of Pt)if(t.includes(o))return!0;const s=window.screen.width/window.screen.height,n=window.innerWidth/window.innerHeight;Math.abs(s-n)>.2&&console.warn("Suspicious screen ratio detected");try{const o=document.createElement("canvas"),i=o.getContext("webgl")||o.getContext("experimental-webgl");if(i){const m=i.getExtension("WEBGL_debug_renderer_info");if(m){const l=i.getParameter(m.UNMASKED_RENDERER_WEBGL).toLowerCase(),f=["vmware","virtualbox","parallels","hyper-v","swiftshader","llvmpipe"];for(const x of f)if(l.includes(x))return console.warn("Virtual machine renderer detected:",l),!0}}}catch(o){console.warn("WebGL check failed:",o)}return!1},[]),ht=a.useCallback(async()=>{try{if("isExtended"in window.screen&&window.screen.isExtended)return ce(!0),c.error("PH√ÅT HI·ªÜN 2 M√ÄN H√åNH! Vui l√≤ng ng·∫Øt k·∫øt n·ªëi m√†n h√¨nh ph·ª• ƒë·ªÉ thi.",{autoClose:!1}),!1;if("getScreenDetails"in window)try{const t=await window.getScreenDetails();if(t&&t.screens.length>1)return ce(!0),c.error(`PH√ÅT HI·ªÜN ${t.screens.length} M√ÄN H√åNH! Nghi v·∫•n gian l·∫≠n.`,{autoClose:!1}),!1}catch{console.warn("Screen details permission denied")}}catch(t){console.warn("Screen API not supported",t)}return ce(!1),!0},[]),Oe=async()=>{try{const t=document.documentElement;t.requestFullscreen?await t.requestFullscreen():t.webkitRequestFullscreen?await t.webkitRequestFullscreen():t.mozRequestFullScreen?await t.mozRequestFullScreen():t.msRequestFullscreen&&await t.msRequestFullscreen(),ie(!0)}catch{ye?(console.warn("Safari fullscreen not fully supported, continuing without fullscreen requirement"),ie(!0)):c.error(r("anticheat.fullscreenRequired"))}};a.useEffect(()=>{const t=()=>{const s=!!(document.fullscreenElement||document.webkitFullscreenElement||document.mozFullScreenElement||document.msFullscreenElement);if(ie(s),ye){console.log("Safari fullscreen state change - skipping violation check");return}!s&&p&&!W.current&&ct(n=>{const o=n+1;return c.error(d("anticheat.fullscreenExit",{count:o})),q("fullscreen_exit",{count:o}),o})};return document.addEventListener("fullscreenchange",t),document.addEventListener("webkitfullscreenchange",t),document.addEventListener("mozfullscreenchange",t),document.addEventListener("MSFullscreenChange",t),()=>{document.removeEventListener("fullscreenchange",t),document.removeEventListener("webkitfullscreenchange",t),document.removeEventListener("mozfullscreenchange",t),document.removeEventListener("MSFullscreenChange",t)}},[p]),a.useEffect(()=>{const t=()=>{document.hidden&&p&&!W.current&&it(s=>{const n=s+1;return c.warning(d("anticheat.tabSwitch",{count:n})),q("tab_switch",{count:n}),n})};return document.addEventListener("visibilitychange",t),()=>document.removeEventListener("visibilitychange",t)},[p]),a.useEffect(()=>{if(!p)return;const t=n=>{var i;const o=[{ctrl:!0,key:"c"},{ctrl:!0,key:"v"},{ctrl:!0,key:"p"},{ctrl:!0,key:"s"},{ctrl:!0,key:"f"},{ctrl:!0,shift:!0,key:"i"},{key:"F12"},{alt:!0,key:"Tab"},{key:"PrintScreen"}];for(const m of o)if((!m.ctrl||n.ctrlKey)&&(!m.shift||n.shiftKey)&&(!m.alt||n.altKey)&&(n.key.toLowerCase()===((i=m.key)==null?void 0:i.toLowerCase())||n.key===m.key)&&m.key){n.preventDefault(),c.warning("Ph√≠m t·∫Øt b·ªã v√¥ hi·ªáu h√≥a trong ph√≤ng thi!"),q("keyboard_shortcut",{key:n.key,ctrl:n.ctrlKey,alt:n.altKey,shift:n.shiftKey});return}},s=n=>{n.preventDefault(),c.warning("Click chu·ªôt ph·∫£i b·ªã v√¥ hi·ªáu h√≥a!"),q("right_click",{})};return document.addEventListener("keydown",t),document.addEventListener("contextmenu",s),()=>{document.removeEventListener("keydown",t),document.removeEventListener("contextmenu",s)}},[p]);const T=a.useRef(null),H=a.useRef(null),G=a.useRef(null),U=a.useRef(null),le=t=>{T.current=t,v.current&&(v.current.srcObject=t),G.current||(G.current=document.createElement("canvas"),G.current.width=640,G.current.height=480,U.current=G.current.getContext("2d",{willReadFrequently:!0}))},gt=async()=>{O("loading");try{T.current&&T.current.getTracks().forEach(n=>n.stop());const t={video:{width:{ideal:640,min:320},height:{ideal:480,min:240},facingMode:"user"},audio:!1},s=await navigator.mediaDevices.getUserMedia(t);le(s),O("ready"),c.success(r("proctoring.camera")+" OK")}catch(t){console.error("Camera retry error:",t),O("error"),c.error(r("anticheat.cameraAccess"))}};a.useEffect(()=>((async()=>{O("loading");try{const s={video:{width:{ideal:640,min:320},height:{ideal:480,min:240},facingMode:"user"},audio:!1},n=await navigator.mediaDevices.getUserMedia(s);le(n),O("ready")}catch(s){if(console.error("Camera access error:",s),O("error"),s.name==="NotAllowedError"||s.name==="PermissionDeniedError")c.error(r("anticheat.cameraAccess")+" (Permission denied)");else if(s.name==="NotFoundError"||s.name==="DevicesNotFoundError")c.error(r("anticheat.cameraAccess")+" (No camera found)");else if(s.name==="NotReadableError"||s.name==="TrackStartError")c.error(r("anticheat.cameraAccess")+" (Camera in use by another app)");else if(s.name==="OverconstrainedError")try{const n=await navigator.mediaDevices.getUserMedia({video:!0});le(n),O("ready")}catch(n){console.error("Camera fallback failed:",n),c.error(r("anticheat.cameraAccess"))}else c.error(r("anticheat.cameraAccess"))}})(),()=>{T.current&&T.current.getTracks().forEach(s=>s.stop())}),[]);const pt=100,yt=500;a.useEffect(()=>{const t=()=>{T.current&&v.current&&v.current.srcObject!==T.current&&(console.log("[Exam] Re-attaching camera stream to video element"),v.current.srcObject=T.current,v.current.play().catch(o=>{console.warn("Video play failed:",o)}))};t();const s=setTimeout(t,pt),n=setTimeout(t,yt);return()=>{clearTimeout(s),clearTimeout(n)}},[p]),a.useEffect(()=>{const t=()=>{Fe(!1),c.success(d("anticheat.networkOnline"))},s=()=>{Fe(!0),c.error(d("anticheat.networkOffline"))};window.addEventListener("online",t),window.addEventListener("offline",s);const n=f=>{const{code:x,payload:u,detectedClass:N,confidence:I,count:k}=f,J={phone:d("anticheat.phoneDetected"),material:d("anticheat.materialDetected"),headphones:d("anticheat.headphonesDetected"),person:d("anticheat.noFace")},ee={lookAtScreen:d("anticheat.lookAtScreen"),NO_FACE:d("anticheat.noFace"),LOOK_RIGHT:d("anticheat.lookRight"),LOOK_LEFT:d("anticheat.lookLeft"),LOOK_DOWN:d("anticheat.lookDown"),LOOK_UP:d("anticheat.lookUp"),GAZE_LEFT:d("anticheat.gazeLeft"),GAZE_RIGHT:d("anticheat.gazeRight"),speakingDetected:d("anticheat.speakingDetected"),multiPerson:d("anticheat.multiPerson",{count:k||2}),phoneDetected:d("anticheat.phoneDetected"),materialDetected:d("anticheat.materialDetected"),headphonesDetected:d("anticheat.headphonesDetected"),monitoring:d("anticheat.monitoring"),aiLoading:d("anticheat.aiLoading"),yoloLoading:d("anticheat.yoloLoading"),basicMode:d("anticheat.basicMode"),faceOnly:d("anticheat.faceOnly"),yoloOnly:d("anticheat.yoloOnly")};return x==="detection"&&N&&J[N]?`${J[N]} (${((I||0)*100).toFixed(0)}%)`:ee[x]||ee[u]||u};M.current=new Worker(new URL("/assets/ai.worker-VDgijyw7.js",import.meta.url),{type:"module"}),M.current.onmessage=f=>{const{type:x,payload:u,code:N}=f.data,I=n(f.data);x==="STATUS"?_e(I):x==="ALERT"?(Ee(k=>k+1),c.warning(`${d("anticheat.aiWarning")}: ${I}`),q("ai_alert",{message:u,code:N})):x==="GAZE_AWAY"&&ot(k=>k+1)},M.current.onerror=f=>{console.error("AI Worker error:",f),_e("AI Worker error - basic mode")};const o=600,i=200,m=()=>{H.current||(console.log("üé¨ Starting AI frame processing..."),console.log("   Video ready:",!!v.current),console.log("   Canvas context ready:",!!U.current),console.log("   Worker ready:",!!M.current),H.current=setInterval(()=>{if(v.current&&M.current&&U.current&&!W.current)try{if(v.current.readyState>=HTMLMediaElement.HAVE_CURRENT_DATA&&v.current.videoWidth>0){U.current.drawImage(v.current,0,0,640,480);const f=U.current.getImageData(0,0,640,480);f.data&&f.data.length>0&&M.current.postMessage({type:"PROCESS_FRAME",payload:f},[f.data.buffer])}}catch(f){console.warn("Error sending frame to worker:",f)}},i))};let l=null;return p&&C==="ready"&&(l=setTimeout(()=>{v.current&&U.current?m():(console.warn("Video or canvas not ready after delay, retrying..."),setTimeout(m,500))},o)),()=>{window.removeEventListener("online",t),window.removeEventListener("offline",s),l&&clearTimeout(l),H.current&&(clearInterval(H.current),H.current=null),M.current&&M.current.terminate()}},[p,C]),a.useEffect(()=>{if(!(!p||ne===null))return se.current=setInterval(()=>{B(t=>t<=1?(clearInterval(se.current),$e(),0):(t===300&&(rt(!0),c.warning("‚ö†Ô∏è C√≤n 5 ph√∫t! H√£y ki·ªÉm tra l·∫°i b√†i l√†m.")),t===60&&c.error("‚ö†Ô∏è C√≤n 1 ph√∫t!"),t-1))},1e3),()=>clearInterval(se.current)},[p,ne]),a.useEffect(()=>{const t=async()=>{var o;if(g==="demo"||g==="1"){we({id:g,title:"Tr√≠ tu·ªá nh√¢n t·∫°o (AI) - B√ÄI THI M·∫™U",code:"INT3401",duration_minutes:45,require_camera:!0,require_fullscreen:!0}),be([{id:"1",question_text:"Deep Learning l√† g√¨?",question_type:"multiple_choice",options:[{id:"A",text:"M·ªôt lo·∫°i m√°y h·ªçc d·ª±a tr√™n m·∫°ng n∆°-ron nh√¢n t·∫°o"},{id:"B",text:"M·ªôt ph·∫ßn m·ªÅm ch·ªânh s·ª≠a ·∫£nh"},{id:"C",text:"M·ªôt thu·∫≠t to√°n s·∫Øp x·∫øp"},{id:"D",text:"M·ªôt ng√¥n ng·ªØ l·∫≠p tr√¨nh"}],points:2},{id:"2",question_text:"M·∫°ng n∆°-ron t√≠ch ch·∫≠p (CNN) th∆∞·ªùng ƒë∆∞·ª£c s·ª≠ d·ª•ng cho lo·∫°i d·ªØ li·ªáu n√†o?",question_type:"multiple_choice",options:[{id:"A",text:"D·ªØ li·ªáu vƒÉn b·∫£n"},{id:"B",text:"D·ªØ li·ªáu √¢m thanh"},{id:"C",text:"D·ªØ li·ªáu h√¨nh ·∫£nh"},{id:"D",text:"D·ªØ li·ªáu b·∫£ng"}],points:2},{id:"3",question_text:"H√†m k√≠ch ho·∫°t ReLU c√≥ c√¥ng th·ª©c l√† g√¨?",question_type:"multiple_choice",options:[{id:"A",text:"f(x) = max(0, x)"},{id:"B",text:"f(x) = 1/(1+e^(-x))"},{id:"C",text:"f(x) = tanh(x)"},{id:"D",text:"f(x) = x^2"}],points:2},{id:"4",question_text:"Overfitting x·∫£y ra khi:",question_type:"multiple_choice",options:[{id:"A",text:"Model h·ªçc qu√° t·ªët tr√™n t·∫≠p train nh∆∞ng k√©m tr√™n t·∫≠p test"},{id:"B",text:"Model kh√¥ng h·ªçc ƒë∆∞·ª£c g√¨ t·ª´ d·ªØ li·ªáu"},{id:"C",text:"Model c√≥ qu√° √≠t tham s·ªë"},{id:"D",text:"D·ªØ li·ªáu train qu√° √≠t"}],points:2},{id:"5",question_text:"Transformer ƒë∆∞·ª£c gi·ªõi thi·ªáu trong b√†i b√°o n√†o?",question_type:"multiple_choice",options:[{id:"A",text:"Attention Is All You Need"},{id:"B",text:"ImageNet Classification with Deep CNNs"},{id:"C",text:"Playing Atari with Deep RL"},{id:"D",text:"Generative Adversarial Networks"}],points:2}]),B(2700),K("demo-session");return}try{const{data:i,error:m}=await w.from("exams").select(`
            *,
            class:classes(name, code)
          `).eq("id",g).single();if(m){console.error("Failed to load exam:",m),c.error(r("error.loadExam")),D("/");return}const l=new Date,f=new Date(i.start_time),x=new Date(i.end_time);if(i.status!=="published"){c.error(r("exam.notPublished")),D("/");return}if(l<f){c.error(r("exam.notStarted")),D("/");return}if(l>x){c.error(r("exam.ended")),D("/");return}we({id:i.id,title:i.title,code:((o=i.class)==null?void 0:o.code)||"N/A",duration_minutes:i.duration_minutes,require_camera:i.require_camera,require_fullscreen:i.require_fullscreen,max_tab_violations:i.max_tab_violations,max_fullscreen_violations:i.max_fullscreen_violations});const{data:u,error:N}=await w.from("questions").select("id, question_text, question_type, options, points, order_index").eq("exam_id",g).order("order_index");if(N){console.error("Failed to load questions:",N),c.error(r("error.loadQuestions")),D("/");return}const I=i.is_shuffled?s(u):u;be(I),B(i.duration_minutes*60);const{data:k}=await w.from("exam_sessions").select("id, status, started_at").eq("exam_id",g).eq("student_id",b==null?void 0:b.id).eq("status","in_progress").single();if(k){K(k.id);const J=new Date(k.started_at).getTime(),ee=Date.now(),ze=Math.floor((ee-J)/1e3),Ue=Math.max(0,i.duration_minutes*60-ze);if(B(Ue),Ue===0){c.warning(r("exam.timeExpired")),Te(!0),$e();return}const{data:We}=await w.from("answers").select("question_id, student_answer, is_flagged, student_notes").eq("session_id",k.id);if(We){const He={},Ge=new Set,Ke={};We.forEach(V=>{He[V.question_id]=V.student_answer,V.is_flagged&&Ge.add(V.question_id),V.student_notes&&(Ke[V.question_id]=V.student_notes)}),ve(He),je(Ge),Ne(Ke)}c.info(r("exam.sessionRestored"))}}catch(i){console.error("Error loading exam:",i),c.error(r("exam.loadError")),D("/")}},s=n=>{const o=[...n];for(let i=o.length-1;i>0;i--){const m=Math.floor(Math.random()*(i+1));[o[i],o[m]]=[o[m],o[i]]}return o};t()},[g,b,D]);const q=async(t,s)=>{if(h&&!(et.includes(h)||Je.includes(g)))try{await w.from("proctoring_logs").insert({session_id:h,event_type:t,details:s,severity:t.includes("detected")?"critical":"warning"})}catch(n){console.warn("Failed to log proctoring event:",(n==null?void 0:n.message)||n)}};a.useEffect(()=>{(async()=>{if(b!=null&&b.id)try{const{data:s}=await w.from("profiles").select("face_embedding").eq("id",b.id).single();s!=null&&s.face_embedding&&De(s.face_embedding)}catch(s){console.warn("Could not load face embedding:",s)}})()},[b==null?void 0:b.id]),a.useEffect(()=>{if(!p||!h||g==="demo"||g==="1")return;const s=180*1e3;console.log("[Face Verification] Setting up 3-minute interval checks");const n=setInterval(()=>{p&&!R&&!Q&&(console.log("[Face Verification] Triggering random check (3-min interval)"),wt())},s);return()=>{clearInterval(n)}},[p,h,g,R,Q]);const wt=()=>{re("random"),$(!0),q("face_verification_triggered",{type:"random"})},qe=async t=>{if($(!1),lt(s=>s+1),h&&h!=="demo-session-id")try{await w.rpc("log_face_verification",{p_session_id:h,p_verification_type:z,p_similarity_score:t||1,p_is_match:!0})}catch(s){console.warn("Could not log face verification:",s)}c.success(r("face.success")),Y&&(Y(),Z(null))},Ve=async(t,s)=>{if(h&&h!=="demo-session-id")try{await w.rpc("log_face_verification",{p_session_id:h,p_verification_type:z,p_similarity_score:s||0,p_is_match:!1,p_error_reason:t})}catch(n){console.warn("Could not log face verification:",n)}q("face_verification_failed",{reason:t,similarity:s,type:z}),z==="random"&&(c.warning(r("face.mismatch")),Ee(n=>n+1),$(!1))},Pe=async(t,s)=>{if(De(t),$(!1),b!=null&&b.id)try{await w.rpc("update_face_embedding",{p_embedding:t,p_image_url:s})}catch(n){console.warn("Could not save face embedding:",n)}c.success(r("face.enrollSuccess")),Y&&(Y(),Z(null))},bt=(t,s)=>{ve(n=>({...n,[t]:s}))},vt=t=>{je(s=>{const n=new Set(s);return n.has(t)?n.delete(t):n.add(t),n})},jt=(t,s)=>{Ne(n=>({...n,[t]:s}))},de=t=>{t>=0&&t<E.length&&st(t)},Nt=()=>de(F+1),_t=()=>de(F-1);a.useEffect(()=>{if(!p||!h||g==="demo"||g==="1")return;let s={...j},n=new Set(S),o={...A};const m=setInterval(async()=>{try{const l=E.filter(u=>{const N=j[u.id]!==s[u.id],I=S.has(u.id)!==n.has(u.id),k=A[u.id]!==o[u.id];return N||I||k});if(l.length===0)return;const f=l.map(u=>({session_id:h,question_id:u.id,student_answer:j[u.id]||null,is_flagged:S.has(u.id),student_notes:A[u.id]||null})),{error:x}=await w.from("answers").upsert(f,{onConflict:"session_id,question_id"});if(x)throw x;s={...j},n=new Set(S),o={...A}}catch(l){console.error("Auto-save error:",l)}},3e4);return()=>clearInterval(m)},[p,h,g,E,j,S,A]);const $e=async()=>{c.warning(r("exam.timeUp")),await me(!0)},me=async(t=!1)=>{if(!R){if(!t){const s=E.filter(i=>!j[i.id]).length,n=S.size;let o=r("exam.submitConfirm");if(s>0&&(o+=`

‚ö†Ô∏è ${s} ${r("exam.unansweredWarning")}`),n>0&&(o+=`
‚ö†Ô∏è ${n} ${r("exam.flaggedWarning")}`),!window.confirm(o))return}Ie(!0),W.current=!0;try{if(Je.includes(g)||et.includes(h)){const n={1:"A",2:"C",3:"A",4:"A",5:"A"};let o=0,i=0;E.forEach(l=>{i+=l.points,j[l.id]===n[l.id]&&(o+=l.points)}),await new Promise(l=>setTimeout(l,500));const m=i>0?(o/i*100).toFixed(1):0;c.success(`${r("exam.submitSuccess")} ${r("exam.score")}: ${o}/${i} (${m}%)`)}else{const n=async()=>{const m=E.map(x=>({session_id:h,question_id:x.id,student_answer:j[x.id]||null,is_flagged:S.has(x.id),student_notes:A[x.id]||null})),{error:l}=await w.from("answers").upsert(m,{onConflict:"session_id,question_id"});if(l)throw console.error("Error saving answers:",l),new Error(r("exam.submitError"));const{error:f}=await w.from("exam_sessions").update({cheat_count:ke,tab_violations:Se,fullscreen_violations:Ce,gaze_away_count:Me}).eq("id",h);f&&console.error("Error saving violations:",f);try{const{data:x,error:u}=await w.rpc("submit_exam",{p_session_id:h,p_auto_submit:t});if(u){console.warn("RPC submit_exam failed, using direct update:",u);const{error:N}=await w.from("exam_sessions").update({status:t?"auto_submitted":"submitted",submitted_at:new Date().toISOString()}).eq("id",h);if(N)throw N;return{success:!0,fallback:!0}}return x}catch(x){console.warn("RPC call failed, using fallback:",x);const{error:u}=await w.from("exam_sessions").update({status:t?"auto_submitted":"submitted",submitted_at:new Date().toISOString()}).eq("id",h);if(u)throw u;return{success:!0,fallback:!0}}},o=new Promise((m,l)=>setTimeout(()=>l(new Error(tt)),$t)),i=await Promise.race([n(),o]);if(i&&i.percentage!==void 0){const m=i.percentage||0,l=i.passed;c.success(`${r("exam.submitSuccess")} ${r("exam.score")}: ${m.toFixed(1)}% ${l?"‚úì":"‚úó"}`)}else c.success(r("exam.submitSuccess"))}try{(document.fullscreenElement||document.webkitFullscreenElement)&&(document.exitFullscreen?await document.exitFullscreen():document.webkitExitFullscreen&&await document.webkitExitFullscreen())}catch(n){console.warn("Error exiting fullscreen:",n)}D("/")}catch(s){console.error("Submit error:",s),s.message===tt?c.error(r("error.timeout")):c.error(r("exam.submitError"))}finally{Ie(!1),W.current=!1}}},kt=async()=>{if(xt()){mt(!0),c.error(r("anticheat.remoteDesktop"),{autoClose:!1});return}if(!await ht())return;if(await Oe(),!(g==="demo"||g==="1")&&(_==null?void 0:_.require_camera)!==!1)if(ae){re("verify"),Z(()=>ue),$(!0);return}else{re("enroll"),Z(()=>ue),$(!0);return}await ue()},ue=async()=>{if(g==="demo"||g==="1")K("demo-session-id");else if(!h&&b)try{const{data:s,error:n}=await w.rpc("start_exam_session",{p_exam_id:g,p_user_agent:navigator.userAgent,p_ip_address:null});if(n){console.error("Failed to create session:",n),n.message.includes("Maximum attempts")?c.error(r("error.general")):n.message.includes("not enrolled")?c.error(r("error.permission")):c.error(r("error.general"));return}K(s)}catch(s){console.error("Session creation error:",s),c.error(r("error.general"));return}Te(!0),c.info(r("common.success"))},Et=t=>{const s=Math.floor(t/60),n=t%60;return`${s.toString().padStart(2,"0")}:${n.toString().padStart(2,"0")}`};return p?e.jsxs("div",{className:"flex h-screen bg-background no-select",children:[e.jsx(te,{children:Q&&e.jsx(P.div,{initial:{opacity:0},animate:{opacity:1},exit:{opacity:0},className:"fixed inset-0 bg-black/70 z-[100] flex items-center justify-center p-4",children:e.jsx(Ye,{mode:z,storedEmbedding:ae,onSuccess:qe,onFailure:Ve,onEnrollComplete:Pe})})}),e.jsxs(te,{children:[X&&e.jsx(P.div,{initial:{height:0},animate:{height:"auto"},exit:{height:0},className:"fixed top-0 left-0 right-0 bg-danger text-white text-center font-bold z-50",children:e.jsxs("div",{className:"flex items-center justify-center space-x-2 p-2",children:[e.jsx(Xe,{className:"w-5 h-5"}),e.jsx("span",{children:r("anticheat.networkOffline")})]})}),!dt&&!R&&!ye&&e.jsxs(P.div,{initial:{opacity:0},animate:{opacity:1},className:"fixed inset-0 bg-black/95 z-40 flex items-center justify-center text-white flex-col",children:[e.jsx(fe,{className:"w-20 h-20 text-danger mb-4 animate-bounce"}),e.jsxs("h2",{className:"text-3xl font-bold mb-4",children:["‚ö†Ô∏è ",r("anticheat.violation")]}),e.jsx("p",{className:"mb-6 text-gray-300",children:r("anticheat.returnFullscreen")}),e.jsx("button",{onClick:Oe,className:"btn-danger px-8 py-3 text-lg",children:r("anticheat.fullscreenReturn")})]})]}),e.jsxs("div",{className:"flex-1 flex flex-col overflow-hidden",children:[e.jsxs("header",{className:"bg-paper border-b border-gray-200 px-6 py-3 flex items-center justify-between flex-shrink-0",children:[e.jsxs("div",{children:[e.jsx("h1",{className:"text-lg font-bold text-text-main",children:_==null?void 0:_.title}),e.jsxs("p",{className:"text-sm text-gray-500",children:[r("exam.code"),": ",_==null?void 0:_.code]})]}),e.jsxs("div",{className:"flex items-center space-x-4",children:[e.jsxs("div",{className:`flex items-center space-x-1 text-sm ${X?"text-danger":"text-success"}`,children:[X?e.jsx(Xe,{className:"w-4 h-4"}):e.jsx(Vt,{className:"w-4 h-4"}),e.jsx("span",{children:X?"Offline":"Online"})]}),e.jsxs("div",{className:`flex items-center space-x-2 px-4 py-2 rounded-lg font-mono text-lg font-bold ${nt?"bg-danger-100 text-danger animate-pulse":"bg-primary-50 text-primary"}`,children:[e.jsx(Ft,{className:"w-5 h-5"}),e.jsx("span",{children:Et(ne||0)})]})]})]}),e.jsx("div",{className:"flex-1 overflow-y-auto p-6",children:y&&e.jsxs(P.div,{initial:{opacity:0,x:20},animate:{opacity:1,x:0},className:"max-w-3xl mx-auto",children:[e.jsxs("div",{className:"flex items-center justify-between mb-4",children:[e.jsxs("div",{className:"flex items-center space-x-3",children:[e.jsx("span",{className:"inline-flex items-center justify-center w-10 h-10 bg-primary text-white font-bold rounded-full",children:F+1}),e.jsxs("div",{children:[e.jsxs("span",{className:"text-sm text-gray-500",children:["C√¢u ",F+1,"/",E.length]}),e.jsxs("span",{className:"text-sm text-gray-400 ml-2",children:["(",y.points," ƒëi·ªÉm)"]})]})]}),e.jsx("button",{onClick:()=>vt(y.id),className:`flex items-center space-x-1 px-3 py-1.5 rounded-lg transition-colors ${S.has(y.id)?"bg-warning-100 text-warning-700":"bg-gray-100 text-gray-600 hover:bg-gray-200"}`,children:S.has(y.id)?e.jsxs(e.Fragment,{children:[e.jsx(pe,{className:"w-4 h-4"}),e.jsx("span",{className:"text-sm font-medium",children:"ƒê√£ g·∫Øn c·ªù"})]}):e.jsxs(e.Fragment,{children:[e.jsx(Lt,{className:"w-4 h-4"}),e.jsx("span",{className:"text-sm font-medium",children:"G·∫Øn c·ªù"})]})})]}),e.jsxs("div",{className:"card mb-4",children:[e.jsx("h2",{className:"text-lg font-semibold text-text-main mb-6",children:y.question_text}),e.jsx("div",{className:"space-y-3",children:y.options.map(t=>e.jsxs("label",{className:`flex items-center p-4 border-2 rounded-xl cursor-pointer transition-all ${j[y.id]===t.id?"border-primary bg-primary-50":"border-gray-200 hover:border-primary-300 hover:bg-gray-50"}`,children:[e.jsx("input",{type:"radio",name:`question-${y.id}`,value:t.id,checked:j[y.id]===t.id,onChange:()=>bt(y.id,t.id),className:"sr-only"}),e.jsx("div",{className:`w-8 h-8 rounded-full border-2 flex items-center justify-center mr-4 flex-shrink-0 ${j[y.id]===t.id?"border-primary bg-primary text-white":"border-gray-300"}`,children:e.jsx("span",{className:"font-semibold",children:t.id})}),e.jsx("span",{className:"text-gray-700",children:t.text})]},t.id))})]}),e.jsxs("div",{className:"card",children:[e.jsxs("button",{onClick:()=>ut(!Le),className:"flex items-center space-x-2 text-gray-600 hover:text-primary transition-colors",children:[e.jsx(qt,{className:"w-5 h-5"}),e.jsx("span",{className:"font-medium",children:"Ghi ch√∫ nh√°p"}),A[y.id]&&e.jsx("span",{className:"w-2 h-2 bg-primary rounded-full"})]}),e.jsx(te,{children:Le&&e.jsx(P.div,{initial:{height:0,opacity:0},animate:{height:"auto",opacity:1},exit:{height:0,opacity:0},className:"overflow-hidden",children:e.jsx("textarea",{placeholder:"Ghi ch√∫ c√° nh√¢n cho c√¢u h·ªèi n√†y... (ch·ªâ b·∫°n th·∫•y)",value:A[y.id]||"",onChange:t=>jt(y.id,t.target.value),className:"w-full mt-3 p-3 border border-gray-200 rounded-lg resize-none focus:outline-none focus:ring-2 focus:ring-primary-500",rows:3})})})]}),e.jsxs("div",{className:"flex items-center justify-between mt-6",children:[e.jsxs("button",{onClick:_t,disabled:F===0,className:"btn-secondary disabled:opacity-50 disabled:cursor-not-allowed",children:[e.jsx(It,{className:"w-5 h-5 mr-1"}),r("common.previous")]}),F===E.length-1?e.jsxs("button",{onClick:()=>me(!1),disabled:R,className:"btn-success",children:[R?e.jsx(ge,{className:"w-5 h-5 mr-2 animate-spin"}):e.jsx(Ze,{className:"w-5 h-5 mr-2"}),r("common.submit")]}):e.jsxs("button",{onClick:Nt,className:"btn-primary",children:[r("common.next"),e.jsx(At,{className:"w-5 h-5 ml-1"})]})]})]},y.id)})]}),e.jsxs("div",{className:"w-80 bg-paper border-l border-gray-200 flex flex-col flex-shrink-0",children:[e.jsxs("div",{className:"p-4 border-b border-gray-200",children:[e.jsxs("div",{className:"flex items-center justify-between mb-2",children:[e.jsxs("h3",{className:"font-bold text-gray-700 flex items-center space-x-2",children:[e.jsx(he,{className:"w-4 h-4"}),e.jsx("span",{children:r("proctoring.camera")})]}),e.jsxs("div",{className:"flex items-center space-x-1",children:[e.jsx("div",{className:"w-2 h-2 bg-danger rounded-full animate-pulse"}),e.jsx("span",{className:"text-xs text-danger font-bold",children:r("proctoring.recording")})]})]}),e.jsx("div",{className:"relative bg-gray-900 rounded-lg overflow-hidden aspect-video",children:e.jsx("video",{ref:v,autoPlay:!0,playsInline:!0,muted:!0,className:"w-full h-full object-cover"})}),e.jsx("p",{className:"text-xs mt-2 text-gray-500 text-center",children:at||r("common.loading")})]}),e.jsxs("div",{className:"p-4 border-b border-gray-200 space-y-2",children:[e.jsxs("div",{className:"flex items-center justify-between p-2 bg-danger-50 rounded-lg",children:[e.jsx("span",{className:"text-xs text-gray-600",children:r("proctoring.aiDetection")}),e.jsx("span",{className:"font-bold text-danger",children:ke})]}),e.jsxs("div",{className:"flex items-center justify-between p-2 bg-warning-50 rounded-lg",children:[e.jsx("span",{className:"text-xs text-gray-600",children:r("proctoring.tabViolations")}),e.jsx("span",{className:"font-bold text-warning",children:Se})]}),e.jsxs("div",{className:"flex items-center justify-between p-2 bg-warning-50 rounded-lg",children:[e.jsx("span",{className:"text-xs text-gray-600",children:r("proctoring.fullscreenViolations")}),e.jsx("span",{className:"font-bold text-warning",children:Ce})]}),e.jsxs("div",{className:"flex items-center justify-between p-2 bg-gray-50 rounded-lg",children:[e.jsx("span",{className:"text-xs text-gray-600",children:r("proctoring.gazeAway")}),e.jsx("span",{className:"font-bold text-gray-600",children:Me})]})]}),e.jsxs("div",{className:"flex-1 overflow-y-auto p-4",children:[e.jsxs("div",{className:"flex items-center justify-between mb-3",children:[e.jsx("h3",{className:"font-bold text-gray-700",children:r("proctoring.questionList")}),e.jsx("button",{onClick:()=>ft(!oe),className:"text-gray-400 hover:text-gray-600",children:oe?e.jsx(Rt,{className:"w-4 h-4"}):e.jsx(Tt,{className:"w-4 h-4"})})]}),oe&&e.jsx("div",{className:"grid grid-cols-5 gap-2",children:E.map((t,s)=>{const n=!!j[t.id],o=S.has(t.id),i=s===F;return e.jsxs("button",{onClick:()=>de(s),className:`relative w-10 h-10 rounded-lg font-medium text-sm transition-all ${i?"bg-primary text-white ring-2 ring-primary ring-offset-2":n?"bg-success-100 text-success-700 hover:bg-success-200":"bg-gray-100 text-gray-600 hover:bg-gray-200"}`,children:[s+1,o&&e.jsx(pe,{className:"absolute -top-1 -right-1 w-3 h-3 text-warning fill-warning"})]},t.id)})}),e.jsxs("div",{className:"mt-4 space-y-1 text-xs text-gray-500",children:[e.jsxs("div",{className:"flex items-center space-x-2",children:[e.jsx("div",{className:"w-4 h-4 bg-success-100 rounded"}),e.jsx("span",{children:r("proctoring.answered")})]}),e.jsxs("div",{className:"flex items-center space-x-2",children:[e.jsx("div",{className:"w-4 h-4 bg-gray-100 rounded"}),e.jsx("span",{children:r("proctoring.unanswered")})]}),e.jsxs("div",{className:"flex items-center space-x-2",children:[e.jsx(pe,{className:"w-4 h-4 text-warning fill-warning"}),e.jsx("span",{children:r("proctoring.flagged")})]})]})]}),e.jsx("div",{className:"p-4 border-t border-gray-200",children:e.jsxs("button",{onClick:()=>me(!1),disabled:R,className:"btn-success w-full py-3",children:[R?e.jsx(ge,{className:"w-5 h-5 mr-2 animate-spin"}):e.jsx(Ze,{className:"w-5 h-5 mr-2"}),r("common.submit")," (",Object.keys(j).length,"/",E.length,")"]})})]})]}):e.jsxs("div",{className:"flex flex-col items-center justify-center min-h-screen bg-gradient-to-br from-primary-50 to-background p-4",children:[e.jsxs(P.div,{initial:{opacity:0,y:20},animate:{opacity:1,y:0},className:"bg-paper p-8 rounded-2xl shadow-soft max-w-lg w-full",children:[e.jsxs("div",{className:"text-center mb-6",children:[e.jsx("div",{className:"inline-flex items-center justify-center w-16 h-16 bg-primary-100 rounded-full mb-4",children:e.jsx(Be,{className:"w-8 h-8 text-primary"})}),e.jsx("h2",{className:"text-2xl font-bold text-text-main",children:r("exam.rules.title")}),e.jsx("p",{className:"text-gray-500 mt-1",children:(_==null?void 0:_.title)||r("common.loading")})]}),e.jsxs("div",{className:"space-y-3 mb-6",children:[e.jsxs("div",{className:"flex items-start space-x-3 p-3 bg-success-50 rounded-lg",children:[e.jsx(Qe,{className:"w-5 h-5 text-success mt-0.5 flex-shrink-0"}),e.jsx("span",{className:"text-sm text-gray-700",children:r("exam.rules.camera")})]}),e.jsxs("div",{className:"flex items-start space-x-3 p-3 bg-success-50 rounded-lg",children:[e.jsx(Qe,{className:"w-5 h-5 text-success mt-0.5 flex-shrink-0"}),e.jsx("span",{className:"text-sm text-gray-700",children:r("exam.rules.fullscreen")})]}),e.jsxs("div",{className:"flex items-start space-x-3 p-3 bg-danger-50 rounded-lg",children:[e.jsx(xe,{className:"w-5 h-5 text-danger mt-0.5 flex-shrink-0"}),e.jsx("span",{className:"text-sm text-gray-700",children:r("exam.rules.noMultiScreen")})]}),e.jsxs("div",{className:"flex items-start space-x-3 p-3 bg-danger-50 rounded-lg",children:[e.jsx(xe,{className:"w-5 h-5 text-danger mt-0.5 flex-shrink-0"}),e.jsx("span",{className:"text-sm text-gray-700",children:r("exam.rules.noTabSwitch")})]}),e.jsxs("div",{className:"flex items-start space-x-3 p-3 bg-danger-50 rounded-lg",children:[e.jsx(xe,{className:"w-5 h-5 text-danger mt-0.5 flex-shrink-0"}),e.jsx("span",{className:"text-sm text-gray-700",children:r("exam.rules.noRemoteDesktop")})]})]}),Ae&&e.jsxs("div",{className:"p-4 bg-danger-100 border border-danger-200 rounded-lg mb-4 flex items-center space-x-3",children:[e.jsx(Ot,{className:"w-6 h-6 text-danger"}),e.jsx("span",{className:"text-sm font-bold text-danger",children:r("anticheat.multiScreen")})]}),Re&&e.jsxs("div",{className:"p-4 bg-danger-100 border border-danger-200 rounded-lg mb-4 flex items-center space-x-3",children:[e.jsx(fe,{className:"w-6 h-6 text-danger"}),e.jsx("span",{className:"text-sm font-bold text-danger",children:r("anticheat.remoteDesktop")})]}),e.jsxs("div",{className:"mb-6",children:[e.jsx("p",{className:"text-sm font-medium text-gray-700 mb-2",children:r("exam.rules.cameraCheck")}),e.jsxs("div",{className:"relative bg-gray-900 rounded-lg overflow-hidden aspect-video",children:[C==="loading"&&e.jsxs("div",{className:"absolute inset-0 flex items-center justify-center flex-col",children:[e.jsx(ge,{className:"w-8 h-8 text-white animate-spin mb-2"}),e.jsx("p",{className:"text-white text-sm",children:r("common.loading")})]}),C==="error"&&e.jsxs("div",{className:"absolute inset-0 flex items-center justify-center flex-col p-4",children:[e.jsx(fe,{className:"w-12 h-12 text-danger mb-2"}),e.jsx("p",{className:"text-white text-sm text-center mb-3",children:r("anticheat.cameraAccess")}),e.jsxs("button",{onClick:gt,className:"flex items-center space-x-2 bg-primary hover:bg-primary-700 text-white px-4 py-2 rounded-lg text-sm font-medium transition-colors",children:[e.jsx(he,{className:"w-4 h-4"}),e.jsx("span",{children:r("face.retake")})]})]}),e.jsx("video",{ref:v,autoPlay:!0,playsInline:!0,muted:!0,className:"w-full h-full object-cover"}),e.jsxs("div",{className:"absolute bottom-2 left-2 flex items-center space-x-1 bg-black/50 text-white text-xs px-2 py-1 rounded",children:[e.jsx(he,{className:"w-3 h-3"}),e.jsx("span",{children:r("proctoring.camera")}),C==="ready"&&e.jsx("span",{className:"w-2 h-2 rounded-full bg-green-500 ml-1 animate-pulse"}),C==="error"&&e.jsx("span",{className:"w-2 h-2 rounded-full bg-red-500 ml-1"})]})]}),C==="error"&&e.jsxs("p",{className:"text-xs text-danger mt-2 text-center",children:[r("anticheat.cameraAccess")," - ",r("exam.rules.camera")]})]}),e.jsxs("button",{onClick:kt,disabled:Ae||Re||C!=="ready",className:"btn-primary w-full py-3 text-lg disabled:opacity-50 disabled:cursor-not-allowed",children:[e.jsx(Be,{className:"w-5 h-5 mr-2"}),r("exam.rules.agree")]}),C!=="ready"&&e.jsxs("p",{className:"text-xs text-center text-gray-500 mt-2",children:[r("exam.rules.cameraCheck")," ",C==="loading"?"...":""]})]}),e.jsx(te,{children:Q&&e.jsx(P.div,{initial:{opacity:0},animate:{opacity:1},exit:{opacity:0},className:"fixed inset-0 bg-black/70 z-50 flex items-center justify-center p-4",children:e.jsx(Ye,{mode:z,storedEmbedding:ae,onSuccess:qe,onFailure:Ve,onEnrollComplete:Pe})})})]})}export{Qt as default};
