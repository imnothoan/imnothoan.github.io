import{c as A,d as St,u as Et,a as Ct,r as c,b as Mt,B as o,t as m,s as w,j as e,T as me}from"./index-N2kES7nl.js";import{b as ue,C as he,F as He,a as Ft}from"./FaceVerification-C8sBaUoX.js";import{m as q,L as fe,A as X}from"./proxy-DHU0nURF.js";import{S as Ge,a as Ke,C as Dt}from"./shield-Cb7crUDj.js";import{E as At,a as Rt}from"./eye-BJ9akHQj.js";/**
 * @license lucide-react v0.468.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const Tt=A("ChevronLeft",[["path",{d:"m15 18-6-6 6-6",key:"1wnfg3"}]]);/**
 * @license lucide-react v0.468.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const It=A("FlagOff",[["path",{d:"M8 2c3 0 5 2 8 2s4-1 4-1v11",key:"9rwyz9"}],["path",{d:"M4 22V4",key:"1plyxx"}],["path",{d:"M4 15s1-1 4-1 5 2 8 2",key:"1myooe"}],["line",{x1:"2",x2:"22",y1:"2",y2:"22",key:"a6p6uj"}]]);/**
 * @license lucide-react v0.468.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const xe=A("Flag",[["path",{d:"M4 15s1-1 4-1 5 2 8 2 4-1 4-1V3s-1 1-4 1-5-2-8-2-4 1-4 1z",key:"i9b6wo"}],["line",{x1:"4",x2:"4",y1:"22",y2:"15",key:"1cm3nv"}]]);/**
 * @license lucide-react v0.468.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const Lt=A("Monitor",[["rect",{width:"20",height:"14",x:"2",y:"3",rx:"2",key:"48i651"}],["line",{x1:"8",x2:"16",y1:"21",y2:"21",key:"1svkeh"}],["line",{x1:"12",x2:"12",y1:"17",y2:"21",key:"vw1qmm"}]]);/**
 * @license lucide-react v0.468.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const Be=A("Send",[["path",{d:"M14.536 21.686a.5.5 0 0 0 .937-.024l6.5-19a.496.496 0 0 0-.635-.635l-19 6.5a.5.5 0 0 0-.024.937l7.93 3.18a2 2 0 0 1 1.112 1.11z",key:"1ffxy3"}],["path",{d:"m21.854 2.147-10.94 10.939",key:"12cjpa"}]]);/**
 * @license lucide-react v0.468.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const Ot=A("StickyNote",[["path",{d:"M16 3H5a2 2 0 0 0-2 2v14a2 2 0 0 0 2 2h14a2 2 0 0 0 2-2V8Z",key:"qazsjp"}],["path",{d:"M15 3v4a2 2 0 0 0 2 2h4",key:"40519r"}]]);/**
 * @license lucide-react v0.468.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const Qe=A("WifiOff",[["path",{d:"M12 20h.01",key:"zekei9"}],["path",{d:"M8.5 16.429a5 5 0 0 1 7 0",key:"1bycff"}],["path",{d:"M5 12.859a10 10 0 0 1 5.17-2.69",key:"1dl1wf"}],["path",{d:"M19 12.859a10 10 0 0 0-2.007-1.523",key:"4k23kn"}],["path",{d:"M2 8.82a15 15 0 0 1 4.177-2.643",key:"1grhjp"}],["path",{d:"M22 8.82a15 15 0 0 0-11.288-3.764",key:"z3jwby"}],["path",{d:"m2 2 20 20",key:"1ooewy"}]]);/**
 * @license lucide-react v0.468.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const qt=A("Wifi",[["path",{d:"M12 20h.01",key:"zekei9"}],["path",{d:"M2 8.82a15 15 0 0 1 20 0",key:"dnpr2z"}],["path",{d:"M5 12.859a10 10 0 0 1 14 0",key:"1x1e6c"}],["path",{d:"M8.5 16.429a5 5 0 0 1 7 0",key:"1bycff"}]]),Vt=["teamviewer","anydesk","ultraviewer","parsec","vnc","remotedesktop","citrix","logmein","splashtop","chrome remote","microsoft remote","rdp","ammyy","supremo"],ge=typeof navigator<"u"&&/^((?!chrome|android).)*safari/i.test(navigator.userAgent),Ze=["demo","1"],Xe=["demo-session","demo-session-id"],Pt=3e4,Ye="SUBMIT_TIMEOUT";function Bt(){const{id:x}=St(),{user:b,profile:$t}=Et(),{t:r}=Ct(),j=c.useRef(null),R=c.useRef(null),Y=c.useRef(null),Je=c.useRef(null),z=c.useRef(!1),C=Mt(),[g,pe]=c.useState(null),[_,ye]=c.useState([]),[M,et]=c.useState(0),[N,we]=c.useState({}),[k,be]=c.useState(new Set),[F,ve]=c.useState({}),[f,H]=c.useState(null),[J,G]=c.useState(null),[tt,st]=c.useState(!1),[nt,je]=c.useState(null),[Ne,_e]=c.useState(0),[ke,rt]=c.useState(0),[Se,at]=c.useState(0),[Ee,it]=c.useState(0),[ee,V]=c.useState(!1),[P,te]=c.useState("verify"),[se,Ce]=c.useState(null),[zt,ct]=c.useState(0),[K,B]=c.useState(null),[Q,Me]=c.useState(!navigator.onLine),[ot,ne]=c.useState(!1),[Fe,re]=c.useState(!1),[De,lt]=c.useState(!1),[p,Ae]=c.useState(!1),[T,Re]=c.useState(!1),[S,I]=c.useState("loading"),[Te,dt]=c.useState(!1),[ae,mt]=c.useState(!0),y=_[M],ut=c.useCallback(()=>{const t=navigator.userAgent.toLowerCase();for(const a of Vt)if(t.includes(a))return!0;const s=window.screen.width/window.screen.height,n=window.innerWidth/window.innerHeight;Math.abs(s-n)>.2&&console.warn("Suspicious screen ratio detected");try{const a=document.createElement("canvas"),i=a.getContext("webgl")||a.getContext("experimental-webgl");if(i){const d=i.getExtension("WEBGL_debug_renderer_info");if(d){const l=i.getParameter(d.UNMASKED_RENDERER_WEBGL).toLowerCase(),v=["vmware","virtualbox","parallels","hyper-v","swiftshader","llvmpipe"];for(const u of v)if(l.includes(u))return console.warn("Virtual machine renderer detected:",l),!0}}}catch(a){console.warn("WebGL check failed:",a)}return!1},[]),ht=c.useCallback(async()=>{try{if("isExtended"in window.screen&&window.screen.isExtended)return re(!0),o.error("PH√ÅT HI·ªÜN 2 M√ÄN H√åNH! Vui l√≤ng ng·∫Øt k·∫øt n·ªëi m√†n h√¨nh ph·ª• ƒë·ªÉ thi.",{autoClose:!1}),!1;if("getScreenDetails"in window)try{const t=await window.getScreenDetails();if(t&&t.screens.length>1)return re(!0),o.error(`PH√ÅT HI·ªÜN ${t.screens.length} M√ÄN H√åNH! Nghi v·∫•n gian l·∫≠n.`,{autoClose:!1}),!1}catch{console.warn("Screen details permission denied")}}catch(t){console.warn("Screen API not supported",t)}return re(!1),!0},[]),Ie=async()=>{try{const t=document.documentElement;t.requestFullscreen?await t.requestFullscreen():t.webkitRequestFullscreen?await t.webkitRequestFullscreen():t.mozRequestFullScreen?await t.mozRequestFullScreen():t.msRequestFullscreen&&await t.msRequestFullscreen(),ne(!0)}catch{ge?(console.warn("Safari fullscreen not fully supported, continuing without fullscreen requirement"),ne(!0)):o.error(r("anticheat.fullscreenRequired"))}};c.useEffect(()=>{const t=()=>{const s=!!(document.fullscreenElement||document.webkitFullscreenElement||document.mozFullScreenElement||document.msFullscreenElement);if(ne(s),ge){console.log("Safari fullscreen state change - skipping violation check");return}!s&&p&&!z.current&&at(n=>{const a=n+1;return o.error(m("anticheat.fullscreenExit",{count:a})),L("fullscreen_exit",{count:a}),a})};return document.addEventListener("fullscreenchange",t),document.addEventListener("webkitfullscreenchange",t),document.addEventListener("mozfullscreenchange",t),document.addEventListener("MSFullscreenChange",t),()=>{document.removeEventListener("fullscreenchange",t),document.removeEventListener("webkitfullscreenchange",t),document.removeEventListener("mozfullscreenchange",t),document.removeEventListener("MSFullscreenChange",t)}},[p]),c.useEffect(()=>{const t=()=>{document.hidden&&p&&!z.current&&rt(s=>{const n=s+1;return o.warning(m("anticheat.tabSwitch",{count:n})),L("tab_switch",{count:n}),n})};return document.addEventListener("visibilitychange",t),()=>document.removeEventListener("visibilitychange",t)},[p]),c.useEffect(()=>{if(!p)return;const t=n=>{var i;const a=[{ctrl:!0,key:"c"},{ctrl:!0,key:"v"},{ctrl:!0,key:"p"},{ctrl:!0,key:"s"},{ctrl:!0,key:"f"},{ctrl:!0,shift:!0,key:"i"},{key:"F12"},{alt:!0,key:"Tab"},{key:"PrintScreen"}];for(const d of a)if((!d.ctrl||n.ctrlKey)&&(!d.shift||n.shiftKey)&&(!d.alt||n.altKey)&&(n.key.toLowerCase()===((i=d.key)==null?void 0:i.toLowerCase())||n.key===d.key)&&d.key){n.preventDefault(),o.warning("Ph√≠m t·∫Øt b·ªã v√¥ hi·ªáu h√≥a trong ph√≤ng thi!"),L("keyboard_shortcut",{key:n.key,ctrl:n.ctrlKey,alt:n.altKey,shift:n.shiftKey});return}},s=n=>{n.preventDefault(),o.warning("Click chu·ªôt ph·∫£i b·ªã v√¥ hi·ªáu h√≥a!"),L("right_click",{})};return document.addEventListener("keydown",t),document.addEventListener("contextmenu",s),()=>{document.removeEventListener("keydown",t),document.removeEventListener("contextmenu",s)}},[p]);const D=c.useRef(null),ie=c.useRef(null),U=c.useRef(null),W=c.useRef(null),ce=t=>{D.current=t,j.current&&(j.current.srcObject=t),U.current||(U.current=document.createElement("canvas"),U.current.width=640,U.current.height=480,W.current=U.current.getContext("2d",{willReadFrequently:!0}))},ft=async()=>{I("loading");try{D.current&&D.current.getTracks().forEach(n=>n.stop());const t={video:{width:{ideal:640,min:320},height:{ideal:480,min:240},facingMode:"user"},audio:!1},s=await navigator.mediaDevices.getUserMedia(t);ce(s),I("ready"),o.success(r("proctoring.camera")+" OK")}catch(t){console.error("Camera retry error:",t),I("error"),o.error(r("anticheat.cameraAccess"))}};c.useEffect(()=>((async()=>{I("loading");try{const s={video:{width:{ideal:640,min:320},height:{ideal:480,min:240},facingMode:"user"},audio:!1},n=await navigator.mediaDevices.getUserMedia(s);ce(n),I("ready")}catch(s){if(console.error("Camera access error:",s),I("error"),s.name==="NotAllowedError"||s.name==="PermissionDeniedError")o.error(r("anticheat.cameraAccess")+" (Permission denied)");else if(s.name==="NotFoundError"||s.name==="DevicesNotFoundError")o.error(r("anticheat.cameraAccess")+" (No camera found)");else if(s.name==="NotReadableError"||s.name==="TrackStartError")o.error(r("anticheat.cameraAccess")+" (Camera in use by another app)");else if(s.name==="OverconstrainedError")try{const n=await navigator.mediaDevices.getUserMedia({video:!0});ce(n),I("ready")}catch(n){console.error("Camera fallback failed:",n),o.error(r("anticheat.cameraAccess"))}else o.error(r("anticheat.cameraAccess"))}})(),()=>{D.current&&D.current.getTracks().forEach(s=>s.stop())}),[]),c.useEffect(()=>{D.current&&j.current&&j.current.srcObject!==D.current&&(j.current.srcObject=D.current,j.current.play().catch(t=>{console.warn("Video play failed:",t)}))},[p]),c.useEffect(()=>{const t=()=>{Me(!1),o.success(m("anticheat.networkOnline"))},s=()=>{Me(!0),o.error(m("anticheat.networkOffline"))};window.addEventListener("online",t),window.addEventListener("offline",s);const n=a=>{const{code:i,payload:d,detectedClass:l,confidence:v,count:u}=a,h={phone:m("anticheat.phoneDetected"),material:m("anticheat.materialDetected"),headphones:m("anticheat.headphonesDetected"),person:m("anticheat.noFace")},E={lookAtScreen:m("anticheat.lookAtScreen"),NO_FACE:m("anticheat.noFace"),LOOK_RIGHT:m("anticheat.lookRight"),LOOK_LEFT:m("anticheat.lookLeft"),LOOK_DOWN:m("anticheat.lookDown"),LOOK_UP:m("anticheat.lookUp"),GAZE_LEFT:m("anticheat.gazeLeft"),GAZE_RIGHT:m("anticheat.gazeRight"),speakingDetected:m("anticheat.speakingDetected"),multiPerson:m("anticheat.multiPerson",{count:u||2}),phoneDetected:m("anticheat.phoneDetected"),materialDetected:m("anticheat.materialDetected"),headphonesDetected:m("anticheat.headphonesDetected"),monitoring:m("anticheat.monitoring"),aiLoading:m("anticheat.aiLoading"),yoloLoading:m("anticheat.yoloLoading"),basicMode:m("anticheat.basicMode"),faceOnly:m("anticheat.faceOnly"),yoloOnly:m("anticheat.yoloOnly")};return i==="detection"&&l&&h[l]?`${h[l]} (${((v||0)*100).toFixed(0)}%)`:E[i]||E[d]||d};return R.current=new Worker(new URL("/assets/ai.worker-VDgijyw7.js",import.meta.url),{type:"module"}),R.current.onmessage=a=>{const{type:i,payload:d,code:l}=a.data,v=n(a.data);i==="STATUS"?je(v):i==="ALERT"?(_e(u=>u+1),o.warning(`${m("anticheat.aiWarning")}: ${v}`),L("ai_alert",{message:d,code:l})):i==="GAZE_AWAY"&&it(u=>u+1)},R.current.onerror=a=>{console.error("AI Worker error:",a),je("AI Worker error - basic mode")},p&&S==="ready"&&j.current&&W.current&&(console.log("üé¨ Starting AI frame processing..."),ie.current=setInterval(()=>{if(j.current&&R.current&&W.current&&!z.current)try{if(j.current.readyState>=HTMLMediaElement.HAVE_CURRENT_DATA&&j.current.videoWidth>0){W.current.drawImage(j.current,0,0,640,480);const a=W.current.getImageData(0,0,640,480);a.data&&a.data.length>0&&R.current.postMessage({type:"PROCESS_FRAME",payload:a},[a.data.buffer])}}catch(a){console.warn("Error sending frame to worker:",a)}},200)),()=>{window.removeEventListener("online",t),window.removeEventListener("offline",s),ie.current&&clearInterval(ie.current),R.current&&R.current.terminate()}},[p,S]),c.useEffect(()=>{if(!(!p||J===null))return Y.current=setInterval(()=>{G(t=>t<=1?(clearInterval(Y.current),Ve(),0):(t===300&&(st(!0),o.warning("‚ö†Ô∏è C√≤n 5 ph√∫t! H√£y ki·ªÉm tra l·∫°i b√†i l√†m.")),t===60&&o.error("‚ö†Ô∏è C√≤n 1 ph√∫t!"),t-1))},1e3),()=>clearInterval(Y.current)},[p,J]),c.useEffect(()=>{const t=async()=>{var a;if(x==="demo"||x==="1"){pe({id:x,title:"Tr√≠ tu·ªá nh√¢n t·∫°o (AI) - B√ÄI THI M·∫™U",code:"INT3401",duration_minutes:45,require_camera:!0,require_fullscreen:!0}),ye([{id:"1",question_text:"Deep Learning l√† g√¨?",question_type:"multiple_choice",options:[{id:"A",text:"M·ªôt lo·∫°i m√°y h·ªçc d·ª±a tr√™n m·∫°ng n∆°-ron nh√¢n t·∫°o"},{id:"B",text:"M·ªôt ph·∫ßn m·ªÅm ch·ªânh s·ª≠a ·∫£nh"},{id:"C",text:"M·ªôt thu·∫≠t to√°n s·∫Øp x·∫øp"},{id:"D",text:"M·ªôt ng√¥n ng·ªØ l·∫≠p tr√¨nh"}],points:2},{id:"2",question_text:"M·∫°ng n∆°-ron t√≠ch ch·∫≠p (CNN) th∆∞·ªùng ƒë∆∞·ª£c s·ª≠ d·ª•ng cho lo·∫°i d·ªØ li·ªáu n√†o?",question_type:"multiple_choice",options:[{id:"A",text:"D·ªØ li·ªáu vƒÉn b·∫£n"},{id:"B",text:"D·ªØ li·ªáu √¢m thanh"},{id:"C",text:"D·ªØ li·ªáu h√¨nh ·∫£nh"},{id:"D",text:"D·ªØ li·ªáu b·∫£ng"}],points:2},{id:"3",question_text:"H√†m k√≠ch ho·∫°t ReLU c√≥ c√¥ng th·ª©c l√† g√¨?",question_type:"multiple_choice",options:[{id:"A",text:"f(x) = max(0, x)"},{id:"B",text:"f(x) = 1/(1+e^(-x))"},{id:"C",text:"f(x) = tanh(x)"},{id:"D",text:"f(x) = x^2"}],points:2},{id:"4",question_text:"Overfitting x·∫£y ra khi:",question_type:"multiple_choice",options:[{id:"A",text:"Model h·ªçc qu√° t·ªët tr√™n t·∫≠p train nh∆∞ng k√©m tr√™n t·∫≠p test"},{id:"B",text:"Model kh√¥ng h·ªçc ƒë∆∞·ª£c g√¨ t·ª´ d·ªØ li·ªáu"},{id:"C",text:"Model c√≥ qu√° √≠t tham s·ªë"},{id:"D",text:"D·ªØ li·ªáu train qu√° √≠t"}],points:2},{id:"5",question_text:"Transformer ƒë∆∞·ª£c gi·ªõi thi·ªáu trong b√†i b√°o n√†o?",question_type:"multiple_choice",options:[{id:"A",text:"Attention Is All You Need"},{id:"B",text:"ImageNet Classification with Deep CNNs"},{id:"C",text:"Playing Atari with Deep RL"},{id:"D",text:"Generative Adversarial Networks"}],points:2}]),G(2700),H("demo-session");return}try{const{data:i,error:d}=await w.from("exams").select(`
            *,
            class:classes(name, code)
          `).eq("id",x).single();if(d){console.error("Failed to load exam:",d),o.error(r("error.loadExam")),C("/");return}const l=new Date,v=new Date(i.start_time),u=new Date(i.end_time);if(i.status!=="published"){o.error(r("exam.notPublished")),C("/");return}if(l<v){o.error(r("exam.notStarted")),C("/");return}if(l>u){o.error(r("exam.ended")),C("/");return}pe({id:i.id,title:i.title,code:((a=i.class)==null?void 0:a.code)||"N/A",duration_minutes:i.duration_minutes,require_camera:i.require_camera,require_fullscreen:i.require_fullscreen,max_tab_violations:i.max_tab_violations,max_fullscreen_violations:i.max_fullscreen_violations});const{data:h,error:E}=await w.from("questions").select("id, question_text, question_type, options, points, order_index").eq("exam_id",x).order("order_index");if(E){console.error("Failed to load questions:",E),o.error(r("error.loadQuestions")),C("/");return}const Z=i.is_shuffled?s(h):h;ye(Z),G(i.duration_minutes*60);const{data:$}=await w.from("exam_sessions").select("id, status, started_at").eq("exam_id",x).eq("student_id",b==null?void 0:b.id).eq("status","in_progress").single();if($){H($.id);const Nt=new Date($.started_at).getTime(),_t=Date.now(),kt=Math.floor((_t-Nt)/1e3),Pe=Math.max(0,i.duration_minutes*60-kt);if(G(Pe),Pe===0){o.warning(r("exam.timeExpired")),Ae(!0),Ve();return}const{data:$e}=await w.from("answers").select("question_id, student_answer, is_flagged, student_notes").eq("session_id",$.id);if($e){const ze={},Ue=new Set,We={};$e.forEach(O=>{ze[O.question_id]=O.student_answer,O.is_flagged&&Ue.add(O.question_id),O.student_notes&&(We[O.question_id]=O.student_notes)}),we(ze),be(Ue),ve(We)}o.info(r("exam.sessionRestored"))}}catch(i){console.error("Error loading exam:",i),o.error(r("exam.loadError")),C("/")}},s=n=>{const a=[...n];for(let i=a.length-1;i>0;i--){const d=Math.floor(Math.random()*(i+1));[a[i],a[d]]=[a[d],a[i]]}return a};t()},[x,b,C]);const L=async(t,s)=>{if(f&&!(Xe.includes(f)||Ze.includes(x)))try{await w.from("proctoring_logs").insert({session_id:f,event_type:t,details:s,severity:t.includes("detected")?"critical":"warning"})}catch(n){console.warn("Failed to log proctoring event:",(n==null?void 0:n.message)||n)}};c.useEffect(()=>{(async()=>{if(b!=null&&b.id)try{const{data:s}=await w.from("profiles").select("face_embedding").eq("id",b.id).single();s!=null&&s.face_embedding&&Ce(s.face_embedding)}catch(s){console.warn("Could not load face embedding:",s)}})()},[b==null?void 0:b.id]),c.useEffect(()=>{if(!p||!f||x==="demo"||x==="1")return;const s=((g==null?void 0:g.duration_minutes)||60)*60*1e3,n=Math.floor(Math.random()*2)+2,a=[];for(let i=0;i<n;i++){const d=s*.2,l=s*.8,v=d+Math.random()*(l-d),u=setTimeout(()=>{p&&!T&&!ee&&xt()},v);a.push(u)}return Je.current=a,()=>{a.forEach(clearTimeout)}},[p,f,x,g==null?void 0:g.duration_minutes]);const xt=()=>{te("random"),V(!0),L("face_verification_triggered",{type:"random"})},Le=async t=>{if(V(!1),ct(s=>s+1),f&&f!=="demo-session-id")try{await w.rpc("log_face_verification",{p_session_id:f,p_verification_type:P,p_similarity_score:t||1,p_is_match:!0})}catch(s){console.warn("Could not log face verification:",s)}o.success(r("face.success")),K&&(K(),B(null))},Oe=async(t,s)=>{if(f&&f!=="demo-session-id")try{await w.rpc("log_face_verification",{p_session_id:f,p_verification_type:P,p_similarity_score:s||0,p_is_match:!1,p_error_reason:t})}catch(n){console.warn("Could not log face verification:",n)}L("face_verification_failed",{reason:t,similarity:s,type:P}),P==="random"&&(o.warning(r("face.mismatch")),_e(n=>n+1),V(!1))},qe=async(t,s)=>{if(Ce(t),V(!1),b!=null&&b.id)try{await w.rpc("update_face_embedding",{p_embedding:t,p_image_url:s})}catch(n){console.warn("Could not save face embedding:",n)}o.success(r("face.enrollSuccess")),K&&(K(),B(null))},gt=(t,s)=>{we(n=>({...n,[t]:s}))},pt=t=>{be(s=>{const n=new Set(s);return n.has(t)?n.delete(t):n.add(t),n})},yt=(t,s)=>{ve(n=>({...n,[t]:s}))},oe=t=>{t>=0&&t<_.length&&et(t)},wt=()=>oe(M+1),bt=()=>oe(M-1);c.useEffect(()=>{if(!p||!f||x==="demo"||x==="1")return;let s={...N},n=new Set(k),a={...F};const d=setInterval(async()=>{try{const l=_.filter(h=>{const E=N[h.id]!==s[h.id],Z=k.has(h.id)!==n.has(h.id),$=F[h.id]!==a[h.id];return E||Z||$});if(l.length===0)return;const v=l.map(h=>({session_id:f,question_id:h.id,student_answer:N[h.id]||null,is_flagged:k.has(h.id),student_notes:F[h.id]||null})),{error:u}=await w.from("answers").upsert(v,{onConflict:"session_id,question_id"});if(u)throw u;s={...N},n=new Set(k),a={...F}}catch(l){console.error("Auto-save error:",l)}},3e4);return()=>clearInterval(d)},[p,f,x,_,N,k,F]);const Ve=async()=>{o.warning(r("exam.timeUp")),await le(!0)},le=async(t=!1)=>{if(!T){if(!t){const s=_.filter(i=>!N[i.id]).length,n=k.size;let a=r("exam.submitConfirm");if(s>0&&(a+=`

‚ö†Ô∏è ${s} ${r("exam.unansweredWarning")}`),n>0&&(a+=`
‚ö†Ô∏è ${n} ${r("exam.flaggedWarning")}`),!window.confirm(a))return}Re(!0),z.current=!0;try{if(Ze.includes(x)||Xe.includes(f)){const n={1:"A",2:"C",3:"A",4:"A",5:"A"};let a=0,i=0;_.forEach(l=>{i+=l.points,N[l.id]===n[l.id]&&(a+=l.points)}),await new Promise(l=>setTimeout(l,500));const d=i>0?(a/i*100).toFixed(1):0;o.success(`${r("exam.submitSuccess")} ${r("exam.score")}: ${a}/${i} (${d}%)`)}else{const n=async()=>{const d=_.map(u=>({session_id:f,question_id:u.id,student_answer:N[u.id]||null,is_flagged:k.has(u.id),student_notes:F[u.id]||null})),{error:l}=await w.from("answers").upsert(d,{onConflict:"session_id,question_id"});if(l)throw console.error("Error saving answers:",l),new Error(r("exam.submitError"));const{error:v}=await w.from("exam_sessions").update({cheat_count:Ne,tab_violations:ke,fullscreen_violations:Se,gaze_away_count:Ee}).eq("id",f);v&&console.error("Error saving violations:",v);try{const{data:u,error:h}=await w.rpc("submit_exam",{p_session_id:f,p_auto_submit:t});if(h){console.warn("RPC submit_exam failed, using direct update:",h);const{error:E}=await w.from("exam_sessions").update({status:t?"auto_submitted":"submitted",submitted_at:new Date().toISOString()}).eq("id",f);if(E)throw E;return{success:!0,fallback:!0}}return u}catch(u){console.warn("RPC call failed, using fallback:",u);const{error:h}=await w.from("exam_sessions").update({status:t?"auto_submitted":"submitted",submitted_at:new Date().toISOString()}).eq("id",f);if(h)throw h;return{success:!0,fallback:!0}}},a=new Promise((d,l)=>setTimeout(()=>l(new Error(Ye)),Pt)),i=await Promise.race([n(),a]);if(i&&i.percentage!==void 0){const d=i.percentage||0,l=i.passed;o.success(`${r("exam.submitSuccess")} ${r("exam.score")}: ${d.toFixed(1)}% ${l?"‚úì":"‚úó"}`)}else o.success(r("exam.submitSuccess"))}try{(document.fullscreenElement||document.webkitFullscreenElement)&&(document.exitFullscreen?await document.exitFullscreen():document.webkitExitFullscreen&&await document.webkitExitFullscreen())}catch(n){console.warn("Error exiting fullscreen:",n)}C("/")}catch(s){console.error("Submit error:",s),s.message===Ye?o.error(r("error.timeout")):o.error(r("exam.submitError"))}finally{Re(!1),z.current=!1}}},vt=async()=>{if(ut()){lt(!0),o.error(r("anticheat.remoteDesktop"),{autoClose:!1});return}if(!await ht())return;if(await Ie(),!(x==="demo"||x==="1")&&(g==null?void 0:g.require_camera)!==!1)if(se){te("verify"),B(()=>de),V(!0);return}else{te("enroll"),B(()=>de),V(!0);return}await de()},de=async()=>{if(x==="demo"||x==="1")H("demo-session-id");else if(!f&&b)try{const{data:s,error:n}=await w.rpc("start_exam_session",{p_exam_id:x,p_user_agent:navigator.userAgent,p_ip_address:null});if(n){console.error("Failed to create session:",n),n.message.includes("Maximum attempts")?o.error(r("error.general")):n.message.includes("not enrolled")?o.error(r("error.permission")):o.error(r("error.general"));return}H(s)}catch(s){console.error("Session creation error:",s),o.error(r("error.general"));return}Ae(!0),o.info(r("common.success"))},jt=t=>{const s=Math.floor(t/60),n=t%60;return`${s.toString().padStart(2,"0")}:${n.toString().padStart(2,"0")}`};return p?e.jsxs("div",{className:"flex h-screen bg-background no-select",children:[e.jsx(X,{children:ee&&e.jsx(q.div,{initial:{opacity:0},animate:{opacity:1},exit:{opacity:0},className:"fixed inset-0 bg-black/70 z-[100] flex items-center justify-center p-4",children:e.jsx(He,{mode:P,storedEmbedding:se,onSuccess:Le,onFailure:Oe,onEnrollComplete:qe})})}),e.jsxs(X,{children:[Q&&e.jsx(q.div,{initial:{height:0},animate:{height:"auto"},exit:{height:0},className:"fixed top-0 left-0 right-0 bg-danger text-white text-center font-bold z-50",children:e.jsxs("div",{className:"flex items-center justify-center space-x-2 p-2",children:[e.jsx(Qe,{className:"w-5 h-5"}),e.jsx("span",{children:r("anticheat.networkOffline")})]})}),!ot&&!T&&!ge&&e.jsxs(q.div,{initial:{opacity:0},animate:{opacity:1},className:"fixed inset-0 bg-black/95 z-40 flex items-center justify-center text-white flex-col",children:[e.jsx(me,{className:"w-20 h-20 text-danger mb-4 animate-bounce"}),e.jsxs("h2",{className:"text-3xl font-bold mb-4",children:["‚ö†Ô∏è ",r("anticheat.violation")]}),e.jsx("p",{className:"mb-6 text-gray-300",children:r("anticheat.returnFullscreen")}),e.jsx("button",{onClick:Ie,className:"btn-danger px-8 py-3 text-lg",children:r("anticheat.fullscreenReturn")})]})]}),e.jsxs("div",{className:"flex-1 flex flex-col overflow-hidden",children:[e.jsxs("header",{className:"bg-paper border-b border-gray-200 px-6 py-3 flex items-center justify-between flex-shrink-0",children:[e.jsxs("div",{children:[e.jsx("h1",{className:"text-lg font-bold text-text-main",children:g==null?void 0:g.title}),e.jsxs("p",{className:"text-sm text-gray-500",children:[r("exam.code"),": ",g==null?void 0:g.code]})]}),e.jsxs("div",{className:"flex items-center space-x-4",children:[e.jsxs("div",{className:`flex items-center space-x-1 text-sm ${Q?"text-danger":"text-success"}`,children:[Q?e.jsx(Qe,{className:"w-4 h-4"}):e.jsx(qt,{className:"w-4 h-4"}),e.jsx("span",{children:Q?"Offline":"Online"})]}),e.jsxs("div",{className:`flex items-center space-x-2 px-4 py-2 rounded-lg font-mono text-lg font-bold ${tt?"bg-danger-100 text-danger animate-pulse":"bg-primary-50 text-primary"}`,children:[e.jsx(Dt,{className:"w-5 h-5"}),e.jsx("span",{children:jt(J||0)})]})]})]}),e.jsx("div",{className:"flex-1 overflow-y-auto p-6",children:y&&e.jsxs(q.div,{initial:{opacity:0,x:20},animate:{opacity:1,x:0},className:"max-w-3xl mx-auto",children:[e.jsxs("div",{className:"flex items-center justify-between mb-4",children:[e.jsxs("div",{className:"flex items-center space-x-3",children:[e.jsx("span",{className:"inline-flex items-center justify-center w-10 h-10 bg-primary text-white font-bold rounded-full",children:M+1}),e.jsxs("div",{children:[e.jsxs("span",{className:"text-sm text-gray-500",children:["C√¢u ",M+1,"/",_.length]}),e.jsxs("span",{className:"text-sm text-gray-400 ml-2",children:["(",y.points," ƒëi·ªÉm)"]})]})]}),e.jsx("button",{onClick:()=>pt(y.id),className:`flex items-center space-x-1 px-3 py-1.5 rounded-lg transition-colors ${k.has(y.id)?"bg-warning-100 text-warning-700":"bg-gray-100 text-gray-600 hover:bg-gray-200"}`,children:k.has(y.id)?e.jsxs(e.Fragment,{children:[e.jsx(xe,{className:"w-4 h-4"}),e.jsx("span",{className:"text-sm font-medium",children:"ƒê√£ g·∫Øn c·ªù"})]}):e.jsxs(e.Fragment,{children:[e.jsx(It,{className:"w-4 h-4"}),e.jsx("span",{className:"text-sm font-medium",children:"G·∫Øn c·ªù"})]})})]}),e.jsxs("div",{className:"card mb-4",children:[e.jsx("h2",{className:"text-lg font-semibold text-text-main mb-6",children:y.question_text}),e.jsx("div",{className:"space-y-3",children:y.options.map(t=>e.jsxs("label",{className:`flex items-center p-4 border-2 rounded-xl cursor-pointer transition-all ${N[y.id]===t.id?"border-primary bg-primary-50":"border-gray-200 hover:border-primary-300 hover:bg-gray-50"}`,children:[e.jsx("input",{type:"radio",name:`question-${y.id}`,value:t.id,checked:N[y.id]===t.id,onChange:()=>gt(y.id,t.id),className:"sr-only"}),e.jsx("div",{className:`w-8 h-8 rounded-full border-2 flex items-center justify-center mr-4 flex-shrink-0 ${N[y.id]===t.id?"border-primary bg-primary text-white":"border-gray-300"}`,children:e.jsx("span",{className:"font-semibold",children:t.id})}),e.jsx("span",{className:"text-gray-700",children:t.text})]},t.id))})]}),e.jsxs("div",{className:"card",children:[e.jsxs("button",{onClick:()=>dt(!Te),className:"flex items-center space-x-2 text-gray-600 hover:text-primary transition-colors",children:[e.jsx(Ot,{className:"w-5 h-5"}),e.jsx("span",{className:"font-medium",children:"Ghi ch√∫ nh√°p"}),F[y.id]&&e.jsx("span",{className:"w-2 h-2 bg-primary rounded-full"})]}),e.jsx(X,{children:Te&&e.jsx(q.div,{initial:{height:0,opacity:0},animate:{height:"auto",opacity:1},exit:{height:0,opacity:0},className:"overflow-hidden",children:e.jsx("textarea",{placeholder:"Ghi ch√∫ c√° nh√¢n cho c√¢u h·ªèi n√†y... (ch·ªâ b·∫°n th·∫•y)",value:F[y.id]||"",onChange:t=>yt(y.id,t.target.value),className:"w-full mt-3 p-3 border border-gray-200 rounded-lg resize-none focus:outline-none focus:ring-2 focus:ring-primary-500",rows:3})})})]}),e.jsxs("div",{className:"flex items-center justify-between mt-6",children:[e.jsxs("button",{onClick:bt,disabled:M===0,className:"btn-secondary disabled:opacity-50 disabled:cursor-not-allowed",children:[e.jsx(Tt,{className:"w-5 h-5 mr-1"}),r("common.previous")]}),M===_.length-1?e.jsxs("button",{onClick:()=>le(!1),disabled:T,className:"btn-success",children:[T?e.jsx(fe,{className:"w-5 h-5 mr-2 animate-spin"}):e.jsx(Be,{className:"w-5 h-5 mr-2"}),r("common.submit")]}):e.jsxs("button",{onClick:wt,className:"btn-primary",children:[r("common.next"),e.jsx(Ft,{className:"w-5 h-5 ml-1"})]})]})]},y.id)})]}),e.jsxs("div",{className:"w-80 bg-paper border-l border-gray-200 flex flex-col flex-shrink-0",children:[e.jsxs("div",{className:"p-4 border-b border-gray-200",children:[e.jsxs("div",{className:"flex items-center justify-between mb-2",children:[e.jsxs("h3",{className:"font-bold text-gray-700 flex items-center space-x-2",children:[e.jsx(he,{className:"w-4 h-4"}),e.jsx("span",{children:r("proctoring.camera")})]}),e.jsxs("div",{className:"flex items-center space-x-1",children:[e.jsx("div",{className:"w-2 h-2 bg-danger rounded-full animate-pulse"}),e.jsx("span",{className:"text-xs text-danger font-bold",children:r("proctoring.recording")})]})]}),e.jsx("div",{className:"relative bg-gray-900 rounded-lg overflow-hidden aspect-video",children:e.jsx("video",{ref:j,autoPlay:!0,playsInline:!0,muted:!0,className:"w-full h-full object-cover"})}),e.jsx("p",{className:"text-xs mt-2 text-gray-500 text-center",children:nt||r("common.loading")})]}),e.jsxs("div",{className:"p-4 border-b border-gray-200 space-y-2",children:[e.jsxs("div",{className:"flex items-center justify-between p-2 bg-danger-50 rounded-lg",children:[e.jsx("span",{className:"text-xs text-gray-600",children:r("proctoring.aiDetection")}),e.jsx("span",{className:"font-bold text-danger",children:Ne})]}),e.jsxs("div",{className:"flex items-center justify-between p-2 bg-warning-50 rounded-lg",children:[e.jsx("span",{className:"text-xs text-gray-600",children:r("proctoring.tabViolations")}),e.jsx("span",{className:"font-bold text-warning",children:ke})]}),e.jsxs("div",{className:"flex items-center justify-between p-2 bg-warning-50 rounded-lg",children:[e.jsx("span",{className:"text-xs text-gray-600",children:r("proctoring.fullscreenViolations")}),e.jsx("span",{className:"font-bold text-warning",children:Se})]}),e.jsxs("div",{className:"flex items-center justify-between p-2 bg-gray-50 rounded-lg",children:[e.jsx("span",{className:"text-xs text-gray-600",children:r("proctoring.gazeAway")}),e.jsx("span",{className:"font-bold text-gray-600",children:Ee})]})]}),e.jsxs("div",{className:"flex-1 overflow-y-auto p-4",children:[e.jsxs("div",{className:"flex items-center justify-between mb-3",children:[e.jsx("h3",{className:"font-bold text-gray-700",children:r("proctoring.questionList")}),e.jsx("button",{onClick:()=>mt(!ae),className:"text-gray-400 hover:text-gray-600",children:ae?e.jsx(At,{className:"w-4 h-4"}):e.jsx(Rt,{className:"w-4 h-4"})})]}),ae&&e.jsx("div",{className:"grid grid-cols-5 gap-2",children:_.map((t,s)=>{const n=!!N[t.id],a=k.has(t.id),i=s===M;return e.jsxs("button",{onClick:()=>oe(s),className:`relative w-10 h-10 rounded-lg font-medium text-sm transition-all ${i?"bg-primary text-white ring-2 ring-primary ring-offset-2":n?"bg-success-100 text-success-700 hover:bg-success-200":"bg-gray-100 text-gray-600 hover:bg-gray-200"}`,children:[s+1,a&&e.jsx(xe,{className:"absolute -top-1 -right-1 w-3 h-3 text-warning fill-warning"})]},t.id)})}),e.jsxs("div",{className:"mt-4 space-y-1 text-xs text-gray-500",children:[e.jsxs("div",{className:"flex items-center space-x-2",children:[e.jsx("div",{className:"w-4 h-4 bg-success-100 rounded"}),e.jsx("span",{children:r("proctoring.answered")})]}),e.jsxs("div",{className:"flex items-center space-x-2",children:[e.jsx("div",{className:"w-4 h-4 bg-gray-100 rounded"}),e.jsx("span",{children:r("proctoring.unanswered")})]}),e.jsxs("div",{className:"flex items-center space-x-2",children:[e.jsx(xe,{className:"w-4 h-4 text-warning fill-warning"}),e.jsx("span",{children:r("proctoring.flagged")})]})]})]}),e.jsx("div",{className:"p-4 border-t border-gray-200",children:e.jsxs("button",{onClick:()=>le(!1),disabled:T,className:"btn-success w-full py-3",children:[T?e.jsx(fe,{className:"w-5 h-5 mr-2 animate-spin"}):e.jsx(Be,{className:"w-5 h-5 mr-2"}),r("common.submit")," (",Object.keys(N).length,"/",_.length,")"]})})]})]}):e.jsxs("div",{className:"flex flex-col items-center justify-center min-h-screen bg-gradient-to-br from-primary-50 to-background p-4",children:[e.jsxs(q.div,{initial:{opacity:0,y:20},animate:{opacity:1,y:0},className:"bg-paper p-8 rounded-2xl shadow-soft max-w-lg w-full",children:[e.jsxs("div",{className:"text-center mb-6",children:[e.jsx("div",{className:"inline-flex items-center justify-center w-16 h-16 bg-primary-100 rounded-full mb-4",children:e.jsx(Ge,{className:"w-8 h-8 text-primary"})}),e.jsx("h2",{className:"text-2xl font-bold text-text-main",children:r("exam.rules.title")}),e.jsx("p",{className:"text-gray-500 mt-1",children:(g==null?void 0:g.title)||r("common.loading")})]}),e.jsxs("div",{className:"space-y-3 mb-6",children:[e.jsxs("div",{className:"flex items-start space-x-3 p-3 bg-success-50 rounded-lg",children:[e.jsx(Ke,{className:"w-5 h-5 text-success mt-0.5 flex-shrink-0"}),e.jsx("span",{className:"text-sm text-gray-700",children:r("exam.rules.camera")})]}),e.jsxs("div",{className:"flex items-start space-x-3 p-3 bg-success-50 rounded-lg",children:[e.jsx(Ke,{className:"w-5 h-5 text-success mt-0.5 flex-shrink-0"}),e.jsx("span",{className:"text-sm text-gray-700",children:r("exam.rules.fullscreen")})]}),e.jsxs("div",{className:"flex items-start space-x-3 p-3 bg-danger-50 rounded-lg",children:[e.jsx(ue,{className:"w-5 h-5 text-danger mt-0.5 flex-shrink-0"}),e.jsx("span",{className:"text-sm text-gray-700",children:r("exam.rules.noMultiScreen")})]}),e.jsxs("div",{className:"flex items-start space-x-3 p-3 bg-danger-50 rounded-lg",children:[e.jsx(ue,{className:"w-5 h-5 text-danger mt-0.5 flex-shrink-0"}),e.jsx("span",{className:"text-sm text-gray-700",children:r("exam.rules.noTabSwitch")})]}),e.jsxs("div",{className:"flex items-start space-x-3 p-3 bg-danger-50 rounded-lg",children:[e.jsx(ue,{className:"w-5 h-5 text-danger mt-0.5 flex-shrink-0"}),e.jsx("span",{className:"text-sm text-gray-700",children:r("exam.rules.noRemoteDesktop")})]})]}),Fe&&e.jsxs("div",{className:"p-4 bg-danger-100 border border-danger-200 rounded-lg mb-4 flex items-center space-x-3",children:[e.jsx(Lt,{className:"w-6 h-6 text-danger"}),e.jsx("span",{className:"text-sm font-bold text-danger",children:r("anticheat.multiScreen")})]}),De&&e.jsxs("div",{className:"p-4 bg-danger-100 border border-danger-200 rounded-lg mb-4 flex items-center space-x-3",children:[e.jsx(me,{className:"w-6 h-6 text-danger"}),e.jsx("span",{className:"text-sm font-bold text-danger",children:r("anticheat.remoteDesktop")})]}),e.jsxs("div",{className:"mb-6",children:[e.jsx("p",{className:"text-sm font-medium text-gray-700 mb-2",children:r("exam.rules.cameraCheck")}),e.jsxs("div",{className:"relative bg-gray-900 rounded-lg overflow-hidden aspect-video",children:[S==="loading"&&e.jsxs("div",{className:"absolute inset-0 flex items-center justify-center flex-col",children:[e.jsx(fe,{className:"w-8 h-8 text-white animate-spin mb-2"}),e.jsx("p",{className:"text-white text-sm",children:r("common.loading")})]}),S==="error"&&e.jsxs("div",{className:"absolute inset-0 flex items-center justify-center flex-col p-4",children:[e.jsx(me,{className:"w-12 h-12 text-danger mb-2"}),e.jsx("p",{className:"text-white text-sm text-center mb-3",children:r("anticheat.cameraAccess")}),e.jsxs("button",{onClick:ft,className:"flex items-center space-x-2 bg-primary hover:bg-primary-700 text-white px-4 py-2 rounded-lg text-sm font-medium transition-colors",children:[e.jsx(he,{className:"w-4 h-4"}),e.jsx("span",{children:r("face.retake")})]})]}),e.jsx("video",{ref:j,autoPlay:!0,playsInline:!0,muted:!0,className:"w-full h-full object-cover"}),e.jsxs("div",{className:"absolute bottom-2 left-2 flex items-center space-x-1 bg-black/50 text-white text-xs px-2 py-1 rounded",children:[e.jsx(he,{className:"w-3 h-3"}),e.jsx("span",{children:r("proctoring.camera")}),S==="ready"&&e.jsx("span",{className:"w-2 h-2 rounded-full bg-green-500 ml-1 animate-pulse"}),S==="error"&&e.jsx("span",{className:"w-2 h-2 rounded-full bg-red-500 ml-1"})]})]}),S==="error"&&e.jsxs("p",{className:"text-xs text-danger mt-2 text-center",children:[r("anticheat.cameraAccess")," - ",r("exam.rules.camera")]})]}),e.jsxs("button",{onClick:vt,disabled:Fe||De||S!=="ready",className:"btn-primary w-full py-3 text-lg disabled:opacity-50 disabled:cursor-not-allowed",children:[e.jsx(Ge,{className:"w-5 h-5 mr-2"}),r("exam.rules.agree")]}),S!=="ready"&&e.jsxs("p",{className:"text-xs text-center text-gray-500 mt-2",children:[r("exam.rules.cameraCheck")," ",S==="loading"?"...":""]})]}),e.jsx(X,{children:ee&&e.jsx(q.div,{initial:{opacity:0},animate:{opacity:1},exit:{opacity:0},className:"fixed inset-0 bg-black/70 z-50 flex items-center justify-center p-4",children:e.jsx(He,{mode:P,storedEmbedding:se,onSuccess:Le,onFailure:Oe,onEnrollComplete:qe})})})]})}export{Bt as default};
